<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>ç®€é™‹Androidæ’ä»¶åŒ–æ–¹æ¡ˆ</title>
    <url>/ekibook/2020/03/25/apkplugin/</url>
    <content><![CDATA[<html><head></head><body><p>ç”±äºä¸€äº›ä¸å¯æè¿°çš„åŸå› ï¼Œéœ€è¦æŠŠéƒ¨åˆ†åŠŸèƒ½ä»appé‡Œç‹¬ç«‹å‡ºæ¥ï¼Œä½œä¸ºä¸¤ä¸ªç‹¬ç«‹çš„apkåº”ç”¨ã€‚ä¸¤ä¸ªç‹¬ç«‹çš„apkè¿›è¡Œäº¤äº’éå¸¸éº»çƒ¦ã€‚è¿™é‡Œè®°å½•ä¸€ä¸‹è‡ªå·±æ‘¸ç´¢çš„ä¸€ä¸ªç®€é™‹ä½†å¯è¡Œçš„å®ç°æ–¹æ³•ã€‚</p>
<a id="more"></a>

<h4 id="æ’ä»¶ä»£ç çš„åŠ è½½"><a href="#æ’ä»¶ä»£ç çš„åŠ è½½" class="headerlink" title="æ’ä»¶ä»£ç çš„åŠ è½½"></a>æ’ä»¶ä»£ç çš„åŠ è½½</h4><p>é¦–å…ˆï¼Œä¸ºäº†é¿å…è·¨è¿›ç¨‹é€šä¿¡ï¼Œæ‰€æœ‰ä»£ç éƒ½ç”±å®¿ä¸»è¿›ç¨‹ç»Ÿä¸€åŠ è½½ã€‚</p>
<p>é¦–å…ˆåœ¨æ’ä»¶åº”ç”¨ç•™ä¸€ä¸ªå•ä¾‹çš„ç±»ï¼Œåœ¨<code>Application</code>é‡Œå®ä¾‹åŒ–è¿™ä¸ªç±»ï¼Œå½“ä½œæ’ä»¶å®ä¾‹ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">createPluginInstance</span><span class="params">(context: <span class="type">Context</span>)</span></span>: Pair&lt;Context, Any&gt;? {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">val</span> pluginContext = context.createPackageContext(</span><br><span class="line">            <span class="string">"soko.ekibun.bangumi.plugins"</span>,</span><br><span class="line">            Context.CONTEXT_IGNORE_SECURITY or Context.CONTEXT_INCLUDE_CODE</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">val</span> pluginClass = pluginContext.classLoader.loadClass(<span class="string">"soko.ekibun.bangumi.plugins.Plugin"</span>)</span><br><span class="line">        pluginContext to pluginClass.getDeclaredConstructor().let {</span><br><span class="line">            it.isAccessible = <span class="literal">true</span></span><br><span class="line">            it.newInstance()</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (e: Exception) {</span><br><span class="line">        e.printStackTrace()</span><br><span class="line">        <span class="literal">null</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ç„¶ååœ¨<code>Activity.onCreate</code>é‡Œç”¨åå°„è°ƒç”¨æ’ä»¶çš„<code>setupPlugins</code>å‡½æ•°ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setUpPlugins</span><span class="params">(activity: <span class="type">Activity</span>)</span></span>: <span class="built_in">Boolean</span> {</span><br><span class="line">    <span class="keyword">val</span> pluginInstance = App.<span class="keyword">get</span>(activity).pluginInstance ?: <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">val</span> method =</span><br><span class="line">            pluginInstance.second.javaClass.getMethod(<span class="string">"setUpPlugins"</span>, Activity::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>, <span class="type">Context::class.java)</span></span></span><br><span class="line">        method.invoke(pluginInstance.second, activity, pluginInstance.first)</span><br><span class="line">        <span class="literal">true</span></span><br><span class="line">    } <span class="keyword">catch</span> (e: Exception) {</span><br><span class="line">        e.printStackTrace()</span><br><span class="line">        <span class="literal">false</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æ’ä»¶å°±èƒ½è·å¾—å½“å‰çš„<code>Activity</code>å’Œ<code>Context</code>å®ä¾‹ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Keep</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setUpPlugins</span><span class="params">(activity: <span class="type">Activity</span>, context: <span class="type">Context</span>)</span></span> {</span><br><span class="line">    App.<span class="keyword">init</span>(activity.application, context)</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        pluginList[activity.javaClass.name]?.setUpPlugins(WeakReference(activity))</span><br><span class="line">    } <span class="keyword">catch</span> (e: Exception) {</span><br><span class="line">        Log.e(<span class="string">"plugin"</span>, Log.getStackTraceString(e))</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è¿™é‡Œæ ¹æ®ä¸åŒçš„<code>Activity</code>çš„åç§°ï¼ŒåŠ è½½å¯¹åº”çš„ç±»å»å¤„ç†ã€‚ä»¿ç…§<code>Application</code>æ¨¡å¼ï¼Œåœ¨<code>App.init</code>é‡Œåˆ›å»ºä¸€ä¸ªå…¨å±€çš„<code>App</code>å®ä¾‹ï¼Œç”¨æ¥ä¿å­˜å®¿ä¸»å’Œè‡ªå·±çš„ä¸Šä¸‹æ–‡ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span></span>(<span class="keyword">val</span> host: Context, <span class="keyword">val</span> plugin: Context) {</span><br><span class="line">    <span class="keyword">val</span> handler = android.os.Handler { <span class="literal">true</span> }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> {</span><br><span class="line">        <span class="keyword">val</span> inited <span class="keyword">get</span>() = ::app.isInitialized</span><br><span class="line"></span><br><span class="line">        <span class="keyword">lateinit</span> <span class="keyword">var</span> app: App</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">init</span><span class="params">(host: <span class="type">Context</span>, plugin: <span class="type">Context</span>)</span></span> {</span><br><span class="line">            <span class="keyword">if</span> (!inited) app = App(host, plugin)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>åˆ°è¿™é‡Œï¼Œå°±å·²ç»èƒ½è¿è¡Œæ’ä»¶çš„ä»£ç äº†ï¼Œæ¥ä¸‹æ¥æ˜¯ä¸€äº›å‘å’Œè§£å†³çš„åŠæ³•ã€‚</p>
<h4 id="åŠ è½½æ’ä»¶çš„å¸ƒå±€å’Œæ ·å¼"><a href="#åŠ è½½æ’ä»¶çš„å¸ƒå±€å’Œæ ·å¼" class="headerlink" title="åŠ è½½æ’ä»¶çš„å¸ƒå±€å’Œæ ·å¼"></a>åŠ è½½æ’ä»¶çš„å¸ƒå±€å’Œæ ·å¼</h4><p>ç”±<code>createPackageContext</code>åˆ›å»ºçš„ä¸Šä¸‹æ–‡æ˜¯æ²¡æœ‰æ ·å¼çš„ï¼Œéœ€è¦æ ¹æ®<code>Activity</code>çš„<code>Configuration</code>å»åˆ›å»ºï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">createThemeContext</span><span class="params">(activityRef: <span class="type">WeakReference</span>&lt;<span class="type">Activity</span>&gt;)</span></span>: Context {</span><br><span class="line">    <span class="keyword">val</span> themeContext = <span class="keyword">object</span> : ContextThemeWrapper(app.plugin, R.style.AppTheme) {</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getApplicationContext</span><span class="params">()</span></span>: Context {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getSystemService</span><span class="params">(name: <span class="type">String</span>)</span></span>: Any? {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">when</span> (name) {</span><br><span class="line">                Context.WINDOW_SERVICE -&gt; activityRef.<span class="keyword">get</span>()?.getSystemService(name)</span><br><span class="line">                <span class="keyword">else</span> -&gt; <span class="keyword">super</span>.getSystemService(name)</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    activityRef.<span class="keyword">get</span>()?.let { themeContext.applyOverrideConfiguration(it.resources.configuration) }</span><br><span class="line">    <span class="keyword">return</span> themeContext</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="è°ƒç”¨å®¿ä¸»çš„å‡½æ•°"><a href="#è°ƒç”¨å®¿ä¸»çš„å‡½æ•°" class="headerlink" title="è°ƒç”¨å®¿ä¸»çš„å‡½æ•°"></a>è°ƒç”¨å®¿ä¸»çš„å‡½æ•°</h4><p>å’Œå®¿ä¸»åŠ è½½æ’ä»¶ä¸€æ ·ï¼Œå¯ä»¥ç”¨åå°„æ¥è°ƒç”¨å®¿ä¸»çš„å‡½æ•°ã€‚ç›´æ¥ä½¿ç”¨åå°„æœ‰ç‚¹éº»çƒ¦ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªå¯¹åº”ç±»ç›¸åŒçš„æ¥å£ï¼Œé€šè¿‡<code>Proxy.newProxyInstance</code>è¿›è¡Œè°ƒç”¨ï¼Œå…ˆå†™ä¸ªWrapperï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getLoaderClasses</span><span class="params">(classLoader: <span class="type">ClassLoader</span>, classes: <span class="type">Array</span>&lt;<span class="type">out</span> <span class="type">Class</span>&lt;*&gt;&gt;)</span></span>: Array&lt;Class&lt;*&gt;&gt; {</span><br><span class="line">    <span class="keyword">return</span> classes.map {</span><br><span class="line">        <span class="keyword">if</span> (it.isPrimitive || it.classLoader == classLoader) it</span><br><span class="line">        <span class="keyword">else</span> classLoader.loadClass(it.name)</span><br><span class="line">    }.toTypedArray()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getMethod</span><span class="params">(clazz: <span class="type">Class</span>&lt;*&gt;, name: <span class="type">String</span>, <span class="keyword">vararg</span> params: <span class="type">Class</span>&lt;*&gt;)</span></span>: Method? {</span><br><span class="line">    <span class="keyword">val</span> loaderParams = getLoaderClasses(clazz.classLoader!!, params)</span><br><span class="line">    <span class="keyword">var</span> type = clazz</span><br><span class="line">    <span class="keyword">var</span> ret: Method? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">do</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            ret = type.getDeclaredMethod(name, *loaderParams)</span><br><span class="line">        } <span class="keyword">catch</span> (e: NoSuchMethodException) {}</span><br><span class="line">        <span class="keyword">if</span> (ret != <span class="literal">null</span>) <span class="keyword">break</span></span><br><span class="line">        type = type.superclass ?: <span class="keyword">break</span></span><br><span class="line">    } <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    ret?.isAccessible = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Suppress(<span class="meta-string">"UNCHECKED_CAST"</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">proxyObject</span><span class="params">(obj: <span class="type">Any</span>?, clazz: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;)</span></span>: T? {</span><br><span class="line">    <span class="keyword">if</span> (clazz.classLoader == <span class="literal">null</span> || obj == <span class="literal">null</span> || obj.javaClass == clazz || !clazz.isInterface)</span><br><span class="line">        <span class="keyword">return</span> obj <span class="keyword">as</span>? T</span><br><span class="line">    <span class="keyword">return</span> Proxy.newProxyInstance(</span><br><span class="line">        clazz.classLoader, arrayOf(clazz)</span><br><span class="line">    ) { _, method, args -&gt;</span><br><span class="line">        getMethod(obj.javaClass, method.name, *method.parameterTypes)?.let {</span><br><span class="line">            it.invoke(obj, *(args ?: arrayOf()).mapIndexed { i, v -&gt;</span><br><span class="line">                proxyObject(v, it.parameterTypes[i])</span><br><span class="line">            }.toTypedArray())</span><br><span class="line">        }?.let { proxyObject(it, method.returnType) }</span><br><span class="line">    } <span class="keyword">as</span>? T</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ä¾‹å¦‚ï¼Œè‹¥å®¿ä¸»çš„<code>Application</code>åŒ…å«<code>remoteAction</code>å˜é‡ï¼Œå®šä¹‰å¦‚ä¸‹æ¥å£ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IApplication</span> </span>{</span><br><span class="line">    <span class="keyword">var</span> remoteAction: (intent: Intent?, flags: <span class="built_in">Int</span>, startId: <span class="built_in">Int</span>) -&gt; <span class="built_in">Unit</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è°ƒç”¨<code>proxyObject(host, IApplication::class.java)</code>ï¼Œå°±èƒ½åƒå®¿ä¸»ä¸€æ ·è®¿é—®å˜é‡äº†ã€‚</p>
<h4 id="å¯åŠ¨æœåŠ¡"><a href="#å¯åŠ¨æœåŠ¡" class="headerlink" title="å¯åŠ¨æœåŠ¡"></a>å¯åŠ¨æœåŠ¡</h4><p>æœåŠ¡å¿…é¡»è¦å£°æ˜åœ¨<code>AndroidManifest.xml</code>é‡Œï¼Œç”¨äº†ä¸ªç¬¨æ–¹æ³•ï¼Œå…ˆå£°æ˜ï¼š</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">".RemoteService"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:exported</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>æœåŠ¡é‡Œå§<code>onStartCommand</code>æŒ‡å‘<code>Application.remoteAction</code>ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RemoteService</span> : <span class="type">Service</span></span>() {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBind</span><span class="params">(intent: <span class="type">Intent</span>)</span></span>: IBinder? {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStartCommand</span><span class="params">(intent: <span class="type">Intent</span>?, flags: <span class="type">Int</span>, startId: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> {</span><br><span class="line">        (application <span class="keyword">as</span> App).remoteAction(intent, flags, startId)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ä¿®æ”¹<code>remoteAction</code>å˜é‡ï¼Œå†å¯åŠ¨<code>RemoteService</code>å°±èƒ½è°ƒç”¨è‡ªå·±çš„ä»£ç äº†ã€‚</p>
</body></html>]]></content>
      <tags>
        <tag>android</tag>
      </tags>
  </entry>
  <entry>
    <title>hello hexo</title>
    <url>/ekibook/2020/03/15/hello-hexo/</url>
    <content><![CDATA[<html><head></head><body><p>ç¬¬ä¸€ç¯‡åšå®¢ï¼Œå…ˆå­¦å­¦<code>hexo</code>å§ã€‚ã€‚</p>
<a id="more"></a>

<p>å®‰è£…å°±ä¸è¯´äº†ã€‚å­˜ä¸€ä¸‹å¸¸ç”¨å‘½ä»¤ï¼ˆæ‘˜è‡ª<a href="https://zhuanlan.zhihu.com/p/60578464" target="_blank" rel="noopener">çŸ¥ä¹ä¸“æ </a>ï¼‰</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">hexo new <span class="string">"name"</span>       <span class="comment"># æ–°å»ºæ–‡ç« </span></span><br><span class="line">hexo new page <span class="string">"name"</span>  <span class="comment"># æ–°å»ºé¡µé¢</span></span><br><span class="line">hexo g                <span class="comment"># ç”Ÿæˆé¡µé¢</span></span><br><span class="line">hexo d                <span class="comment"># éƒ¨ç½²</span></span><br><span class="line">hexo g -d             <span class="comment"># ç”Ÿæˆé¡µé¢å¹¶éƒ¨ç½²</span></span><br><span class="line">hexo s                <span class="comment"># æœ¬åœ°é¢„è§ˆ</span></span><br><span class="line">hexo clean            <span class="comment"># æ¸…é™¤ç¼“å­˜å’Œå·²ç”Ÿæˆçš„é™æ€æ–‡ä»¶</span></span><br><span class="line">hexo <span class="built_in">help</span>             <span class="comment"># å¸®åŠ©</span></span><br></pre></td></tr></tbody></table></figure>

<p>ç¬¬ä¸€ä»¶äº‹å½“ç„¶æ˜¯æ¢ä¸»é¢˜ï¼Œå…ˆè¯•è¯•ç¬¬ä¸€åçš„<code>NexT</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/theme-next/hexo-theme-next themes/next</span><br></pre></td></tr></tbody></table></figure>

<p><code>NexT</code>å®˜æ–¹é¡¹ç›®é‡Œæ¨èäº†ä¸‹é¢å‡ ä¸ªpluginsï¼Œä¸ç®¡ç”¨ä¸ç”¨çš„ä¸Šå…ˆå…¨è£…äº†</p>
<ul>
<li><p><span class="emoji" alias="mag_right" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f50e.png?v8">ğŸ”</span> <a href="https://github.com/theme-next/hexo-generator-searchdb" target="_blank" rel="noopener">hexo-generator-searchdb</a>: Seach data generator plugin for Hexo.</p>
</li>
<li><p><span class="emoji" alias="tada" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f389.png?v8">ğŸ‰</span> <a href="https://github.com/theme-next/hexo-filter-emoji" target="_blank" rel="noopener">hexo-filter-emoji</a>: GitHub emojis for Hexo!</p>
</li>
<li><p><span class="emoji" alias="crystal_ball" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f52e.png?v8">ğŸ”®</span> <a href="https://github.com/theme-next/hexo-filter-optimize" target="_blank" rel="noopener">hexo-filter-optimize</a>: A Hexo plugin that optimize the pages loading speed.</p>
</li>
<li><p><span class="emoji" alias="100" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4af.png?v8">ğŸ’¯</span> <a href="https://github.com/stevenjoezhang/hexo-filter-mathjax" target="_blank" rel="noopener">hexo-filter-mathjax</a>: Server side MathJax renderer plugin for Hexo.</p>
</li>
<li><p><span class="emoji" alias="triangular_flag_on_post" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a9.png?v8">ğŸš©</span> <a href="https://github.com/stevenjoezhang/hexo-generator-indexed" target="_blank" rel="noopener">hexo-generator-indexed</a>: Index generator plugin with more user-defined options.</p>
</li>
</ul>
<p>æœ€åæ˜¯ä¸€äº›é…ç½®</p>
<h4 id="ä¸­æ–‡"><a href="#ä¸­æ–‡" class="headerlink" title="ä¸­æ–‡"></a>ä¸­æ–‡</h4><p>å’Œ<code>NexT</code>å®˜ç½‘è¯´çš„<code>zh-Hans</code>ä¸ä¸€æ ·</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">language:</span> <span class="string">zh-CN</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="Githubé…ç½®"><a href="#Githubé…ç½®" class="headerlink" title="Githubé…ç½®"></a>Githubé…ç½®</h4><p>è¦è£…ä¸Š<code>hexo-deployer-git</code>ï¼Œç„¶åä¿®æ”¹<code>_config.yml</code></p>
<p>Github pageæœ‰ä¸¤ç§æ¨¡å¼ï¼Œä¸€ç§æ˜¯å»º<code>username.github.io</code>çš„repoï¼Œç„¶åéƒ¨ç½²åˆ°<code>master</code>åˆ†æ”¯</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repository:</span> <span class="string">git@github.com:ekibun/ekibun.github.io.git</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">master</span></span><br></pre></td></tr></tbody></table></figure>

<p>è¿˜æœ‰ä¸€ç§æ˜¯å‘å¸ƒåˆ°repoçš„<code>gh-pages</code>åˆ†æ”¯ï¼š</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repository:</span> <span class="string">git@github.com:ekibun/ekibook.git</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">gh-pages</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="ä¿å­˜æœ¬åœ°å›¾ç‰‡"><a href="#ä¿å­˜æœ¬åœ°å›¾ç‰‡" class="headerlink" title="ä¿å­˜æœ¬åœ°å›¾ç‰‡"></a>ä¿å­˜æœ¬åœ°å›¾ç‰‡</h4><p>è¦è£…ä¸Š<code>hexo-asset-image</code>ï¼Œç„¶åä¿®æ”¹<code>_config.yml</code></p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">post_asset_folder:</span> <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure>

<p>ä½¿ç”¨ä¸Šæœ‰ä¸¤ç§ï¼Œä¸€ä¸ªæ˜¯å»ºç«‹å’Œé¡µé¢ä¸€æ ·çš„æ–‡ä»¶å¤¹ï¼Œç„¶åç”¨ç›¸å¯¹è·¯å¾„<code>page/image.jpg</code></p>
<p>å¦ä¸€ä¸ªæ˜¯æ”¾åœ¨<code>source/images</code>é‡Œé¢ç„¶åç”¨ç»å¯¹è·¯å¾„<code>/images/image.jpg</code></p>
<h4 id="å›¾æ ‡CDN"><a href="#å›¾æ ‡CDN" class="headerlink" title="å›¾æ ‡CDN"></a>å›¾æ ‡CDN</h4><p><del><code>NexT</code>é»˜è®¤ç”¨çš„å­—ä½“è¦ä»<a href="http://www.fontawesome.com.cn/" target="_blank" rel="noopener">FontAwesome</a>ä¸‹è½½ï¼Œç„¶åæŠŠ<code>fonts</code>æ–‡ä»¶å¤¹æ”¾åˆ°<code>source</code>æ–‡ä»¶å¤¹ä¸‹é¢å›¾æ ‡æ‰ä¼šæ­£å¸¸æ˜¾ç¤º</del></p>
<p>åŠ ä¸Š<code>fonts</code>æ–‡ä»¶å¤¹ä¹‹ååŠ è½½ä¼šéå¸¸æ…¢ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆåŸæ¥çš„cdnæ­»æ´»åŠ ä¸ä¸Šï¼Œæ¢æˆç¨³å®šç‰ˆçš„<code>NexT</code>ä¹‹åå°±è¡Œäº†ã€‚æŠŠä¸»é¢˜çš„<code>lib</code>åº“åˆ äº†ï¼Œå…¨æ¢æˆcdnï¼š</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">fontawesome:</span> <span class="string">//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="TAGé¡µé¢"><a href="#TAGé¡µé¢" class="headerlink" title="TAGé¡µé¢"></a>TAGé¡µé¢</h4><p><code>hexo new page tags</code>åˆ›å»ºä¸€ä¸ªé¡µé¢ï¼Œç„¶å<code>index.md</code>åŠ ä¸Š<code>type: "tags"</code></p>
<figure class="highlight markdown"><table><tbody><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: tags</span><br><span class="line">date: 2020-03-15 20:43:21</span><br><span class="line">type: "tags"</span><br><span class="line">comments: false</span><br><span class="line">---</span><br></pre></td></tr></tbody></table></figure>

<h4 id="Gitalkè¯„è®º"><a href="#Gitalkè¯„è®º" class="headerlink" title="Gitalkè¯„è®º"></a>Gitalkè¯„è®º</h4><p>å…ˆåœ¨Githubåˆ›å»ºä¸€ä¸ª<a href="https://github.com/settings/developers" target="_blank" rel="noopener">OAuth App</a>ï¼Œç„¶ååœ¨<code>NexT</code>é‡Œçš„<code>_config.yml</code>æŠŠæ•°æ®å¡«ä¸Š</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Gitalk</span></span><br><span class="line"><span class="comment"># For more information: https://gitalk.github.io, https://github.com/gitalk/gitalk</span></span><br><span class="line"><span class="attr">gitalk:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">github_id:</span> <span class="string">ekibun</span> <span class="comment"># GitHub repo owner</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">ekibun.github.io</span> <span class="comment"># Repository name to store issues</span></span><br><span class="line">  <span class="attr">client_id:</span> <span class="string">***</span> <span class="comment"># GitHub Application Client ID</span></span><br><span class="line">  <span class="attr">client_secret:</span> <span class="string">*****</span> <span class="comment"># GitHub Application Client Secret</span></span><br><span class="line">  <span class="attr">admin_user:</span> <span class="string">ekibun</span> <span class="comment"># GitHub repo owner and collaborators, only these guys can initialize gitHub issues</span></span><br><span class="line">  <span class="attr">distraction_free_mode:</span> <span class="literal">true</span> <span class="comment"># Facebook-like distraction free mode</span></span><br><span class="line">  <span class="comment"># Gitalk's display language depends on user's browser or system environment</span></span><br><span class="line">  <span class="comment"># If you want everyone visiting your site to see a uniform language, you can set a force language value</span></span><br><span class="line">  <span class="comment"># Available values: en | es-ES | fr | ru | zh-CN | zh-TW</span></span><br><span class="line">  <span class="attr">language:</span> <span class="string">zh-CN</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="è®¿å®¢ç»Ÿè®¡"><a href="#è®¿å®¢ç»Ÿè®¡" class="headerlink" title="è®¿å®¢ç»Ÿè®¡"></a>è®¿å®¢ç»Ÿè®¡</h4><p>åœ¨<code>NexT</code>é…ç½®æ–‡ä»¶é‡ŒæŠŠ<code>busuanzi_count</code>æ‰“å¼€å°±è¡Œäº†</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Show Views / Visitors of the website / page with busuanzi.</span></span><br><span class="line"><span class="comment"># Get more information on http://ibruce.info/2015/04/04/busuanzi</span></span><br><span class="line"><span class="attr">busuanzi_count:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="å­—æ•°ç»Ÿè®¡"><a href="#å­—æ•°ç»Ÿè®¡" class="headerlink" title="å­—æ•°ç»Ÿè®¡"></a>å­—æ•°ç»Ÿè®¡</h4><p>è£…ä¸Šæ’ä»¶<code>hexo-symbols-count-time</code>ç›´æ¥ç”Ÿæ•ˆ</p>
<h4 id="ç«™ç‚¹åœ°å›¾"><a href="#ç«™ç‚¹åœ°å›¾" class="headerlink" title="ç«™ç‚¹åœ°å›¾"></a>ç«™ç‚¹åœ°å›¾</h4><p>éœ€è¦<code>hexo-generator-sitemap</code>å’Œ<code>hexo-generator-baidu-sitemap</code>ï¼Œä½†æ˜¯æˆ‘æ²¡æ„Ÿè§‰å®ƒä»¬ç”Ÿæˆçš„ä¸œè¥¿æœ‰ä»€ä¹ˆä¸åŒï¼Œå¦å¤–ï¼Œ<code>hexo-generator-baidu-sitemap</code>å¯¹<code>root</code>ä¸æ˜¯æ ¹ç›®å½•çš„æ”¯æŒä¸å¥½ï¼Œéœ€è¦é‡æ–°æŒ‡å®šurlï¼š</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">baidusitemap:</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">https://ekibun.github.io</span></span><br></pre></td></tr></tbody></table></figure>

</body></html>]]></content>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>æ¼«ç”»é˜…è¯»å™¨ï¼ˆä¸‰ï¼‰ç¿»é¡µLayoutManager</title>
    <url>/ekibook/2020/03/19/booklayoutmanager/</url>
    <content><![CDATA[<html><head></head><body><p>çœ‹æ¼«ç”»æˆ‘è§‰å¾—è¿˜æ˜¯å·çº¸æ¨¡å¼èˆ’æœï¼Œå°è¯´çš„è¯ç¿»ä¹¦æ¨¡å¼ä¼¼ä¹å¥½ç‚¹ã€‚</p>
<p>è¿˜æ˜¯ä»<code>LinearLayoutManager</code>å¼€å§‹ï¼Œè‡ªå¸¦çš„<code>onLayoutChildren</code>è‡ªç„¶å°±ä¸èƒ½ç”¨äº†ã€‚</p>
<a id="more"></a>

<p>å¼„ä¸ª<code>currentPos</code>å­˜å½“å‰ä½ç½®ï¼Œé‡å†™<code>onLayoutChildren</code>ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> currentPos = <span class="number">0f</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLayoutChildren</span><span class="params">(recycler: <span class="type">RecyclerView</span>.<span class="type">Recycler</span>, state: <span class="type">RecyclerView</span>.<span class="type">State</span>)</span></span> {</span><br><span class="line">    <span class="keyword">if</span> (orientation == VERTICAL) <span class="keyword">return</span> <span class="keyword">super</span>.onLayoutChildren(recycler, state)</span><br><span class="line">    detachAndScrapAttachedViews(recycler)</span><br><span class="line"></span><br><span class="line">    currentPos = Math.max(<span class="number">0f</span>, Math.min(currentPos, itemCount - <span class="number">1f</span>))</span><br><span class="line">    <span class="keyword">if</span> (state.itemCount &lt;= <span class="number">0</span> || state.isPreLayout) <span class="keyword">return</span></span><br><span class="line">    downPage = currentPos.toInt()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> currentIndex = currentPos.toInt()</span><br><span class="line">    <span class="keyword">val</span> view = recycler.getViewForPosition(currentIndex)</span><br><span class="line">    addView(view)</span><br><span class="line">    measureChildWithMargins(view, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    view.translationZ = <span class="number">50f</span></span><br><span class="line">    view.translationX = -(currentPos - currentIndex) * width</span><br><span class="line">    layoutDecoratedWithMargins(view, <span class="number">0</span>, <span class="number">0</span>, view.measuredWidth, view.measuredHeight)</span><br><span class="line">    <span class="comment">// å‰ä¸€ä¸ª</span></span><br><span class="line">    <span class="keyword">if</span> (currentIndex - <span class="number">1</span> &gt;= <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">val</span> nextView = recycler.getViewForPosition(currentIndex - <span class="number">1</span>)</span><br><span class="line">        addView(nextView)</span><br><span class="line">        nextView.translationX = -width * scale</span><br><span class="line">        nextView.translationZ = <span class="number">100f</span></span><br><span class="line">        measureChildWithMargins(nextView, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">        layoutDecoratedWithMargins(nextView, <span class="number">0</span>, <span class="number">0</span>, view.measuredWidth, view.measuredHeight)</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// åä¸€ä¸ª</span></span><br><span class="line">    <span class="keyword">if</span> (currentIndex + <span class="number">1</span> &lt; state.itemCount) {</span><br><span class="line">        <span class="keyword">val</span> nextView = recycler.getViewForPosition(currentIndex + <span class="number">1</span>)</span><br><span class="line">        addView(nextView)</span><br><span class="line">        nextView.translationX = <span class="number">0f</span></span><br><span class="line">        nextView.translationZ = <span class="number">0f</span></span><br><span class="line">        measureChildWithMargins(nextView, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">        layoutDecoratedWithMargins(nextView, <span class="number">0</span>, <span class="number">0</span>, view.measuredWidth, view.measuredHeight)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>é¦–å…ˆæ ¹æ®<code>itemCount</code>çº¦æŸ<code>currentPos</code>çš„èŒƒå›´ï¼Œ<code>onLayoutChildren</code>è¦æ‰§è¡Œä»¥ä¸‹å››æ­¥</p>
<ul>
<li><p><code>detachAndScrapAttachedViews(recycler)</code> å°†æ‰€æœ‰å­é¡¹å›æ”¶</p>
</li>
<li><p><code>recycler.getViewForPosition(currentIndex)</code> è·å–å­é¡¹</p>
</li>
<li><p><code>measureChildWithMargins</code> æµ‹é‡å­é¡¹</p>
</li>
<li><p><code>layoutDecoratedWithMargins</code> å¸ƒå±€å­é¡¹</p>
</li>
</ul>
<p>ç¿»é¡µåªéœ€è¦å¸ƒå±€å‰åå’Œå½“å‰ä¸‰ä¸ªå­é¡¹ï¼Œè¿™é‡Œç”¨<code>translationX</code>æ¥ä½ç§»å­é¡¹ï¼Œé˜²æ­¢å’Œç¼©æ”¾å†²çªï¼Œä¿®æ”¹<code>translationZ</code>æ—¢èƒ½æ”¹å˜å±‚çº§å…³ç³»ï¼Œè¿˜èƒ½ç»™ä¸‹å±‚Viewå¸¦ä¸Šé˜´å½±ï¼Œä¸€ä¸¾ä¸¤å¾—ã€‚</p>
<p><code>currentPos</code>ç‹¬ç«‹äº<code>LinearlayoutManager</code>ï¼Œå› æ­¤å’Œä½ç½®ç›¸å…³çš„æ–¹æ³•è¦ä¸€èµ·é‡å†™ï¼Œé¦–å…ˆæ˜¯<code>computeHorizontalScrollOffset</code>å’Œ<code>computeHorizontalScrollRange</code>ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°è¿”å›çš„å€¼ç”¨æ¥åˆ¤æ–­æ˜¯å¦æ»šåŠ¨åˆ°è¾¹ç•Œï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">computeHorizontalScrollOffset</span><span class="params">(state: <span class="type">RecyclerView</span>.<span class="type">State</span>)</span></span>: <span class="built_in">Int</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">if</span> (orientation == VERTICAL) <span class="keyword">super</span>.computeHorizontalScrollOffset(state)</span><br><span class="line">    <span class="keyword">else</span> (currentPos * width).toInt() + <span class="keyword">if</span> (scale &gt; <span class="number">1f</span>) <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">computeHorizontalScrollRange</span><span class="params">(state: <span class="type">RecyclerView</span>.<span class="type">State</span>)</span></span>: <span class="built_in">Int</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">if</span> (orientation == VERTICAL) <span class="keyword">super</span>.computeHorizontalScrollRange(state)</span><br><span class="line">    <span class="keyword">else</span> itemCount * width</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æˆ‘ä¸€èˆ¬åªç”¨<code>scrollToPositionWithOffset</code>ä¿®æ”¹ä½ç½®ï¼Œæ‰€ä»¥åªé‡å†™è¿™ä¸ªï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">scrollToPositionWithOffset</span><span class="params">(position: <span class="type">Int</span>, offset: <span class="type">Int</span>)</span></span> {</span><br><span class="line">    currentPos = position.toFloat()</span><br><span class="line">    <span class="keyword">super</span>.scrollToPositionWithOffset(position, offset)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>measureChildWithMargins</code>åœ¨ç¼©æ”¾çš„åŸºç¡€ä¸Šï¼Œè¿˜è¦åˆ¤æ–­Viewæ˜¯å¦å°äº<code>RecyclerView</code>çš„é«˜åº¦ï¼Œå°äºè¦æ”¹æˆé“ºæ»¡</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">measureChildWithMargins</span><span class="params">(child: <span class="type">View</span>, widthUsed: <span class="type">Int</span>, heightUsed: <span class="type">Int</span>)</span></span> {</span><br><span class="line">	...</span><br><span class="line">    <span class="keyword">if</span> (orientation == VERTICAL || child.measuredHeight &gt;= height) <span class="keyword">return</span></span><br><span class="line">    child.measure(</span><br><span class="line">        widthSpec, RecyclerView.LayoutManager.getChildMeasureSpec(</span><br><span class="line">            height, heightMode,</span><br><span class="line">            paddingTop + paddingBottom</span><br><span class="line">                    + lp.topMargin + lp.bottomMargin + heightUsed, RecyclerView.LayoutParams.MATCH_PARENT,</span><br><span class="line">            canScrollVertically()</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>åŒæ—¶ï¼Œ<code>offset</code>å¤šäº†ç«–å‘åç§»ï¼Œè¦æŠŠ<code>offsetX</code>å¤åˆ¶ä¸€éå˜æˆ<code>offsetY</code>ï¼Œ<code>scrollVerticallyBy</code>ä¸èƒ½åƒæ¨ªå‘ä¸€æ ·ç”±å®½åº¦ä¹˜ä»¥<code>scale</code>å¾—åˆ°ï¼Œè¦è·å–å½“å‰å­é¡¹çš„å®é™…é«˜åº¦ï¼š</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">override fun scrollVerticallyBy(dy: Int, recycler: RecyclerView.Recycler, state: RecyclerView.State?): Int {</span><br><span class="line">    if (orientation == VERTICAL) return super.scrollVerticallyBy(dy, recycler, state)</span><br><span class="line"></span><br><span class="line">    val view = findViewByPosition(currentPos.toInt())</span><br><span class="line">    val ddy = Math.max(Math.min(dy, (view?.height ?: height) - height - offsetY), -offsetY)</span><br><span class="line">    offsetY += ddy</span><br><span class="line">    offsetChildrenVertical(-ddy)</span><br><span class="line">    return if (scale == 1f) dy else ddy</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>åœ¨æ¨ªå‘æ»šåŠ¨<code>scrollHorizontallyBy</code>å¤„ç†ç¿»é¡µï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">scrollHorizontallyBy</span><span class="params">(dx: <span class="type">Int</span>, recycler: <span class="type">RecyclerView</span>.<span class="type">Recycler</span>, state: <span class="type">RecyclerView</span>.<span class="type">State</span>)</span></span>: <span class="built_in">Int</span> {</span><br><span class="line">    <span class="keyword">val</span> view = findViewByPosition(downPage)</span><br><span class="line">    <span class="keyword">val</span> ddx = Math.max(</span><br><span class="line">        Math.min(</span><br><span class="line">            dx,</span><br><span class="line">            (<span class="keyword">if</span> (orientation == VERTICAL) (width * scale).toInt() <span class="keyword">else</span> view?.width ?: width) - width - offsetX</span><br><span class="line">        ), -offsetX</span><br><span class="line">    )</span><br><span class="line">    offsetX += ddx</span><br><span class="line">    offsetChildrenHorizontal(-ddx)</span><br><span class="line">    view?.translationX = <span class="number">0f</span></span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0</span> until recyclerView.childCount) updateContent(recyclerView.getChildAt(i), <span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (orientation == VERTICAL || scale &gt; <span class="number">1</span> || doingScale || view == <span class="literal">null</span>) <span class="keyword">return</span> <span class="keyword">if</span> (scale == <span class="number">1f</span>) dx <span class="keyword">else</span> ddx</span><br><span class="line"></span><br><span class="line">    currentPos = Math.max(downPage - <span class="number">1f</span>, Math.min(currentPos + dx.toFloat() / width, downPage + <span class="number">1f</span>))</span><br><span class="line">    currentPos = Math.max(<span class="number">0f</span>, Math.min(currentPos, itemCount - <span class="number">1f</span>))</span><br><span class="line">    view.translationX = -Math.max((currentPos - downPage) * width, <span class="number">0f</span>)</span><br><span class="line">    <span class="keyword">if</span> (currentPos &lt; downPage) findViewByPosition(downPage - <span class="number">1</span>)?.translationX = -(currentPos - downPage + <span class="number">1</span>) * width</span><br><span class="line">    <span class="keyword">return</span> dx</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æœ€åï¼Œä»¿ç…§<code>SnapHelper</code>è®©é¡µé¢ä¿æŒå¯¹é½ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line">view.onFlingListener = <span class="keyword">object</span> : RecyclerView.OnFlingListener() {</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFling</span><span class="params">(velocityX: <span class="type">Int</span>, velocityY: <span class="type">Int</span>)</span></span>: <span class="built_in">Boolean</span> {</span><br><span class="line">        <span class="keyword">val</span> minFlingVelocity = recyclerView.minFlingVelocity</span><br><span class="line">        <span class="keyword">if</span> (orientation == VERTICAL || scale &gt; <span class="number">1f</span>) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> targetPos = <span class="keyword">when</span> {</span><br><span class="line">            Math.abs(velocityX) &lt; minFlingVelocity -&gt; Math.round(currentPos)</span><br><span class="line">            velocityX &lt; <span class="number">0</span> -&gt; currentPos.toInt()</span><br><span class="line">            <span class="keyword">else</span> -&gt; Math.min(currentPos.toInt() + <span class="number">1</span>, itemCount - <span class="number">1</span>)</span><br><span class="line">        }</span><br><span class="line">        snapToTarget(targetPos)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">view.addOnScrollListener(<span class="keyword">object</span> : RecyclerView.OnScrollListener() {</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onScrollStateChanged</span><span class="params">(recyclerView: <span class="type">RecyclerView</span>, newState: <span class="type">Int</span>)</span></span> {</span><br><span class="line">        <span class="keyword">super</span>.onScrollStateChanged(recyclerView, newState)</span><br><span class="line">        <span class="keyword">if</span> (orientation == VERTICAL || scale &gt; <span class="number">1f</span>) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (newState == RecyclerView.SCROLL_STATE_IDLE) {</span><br><span class="line">            snapToTarget(Math.round(currentPos))</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">})</span><br></pre></td></tr></tbody></table></figure>

<p><code>snapToTarget</code>æ˜¯æŠ„çš„<code>PagerSnapHelper</code>ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">snapToTarget</span><span class="params">(targetPos: <span class="type">Int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">if</span> (targetPos &lt; <span class="number">0</span> || targetPos &gt; itemCount - <span class="number">1</span>) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">val</span> smoothScroller: LinearSmoothScroller = createSnapScroller(targetPos)</span><br><span class="line">    smoothScroller.targetPosition = targetPos</span><br><span class="line">    startSmoothScroll(smoothScroller)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">createSnapScroller</span><span class="params">(targetPos: <span class="type">Int</span>)</span></span>: LinearSmoothScroller {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">object</span> : LinearSmoothScroller(recyclerView.context) {</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTargetFound</span><span class="params">(targetView: <span class="type">View</span>, state: <span class="type">RecyclerView</span>.<span class="type">State</span>, action: <span class="type">Action</span>)</span></span> {</span><br><span class="line">            Log.v(<span class="string">"snap"</span>, <span class="string">"<span class="variable">$currentPos</span> <span class="variable">$targetPos</span>"</span>)</span><br><span class="line">            <span class="keyword">val</span> dx = -((currentPos - targetPos) * (width + <span class="number">0.5f</span>)).toInt()</span><br><span class="line">            <span class="keyword">val</span> time = calculateTimeForDeceleration(Math.abs(dx))</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) {</span><br><span class="line">                action.update(dx, <span class="number">0</span>, time, mDecelerateInterpolator)</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">calculateSpeedPerPixel</span><span class="params">(displayMetrics: <span class="type">DisplayMetrics</span>)</span></span>: <span class="built_in">Float</span> {</span><br><span class="line">            <span class="keyword">return</span> MILLISECONDS_PER_INCH / displayMetrics.densityDpi</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">calculateTimeForScrolling</span><span class="params">(dx: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> {</span><br><span class="line">            <span class="keyword">return</span> Math.min(</span><br><span class="line">                MAX_SCROLL_ON_FLING_DURATION,</span><br><span class="line">                <span class="keyword">super</span>.calculateTimeForScrolling(dx)</span><br><span class="line">            )</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">companion</span> <span class="keyword">object</span> {</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">val</span> MILLISECONDS_PER_INCH = <span class="number">100f</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">val</span> MAX_SCROLL_ON_FLING_DURATION = <span class="number">100</span> <span class="comment">// ms</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><a href="https://github.com/ekibun/BangumiPlugin/blob/master/app/src/main/java/soko/ekibun/bangumi/plugins/ui/view/book/BookLayoutManager.kt" target="_blank" rel="noopener">å®Œæ•´ä»£ç ä¼ é€é—¨</a></p>
</body></html>]]></content>
      <tags>
        <tag>android</tag>
      </tags>
  </entry>
  <entry>
    <title>windowsä¸‹é™æ€ç¼–è¯‘androidç«¯ffmpeg</title>
    <url>/ekibook/2021/03/17/ffmpeg-static-build/</url>
    <content><![CDATA[<html><head></head><body><p>ç ”ç©¶è§†é¢‘æ’­æ”¾ï¼Œç”¨åˆ°äº†ffmpegçš„åº“ï¼Œåœ¨windowsä¸‹è¿›è¡Œäº¤å‰ç¼–è¯‘çœŸæ˜¯å¤ªéº»çƒ¦äº†ï¼Œwindowsç«¯æŒ‰ç…§<a href="https://github.com/microsoft/FFmpegInterop" target="_blank" rel="noopener">å®˜æ–¹æ•™ç¨‹</a>è¿˜ç®—é¡ºåˆ©ï¼Œä½†å®‰å“ç«¯çš„æ•™ç¨‹æ²¡ä¸€ä¸ªèƒ½ç”¨çš„ï¼Œæœ€åå‚è€ƒ<a href="https://github.com/binglingziyu/ffmpeg-android-build" target="_blank" rel="noopener">è¿™ä¸ªä»£ç </a>æ‰ç¼–è¯‘æˆåŠŸï¼Œè®°å½•ä¸€ä¸‹è¿‡ç¨‹ï¼š</p>
<a id="more"></a>

<p>å‚è€ƒå¾®è½¯å®˜æ–¹æ•™ç¨‹ï¼Œå…ˆå†™ä¸ªshellï¼Œè¿™é‡Œæ ¹æ®ä¸åŒå¹³å°è®¾ç½®ä¸åŒçš„å‚æ•°ï¼š</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">DIR=$( <span class="built_in">cd</span> <span class="string">"<span class="variable">$( dirname "${BASH_SOURCE[0]}" )</span>"</span> &amp;&amp; <span class="built_in">pwd</span> )</span><br><span class="line"></span><br><span class="line"><span class="built_in">pushd</span> <span class="variable">$DIR</span></span><br><span class="line"></span><br><span class="line">abi=<span class="string">"<span class="variable">$1_</span><span class="variable">$2</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -d build/<span class="variable">$abi</span> ]; <span class="keyword">then</span></span><br><span class="line">  rm -r build/<span class="variable">$abi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">mkdir -p build/<span class="variable">$abi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> build/<span class="variable">$abi</span></span><br><span class="line"></span><br><span class="line">COMMON_CONFIG=<span class="string">"\</span></span><br><span class="line"><span class="string">  --disable-programs \</span></span><br><span class="line"><span class="string">  --disable-encoders \</span></span><br><span class="line"><span class="string">  --disable-muxers \</span></span><br><span class="line"><span class="string">  --disable-avdevice \</span></span><br><span class="line"><span class="string">  --disable-protocols \</span></span><br><span class="line"><span class="string">  --disable-doc \</span></span><br><span class="line"><span class="string">  --disable-filters \</span></span><br><span class="line"><span class="string">  --disable-avfilter \</span></span><br><span class="line"><span class="string">  --enable-static \</span></span><br><span class="line"><span class="string">  --enable-cross-compile \</span></span><br><span class="line"><span class="string">  --prefix=./ \</span></span><br><span class="line"><span class="string">"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">  <span class="string">"win32"</span>)</span><br><span class="line">    INCLUDE=<span class="string">"<span class="variable">$JAVA_HOME</span>\include;<span class="variable">$INCLUDE</span>"</span></span><br><span class="line">    LIB=<span class="string">"<span class="variable">$JAVA_HOME</span>\lib;<span class="variable">$LIB</span>"</span></span><br><span class="line">    ../../ffmpeg/configure \</span><br><span class="line">      <span class="variable">$COMMON_CONFIG</span> \</span><br><span class="line">      --arch=<span class="variable">$2</span> \</span><br><span class="line">      --target-os=<span class="variable">$1</span> \</span><br><span class="line">      --toolchain=msvc \</span><br><span class="line">      --<span class="built_in">disable</span>-d3d11va \</span><br><span class="line">      --<span class="built_in">disable</span>-dxva2 \</span><br><span class="line">      --extra-cflags=<span class="string">"-MD -DWINAPI_FAMILY=WINAPI_FAMILY_APP -D_WIN32_WINNT=0x0A00"</span> \</span><br><span class="line">      --extra-ldflags=<span class="string">"-APPCONTAINER WindowsApp.lib"</span></span><br><span class="line">    ;;</span><br><span class="line">  <span class="string">"android"</span>)</span><br><span class="line">    MIN_PLATFORM=<span class="string">"<span class="variable">$ANDROID_NDK_HOME</span>/platforms/android-21"</span></span><br><span class="line">    TOOLCHAIN=<span class="string">"<span class="variable">$ANDROID_NDK_HOME</span>/toolchains/llvm/prebuilt/windows-x86_64"</span></span><br><span class="line">    <span class="keyword">case</span> <span class="variable">$2</span> <span class="keyword">in</span></span><br><span class="line">      <span class="string">"arm"</span>)</span><br><span class="line">        CC_PREFIX=<span class="string">"<span class="variable">$TOOLCHAIN</span>/bin/armv7a-linux-androideabi21"</span></span><br><span class="line">        CROSS_PREFIX=<span class="string">"<span class="variable">$TOOLCHAIN</span>/bin/arm-linux-androideabi-"</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">"arm64"</span>)</span><br><span class="line">        CC_PREFIX=<span class="string">"<span class="variable">$TOOLCHAIN</span>/bin/aarch64-linux-android21"</span></span><br><span class="line">        CROSS_PREFIX=<span class="string">"<span class="variable">$TOOLCHAIN</span>/bin/aarch64-linux-android-"</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">"x86"</span>)</span><br><span class="line">        CC_PREFIX=<span class="string">"<span class="variable">$TOOLCHAIN</span>/bin/i686-linux-android21"</span></span><br><span class="line">        CROSS_PREFIX=<span class="string">"<span class="variable">$TOOLCHAIN</span>/bin/i686-linux-android-"</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">"x86_64"</span>)</span><br><span class="line">        CC_PREFIX=<span class="string">"<span class="variable">$TOOLCHAIN</span>/bin/x86_64-linux-android21"</span></span><br><span class="line">        CROSS_PREFIX=<span class="string">"<span class="variable">$TOOLCHAIN</span>/bin/x86_64-linux-android-"</span></span><br><span class="line">        ;;</span><br><span class="line">      *)</span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line">    ../../ffmpeg/configure \</span><br><span class="line">      <span class="variable">$COMMON_CONFIG</span> \</span><br><span class="line">      --arch=<span class="variable">$2</span> \</span><br><span class="line">      --target-os=<span class="variable">$1</span> \</span><br><span class="line">      --cc=<span class="variable">$CC_PREFIX</span>-clang \</span><br><span class="line">      --cxx=<span class="variable">$CC_PREFIX</span>-clang++ \</span><br><span class="line">      --cross-prefix=<span class="variable">$CROSS_PREFIX</span> \</span><br><span class="line">      --<span class="built_in">enable</span>-jni \</span><br><span class="line">      --<span class="built_in">disable</span>-asm \</span><br><span class="line">      --extra-cflags=<span class="string">"-Os -fpic -DANDROID"</span> \</span><br><span class="line">      --extra-ldflags=<span class="string">"-Wl,-rpath-link=<span class="variable">$MIN_PLATFORM</span>/arch-arm/usr/lib -nostdlib -fPIC"</span></span><br><span class="line">    sed -i <span class="string">"s/#define HAVE_INET_ATON 0/#define HAVE_INET_ATON 1/"</span> config.h</span><br><span class="line">    sed -i <span class="string">"s/#define getenv(x) NULL/\\/\\/ #define getenv(x) NULL/"</span> config.h</span><br><span class="line">    ;;</span><br><span class="line">  *)</span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> == <span class="string">"win32"</span> ]; <span class="keyword">then</span></span><br><span class="line">  toolchain=<span class="string">'msvc'</span></span><br><span class="line">  extracflags=<span class="string">"-MD -DWINAPI_FAMILY=WINAPI_FAMILY_APP -D_WIN32_WINNT=0x0A00"</span></span><br><span class="line">  extraldflags=<span class="string">"-APPCONTAINER WindowsApp.lib"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">make -j8</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="built_in">popd</span></span><br></pre></td></tr></tbody></table></figure>

<p>ç„¶åå†™ä¸ªcmdè¿è¡Œmsysï¼š</p>
<figure class="highlight bat"><table><tbody><tr><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> MSYS2_PATH_TYPE=inherit</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> ANDROID_NDK_HOME=C:/Users/ekibun/AppData/Local/Android/Sdk/ndk/<span class="number">21</span>.<span class="number">4</span>.<span class="number">7075529</span></span><br><span class="line">"C:\msys64\usr\bin\bash.exe" --login -x %~dp0ffmpeg.config.sh android arm</span><br><span class="line">"C:\msys64\usr\bin\bash.exe" --login -x %~dp0ffmpeg.config.sh android arm64</span><br><span class="line">"C:\msys64\usr\bin\bash.exe" --login -x %~dp0ffmpeg.config.sh android x86</span><br><span class="line">"C:\msys64\usr\bin\bash.exe" --login -x %~dp0ffmpeg.config.sh android x86_64</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> "C:\Program Files (x86)\Microsoft Visual Studio\<span class="number">2019</span>\BuildTools\VC\Auxiliary\Build\vcvarsall.bat" x64</span><br><span class="line">"C:\msys64\usr\bin\bash.exe" --login -x %~dp0ffmpeg.config.sh win32 x86_64</span><br><span class="line"><span class="keyword">call</span> "C:\Program Files (x86)\Microsoft Visual Studio\<span class="number">2019</span>\BuildTools\VC\Auxiliary\Build\vcvarsall.bat" x86</span><br><span class="line">"C:\msys64\usr\bin\bash.exe" --login -x %~dp0ffmpeg.config.sh win32 x86</span><br></pre></td></tr></tbody></table></figure>

<p>åœ¨CMakeLists.txté‡Œé’ˆå¯¹ä¸åŒå¹³å°é“¾æ¥ä¸åŒçš„é™æ€åº“ï¼š</p>
<figure class="highlight cmake"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.7</span> FATAL_ERROR)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span>(ffmpeg LANGUAGES CXX)</span><br><span class="line"><span class="keyword">add_library</span>(ffmpeg SHARED</span><br><span class="line">  <span class="variable">${CMAKE_CURRENT_LIST_DIR}</span>/ffmpeg.cpp</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ANDROID)</span><br><span class="line">  <span class="keyword">set</span>(FFMPEG_PATH <span class="string">"${CMAKE_CURRENT_LIST_DIR}/build/android_${CMAKE_ANDROID_ARCH}"</span>)</span><br><span class="line">  <span class="keyword">set</span>(ffmpeg-lib</span><br><span class="line">    z</span><br><span class="line">  )</span><br><span class="line"><span class="keyword">endif</span> ()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (WIN32)</span><br><span class="line">  <span class="keyword">if</span> (CMAKE_VS_PLATFORM_NAME <span class="keyword">MATCHES</span> <span class="string">"x64"</span>)</span><br><span class="line">    <span class="keyword">set</span>(FFMPEG_PATH <span class="string">"${CMAKE_CURRENT_LIST_DIR}/build/win32_x86_64"</span>)</span><br><span class="line">  <span class="keyword">else</span>()</span><br><span class="line">    <span class="keyword">set</span>(FFMPEG_PATH <span class="string">"${CMAKE_CURRENT_LIST_DIR}/build/win32_x86"</span>)</span><br><span class="line">  <span class="keyword">endif</span> ()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span>(ffmpeg-lib</span><br><span class="line">    WindowsApp.lib</span><br><span class="line">  )</span><br><span class="line"><span class="keyword">endif</span> ()</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_include_directories</span>(ffmpeg PRIVATE <span class="string">"${FFMPEG_PATH}/include"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span>(ffmpeg PRIVATE</span><br><span class="line">  <span class="variable">${ffmpeg-lib}</span></span><br><span class="line">  <span class="string">"${FFMPEG_PATH}/lib/libavformat.a"</span></span><br><span class="line">  <span class="string">"${FFMPEG_PATH}/lib/libavcodec.a"</span></span><br><span class="line">  <span class="string">"${FFMPEG_PATH}/lib/libavutil.a"</span></span><br><span class="line">  <span class="string">"${FFMPEG_PATH}/lib/libswresample.a"</span></span><br><span class="line">  <span class="string">"${FFMPEG_PATH}/lib/libswscale.a"</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>æ³¨æ„è¿™é‡Œè¦å¸¦ä¸Šconfigé‡Œé“¾æ¥çš„åº“ï¼Œä¸ç„¶ä¼šæ‰¾ä¸åˆ°ç¬¦å·ã€‚</p>
</body></html>]]></content>
      <tags>
        <tag>android</tag>
        <tag>ffmpeg</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo-asset-imageæ’ä»¶ä¿®æ”¹</title>
    <url>/ekibook/2020/04/07/hexoimage/</url>
    <content><![CDATA[<html><head></head><body><p>æˆ‘ä¹ æƒ¯ç”¨Typoraæ¥å†™markdownï¼Œé»˜è®¤çš„hexo-asset-imageå’ŒTyporaçš„è·¯å¾„æ–¹æ³•ä¸å¤ªä¸€æ ·ï¼Œçœ‹äº†ä¸€ä¸‹æºç ä¹ŸæŒºç®€å•ï¼Œå°±æ”¹æˆäº†å’ŒTyporaç›¸å¯¹è·¯å¾„ä¸€æ ·çš„å†™æ³•ã€‚</p>
<a id="more"></a>

<h4 id="Typoraè®¾ç½®"><a href="#Typoraè®¾ç½®" class="headerlink" title="Typoraè®¾ç½®"></a>Typoraè®¾ç½®</h4><p>å¯ä»¥è®¾ç½®æ’å…¥å›¾ç‰‡æ—¶å¤åˆ¶åˆ°æ–‡ä»¶åå¯¹åº”çš„æ–‡ä»¶å¤¹ï¼š</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2020/04/07/hexoimage/image-20200407210303642.png" alt="image-20200407210303642"></p>
<h4 id="hexo-asset-imageä¿®æ”¹"><a href="#hexo-asset-imageä¿®æ”¹" class="headerlink" title="hexo-asset-imageä¿®æ”¹"></a>hexo-asset-imageä¿®æ”¹</h4><p>é¦–å…ˆè®¾ç½®é‡Œçš„<code>post_asset_folder</code>è¦æ‰“å¼€ï¼Œç„¶ååœ¨ <code>scripts</code>æ–‡ä»¶å¤¹é‡Œæ–°å»º<code>hexo-asset-image.js</code>æ–‡ä»¶ï¼š</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"><span class="keyword">var</span> cheerio = <span class="built_in">require</span>(<span class="string">'cheerio'</span>);</span><br><span class="line"></span><br><span class="line">hexo.extend.filter.register(<span class="string">'after_post_render'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>{</span><br><span class="line">  <span class="keyword">const</span> { config } = hexo;</span><br><span class="line">  <span class="keyword">if</span>(config.post_asset_folder){</span><br><span class="line">    <span class="keyword">const</span> link = data.permalink.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`^<span class="subst">${config.url}</span>/|(index\.html)?$`</span>, <span class="string">'ig'</span>), <span class="string">""</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(link);</span><br><span class="line">    [<span class="string">'excerpt'</span>, <span class="string">'more'</span>, <span class="string">'content'</span>].forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> {</span><br><span class="line">      <span class="keyword">const</span> $ = cheerio.load(data[key], {</span><br><span class="line">        ignoreWhitespace: <span class="literal">false</span>,</span><br><span class="line">        xmlMode: <span class="literal">false</span>,</span><br><span class="line">        lowerCaseTags: <span class="literal">false</span>,</span><br><span class="line">        decodeEntities: <span class="literal">false</span></span><br><span class="line">      });</span><br><span class="line"></span><br><span class="line">      $(<span class="string">'img'</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>{</span><br><span class="line">        [<span class="string">'src'</span>, <span class="string">'data-src'</span>].forEach(<span class="function">(<span class="params">srcAttr</span>) =&gt;</span> {</span><br><span class="line">          <span class="keyword">if</span>(!$(<span class="keyword">this</span>).attr(srcAttr)) <span class="keyword">return</span></span><br><span class="line">          <span class="keyword">let</span> src = $(<span class="keyword">this</span>).attr(srcAttr).replace(<span class="string">'\\'</span>, <span class="string">'/'</span>).trim();</span><br><span class="line">          <span class="comment">// skip http url</span></span><br><span class="line">          <span class="keyword">if</span>(<span class="regexp">/^(https?:)?\/\//</span>.test(src)) <span class="keyword">return</span></span><br><span class="line">          <span class="comment">// replace ../ to config.root</span></span><br><span class="line">          <span class="keyword">if</span>(<span class="regexp">/^\.\.\//</span>.test(src)) src = src.replace(<span class="regexp">/^\.\.\//</span>, config.root);</span><br><span class="line">          <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">const</span> srcArray = src.split(<span class="string">'/'</span>).filter(<span class="function">(<span class="params">elem</span>) =&gt;</span> elem &amp;&amp; elem != <span class="string">'.'</span>);</span><br><span class="line">            <span class="keyword">if</span>(srcArray.length &gt; <span class="number">1</span>) srcArray.shift();</span><br><span class="line">            src = config.root + link + srcArray.join(<span class="string">'/'</span>);</span><br><span class="line">          }</span><br><span class="line">          $(<span class="keyword">this</span>).attr(srcAttr, src);</span><br><span class="line">          <span class="built_in">console</span>.info&amp;&amp;<span class="built_in">console</span>.info(<span class="string">`update <span class="subst">${srcAttr}</span> link to:<span class="subst">${$(<span class="keyword">this</span>).attr(srcAttr)}</span>`</span>);</span><br><span class="line">        })</span><br><span class="line">      });</span><br><span class="line">      data[key] = $.html();</span><br><span class="line">    });</span><br><span class="line">  }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<p>ä»£ç å¾ˆç®€å•ï¼Œåˆ†æˆäº†ä¸‰ç§æƒ…å†µï¼š</p>
<ul>
<li><code>http://</code>æˆ–è€…<code>//</code>å¼€å¤´çš„æ˜¯å®Œæ•´çš„urlåœ°å€ï¼Œä¸ç”¨æ”¹</li>
<li><code>../</code>å¼€å¤´çš„ä¼šå®šä½åˆ°ä¸Šä¸€çº§ç›®å½•ï¼Œä¹Ÿå°±æ˜¯<code>source</code>æ–‡ä»¶å¤¹ï¼Œæ›¿æ¢ä¸º<code>config.root</code></li>
<li>å…¶ä»–çš„å…¨è®¤ä¸ºæ˜¯ç›¸å¯¹å½“å‰æ–‡ä»¶çš„åœ°å€ï¼Œç”¨å¸–å­è·¯å¾„å»æ›¿æ¢å’Œæ ‡é¢˜ç›¸åŒçš„ç¬¬ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œ</li>
</ul>
<p>è¦æ³¨æ„çš„æ˜¯å¦‚æœå¼€äº†<code>NexT</code>ä¸»é¢˜çš„<code>lazyload</code>ï¼Œ<code>content</code>é‡Œ<code>&amp;lt;img&amp;gt;</code>çš„<code>src</code>ä¼šå˜æˆ<code>data-src</code>ï¼Œå› æ­¤è¦åŒæ—¶æ£€æŸ¥<code>data-src</code>å±æ€§ã€‚</p>
</body></html>]]></content>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>å½“å¿«é€Ÿæ»šåŠ¨é‡ä¸ŠåµŒå¥—æ»‘åŠ¨</title>
    <url>/ekibook/2020/04/07/fastscrollview/</url>
    <content><![CDATA[<html><head></head><body><p>å¸–å­é¡µé¢ç”¨<a href="https://github.com/timusus/RecyclerView-FastScroll" target="_blank" rel="noopener">RecyclerView-FastScroll</a>æ¥ç»™<code>RecyclerView</code>åŠ ä¸Šå¿«é€Ÿæ»šåŠ¨çš„æ»‘å—ï¼ŒåŒæ—¶ï¼Œä¸ºäº†ç»Ÿä¸€å¸ƒå±€é£æ ¼ï¼Œæ ‡é¢˜ç”¨äº†<code>CollapsingToolbarLayout</code>ï¼Œå’Œ<code>RecyclerView</code>æœ‰åµŒå¥—æ»‘åŠ¨ã€‚éœ€è¦åœ¨å…³è”æ»šåŠ¨çš„åŒæ—¶ä¿æŒæ»‘å—çš„ä½ç½®ï¼Œè½®å­å¹¶æ²¡æœ‰è€ƒè™‘åˆ°è¿™ä¸ªé—®é¢˜ï¼Œé‚£ä¹ˆé­”æ”¹å¼€å§‹ã€‚</p>
<a id="more"></a>

<p>å…ˆæ¥çœ‹æ•ˆæœï¼š</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2020/04/07/fastscrollview/prev.gif" alt="prev"></p>
<p>ç”»ä¸ªç¤ºæ„å›¾ï¼š</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2020/04/07/fastscrollview/fig1.gif" alt="fig1"></p>
<p>é¦–å…ˆï¼Œé€šè¿‡ä¸¤ä¸ªå›è°ƒå‡½æ•°è·å–å…³è”æ»šåŠ¨çš„é«˜åº¦å’Œå…³è”æ»šåŠ¨çš„è·ç¦»</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> nestedScrollRange = { <span class="number">0</span> }    <span class="comment">// å…³è”æ»šåŠ¨çš„é«˜åº¦</span></span><br><span class="line"><span class="keyword">var</span> nestedScrollDistance = { <span class="number">0</span> } <span class="comment">// å…³è”æ»šåŠ¨çš„è·ç¦»</span></span><br></pre></td></tr></tbody></table></figure>

<p>æŠŠå…³è”æ»šåŠ¨é«˜åº¦çœ‹ä½œä¸€ä¸ªé¢å¤–çš„å­é¡¹ï¼Œæœ‰ï¼š<br><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -8.483ex" xmlns="http://www.w3.org/2000/svg" width="56.3ex" height="18.097ex" role="img" focusable="false" viewBox="0 -4249.5 24884.8 7999"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mtable"><g data-mml-node="mtr" transform="translate(0, 3299.5)"><g data-mml-node="mtd" transform="translate(2700, 0)"><g data-mml-node="mo"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ€»</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">é«˜</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åº¦</text></g></g><g data-mml-node="mtd" transform="translate(5400, 0)"><g data-mml-node="mi"></g><g data-mml-node="mo" transform="translate(277.8, 0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><text data-variant="normal" transform="translate(778, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å…³</text><text data-variant="normal" transform="translate(1678, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">è”</text><text data-variant="normal" transform="translate(2578, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»š</text><text data-variant="normal" transform="translate(3478, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŠ¨</text><text data-variant="normal" transform="translate(4378, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">é«˜</text><text data-variant="normal" transform="translate(5278, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åº¦</text></g><g data-mml-node="mo" transform="translate(6733.6, 0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mo" transform="translate(7678.2, 0)"><path data-c="2211" d="M60 948Q63 950 665 950H1267L1325 815Q1384 677 1388 669H1348L1341 683Q1320 724 1285 761Q1235 809 1174 838T1033 881T882 898T699 902H574H543H251L259 891Q722 258 724 252Q725 250 724 246Q721 243 460 -56L196 -356Q196 -357 407 -357Q459 -357 548 -357T676 -358Q812 -358 896 -353T1063 -332T1204 -283T1307 -196Q1328 -170 1348 -124H1388Q1388 -125 1381 -145T1356 -210T1325 -294L1267 -449L666 -450Q64 -450 61 -448Q55 -446 55 -439Q55 -437 57 -433L590 177Q590 178 557 222T452 366T322 544L56 909L55 924Q55 945 60 948Z"></path></g><g data-mml-node="mo" transform="translate(9400, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å­</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">é¡¹</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">é«˜</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åº¦</text></g></g></g><g data-mml-node="mtr" transform="translate(0, 1799.5)"><g data-mml-node="mtd"><g data-mml-node="mo"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»‘</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å—</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ˜¾</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç¤º</text><text data-variant="normal" transform="translate(3600, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">èŒƒ</text><text data-variant="normal" transform="translate(4500, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å›´</text></g></g><g data-mml-node="mtd" transform="translate(5400, 0)"><g data-mml-node="mi"></g><g data-mml-node="mo" transform="translate(277.8, 0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><text data-variant="normal" transform="translate(778, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å®¹</text><text data-variant="normal" transform="translate(1678, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å™¨</text><text data-variant="normal" transform="translate(2578, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">é«˜</text><text data-variant="normal" transform="translate(3478, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åº¦</text></g><g data-mml-node="mo" transform="translate(4933.6, 0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mo" transform="translate(5989.3, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ä¸Š</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ä¸‹</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">è¾¹</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">è·</text></g><g data-mml-node="mo" transform="translate(9867.1, 0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mo" transform="translate(10922.9, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å…³</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">è”</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»š</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŠ¨</text><text data-variant="normal" transform="translate(3600, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">é«˜</text><text data-variant="normal" transform="translate(4500, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åº¦</text></g></g></g><g data-mml-node="mtr" transform="translate(0, -200)"><g data-mml-node="mtd" transform="translate(1800, 0)"><g data-mml-node="mo"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»‘</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å—</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">é«˜</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åº¦</text></g></g><g data-mml-node="mtd" transform="translate(5400, 0)"><g data-mml-node="mi"></g><g data-mml-node="mo" transform="translate(277.8, 0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mo" transform="translate(1333.6, 0)"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"></path><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833, 0)"></path><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333, 0)"></path></g><g data-mml-node="mrow" transform="translate(3194.6, 0)"><g data-mml-node="mo"><path data-c="28" d="M701 -940Q701 -943 695 -949H664Q662 -947 636 -922T591 -879T537 -818T475 -737T412 -636T350 -511T295 -362T250 -186T221 17T209 251Q209 962 573 1361Q596 1386 616 1405T649 1437T664 1450H695Q701 1444 701 1441Q701 1436 681 1415T629 1356T557 1261T476 1118T400 927T340 675T308 359Q306 321 306 250Q306 -139 400 -430T690 -924Q701 -936 701 -940Z"></path></g><g data-mml-node="mfrac" transform="translate(736, 0)"><g data-mml-node="mrow" transform="translate(220, 676)"><g data-mml-node="mo"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å®¹</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å™¨</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">é«˜</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åº¦</text></g><g data-mml-node="mo" transform="translate(3877.8, 0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mo" transform="translate(4933.6, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»š</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŠ¨</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">è·</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç¦»</text></g></g><g data-mml-node="mrow" transform="translate(3136.8, -710)"><g data-mml-node="mo"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ€»</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">é«˜</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åº¦</text></g></g><rect width="8733.6" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(9709.6, 0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mo" transform="translate(10154.2, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æœ€</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å°</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»‘</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å—</text><text data-variant="normal" transform="translate(3600, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">é«˜</text><text data-variant="normal" transform="translate(4500, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åº¦</text></g><g data-mml-node="mo" transform="translate(15554.2, 0)"><path data-c="29" d="M34 1438Q34 1446 37 1448T50 1450H56H71Q73 1448 99 1423T144 1380T198 1319T260 1238T323 1137T385 1013T440 864T485 688T514 485T526 251Q526 134 519 53Q472 -519 162 -860Q139 -885 119 -904T86 -936T71 -949H56Q43 -949 39 -947T34 -937Q88 -883 140 -813Q428 -430 428 251Q428 453 402 628T338 922T245 1146T145 1309T46 1425Q44 1427 42 1429T39 1433T36 1436L34 1438Z"></path></g></g></g></g><g data-mml-node="mtr" transform="translate(0, -2199.5)"><g data-mml-node="mtd" transform="translate(900, 0)"><g data-mml-node="mo"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å¯</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»š</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŠ¨</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">è·</text><text data-variant="normal" transform="translate(3600, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç¦»</text></g></g><g data-mml-node="mtd" transform="translate(5400, 0)"><g data-mml-node="mi"></g><g data-mml-node="mo" transform="translate(277.8, 0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><text data-variant="normal" transform="translate(778, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ€»</text><text data-variant="normal" transform="translate(1678, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">é«˜</text><text data-variant="normal" transform="translate(2578, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åº¦</text></g><g data-mml-node="mo" transform="translate(4033.6, 0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mo" transform="translate(5089.3, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å®¹</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å™¨</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">é«˜</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åº¦</text></g><g data-mml-node="mo" transform="translate(8967.1, 0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mo" transform="translate(10022.9, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ä¸Š</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ä¸‹</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">è¾¹</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">è·</text></g></g></g><g data-mml-node="mtr" transform="translate(0, -3499.5)"><g data-mml-node="mtd"><g data-mml-node="mo"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»‘</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å—</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç§»</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŠ¨</text><text data-variant="normal" transform="translate(3600, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">èŒƒ</text><text data-variant="normal" transform="translate(4500, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å›´</text></g></g><g data-mml-node="mtd" transform="translate(5400, 0)"><g data-mml-node="mi"></g><g data-mml-node="mo" transform="translate(277.8, 0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><text data-variant="normal" transform="translate(778, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»‘</text><text data-variant="normal" transform="translate(1678, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å—</text><text data-variant="normal" transform="translate(2578, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ˜¾</text><text data-variant="normal" transform="translate(3478, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç¤º</text><text data-variant="normal" transform="translate(4378, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">èŒƒ</text><text data-variant="normal" transform="translate(5278, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å›´</text></g><g data-mml-node="mo" transform="translate(6733.6, 0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mo" transform="translate(7789.3, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»‘</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å—</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">é«˜</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åº¦</text></g></g></g></g></g></g></svg></mjx-container></p>
<p>åœ¨<code>FastScrollRecyclerView.onUpdateScrollbar</code>é‡Œè®¡ç®—å½“å‰æ»‘å—ä½ç½®ï¼š<br><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -2.059ex" xmlns="http://www.w3.org/2000/svg" width="79.455ex" height="5.285ex" role="img" focusable="false" viewBox="0 -1426 35119.1 2336"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mo"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»‘</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å—</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ä½</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç½®</text><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z" transform="translate(3600, 0)"></path></g><g data-mml-node="mo" transform="translate(4655.8, 0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mo" transform="translate(5044.8, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å…³</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">è”</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»š</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŠ¨</text><text data-variant="normal" transform="translate(3600, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">è·</text><text data-variant="normal" transform="translate(4500, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç¦»</text></g><g data-mml-node="mo" transform="translate(10722.6, 0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mo" transform="translate(11778.3, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å­</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">é¡¹</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»š</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŠ¨</text><text data-variant="normal" transform="translate(3600, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">è·</text><text data-variant="normal" transform="translate(4500, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç¦»</text></g><g data-mml-node="mo" transform="translate(17178.3, 0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(17789.6, 0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mfrac" transform="translate(18789.8, 0)"><g data-mml-node="mrow" transform="translate(220, 676)"><g data-mml-node="mo"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»‘</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å—</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç§»</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŠ¨</text><text data-variant="normal" transform="translate(3600, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">èŒƒ</text><text data-variant="normal" transform="translate(4500, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å›´</text></g></g><g data-mml-node="mrow" transform="translate(670, -710)"><g data-mml-node="mo"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å¯</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»š</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŠ¨</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">è·</text><text data-variant="normal" transform="translate(3600, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç¦»</text></g></g><rect width="5600" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(24629.8, 0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mo" transform="translate(25685.6, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å…³</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">è”</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»š</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŠ¨</text><text data-variant="normal" transform="translate(3600, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">è·</text><text data-variant="normal" transform="translate(4500, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç¦»</text></g><g data-mml-node="mo" transform="translate(31363.3, 0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mo" transform="translate(32419.1, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ä¸Š</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">è¾¹</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">è·</text></g></g></g></svg></mjx-container><br>ç”±äºå¤šäº†åµŒå¥—æ»‘åŠ¨çš„è·ç¦»ï¼Œ<code>touchFraction</code>å°±ä¸èƒ½ç”±<code>FastScroller</code>ç®—å‡ºæ¥ï¼Œç›´æ¥ä¼ æ»‘å—ä½ç½®ï¼š</p>
<figure class="highlight diff"><table><tbody><tr><td class="code"><pre><span class="line">if (mIsDragging) {</span><br><span class="line">    if (mLastY == 0 || Math.abs(mLastY - y) &gt;= mTouchSlop) {</span><br><span class="line">        mLastY = y;</span><br><span class="line">        // Update the fastscroller section name at this touch position</span><br><span class="line"><span class="deletion">-        boolean layoutManagerReversed = mRecyclerView.isLayoutManagerReversed();</span></span><br><span class="line"><span class="deletion">-        int bottom = mRecyclerView.getHeight() - mThumbHeight;</span></span><br><span class="line"><span class="deletion">-        float boundedY = (float) Math.max(0, Math.min(bottom, y - mTouchOffset));</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="deletion">-        // Represents the amount the thumb has scrolled divided by its total scroll range</span></span><br><span class="line"><span class="deletion">-        float touchFraction = boundedY / bottom;</span></span><br><span class="line"><span class="deletion">-        if (layoutManagerReversed) {</span></span><br><span class="line"><span class="deletion">-            touchFraction = 1 - touchFraction;</span></span><br><span class="line"><span class="deletion">-        }</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="deletion">-        String sectionName = mRecyclerView.scrollToPositionAtProgress(touchFraction);</span></span><br><span class="line"><span class="addition">+        String sectionName = mRecyclerView.scrollToPositionAtProgress(y - mTouchOffset);</span></span><br><span class="line">        mPopup.setSectionName(sectionName);</span><br><span class="line">        mPopup.animateVisibility(!sectionName.isEmpty());</span><br><span class="line">        mRecyclerView.invalidate(mPopup.updateFastScrollerBounds(mRecyclerView, mThumbPosition.y));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>åœ¨<code>FastScrollRecyclerView.scrollToPositionAtProgress</code>é‡Œä¸å½“å‰æ»‘å—ä½ç½®ç›¸å‡å¾—æ»šåŠ¨ä½ç§»ï¼š</p>
<p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -2.059ex" xmlns="http://www.w3.org/2000/svg" width="53.687ex" height="5.285ex" role="img" focusable="false" viewBox="0 -1426 23729.8 2336"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mo"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»š</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŠ¨</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ä½</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç§»</text><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z" transform="translate(3600, 0)"></path></g><g data-mml-node="mo" transform="translate(4655.8, 0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mo" transform="translate(5044.8, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å½“</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å‰</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»‘</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å—</text><text data-variant="normal" transform="translate(3600, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ä½</text><text data-variant="normal" transform="translate(4500, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç½®</text></g><g data-mml-node="mo" transform="translate(10722.6, 0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mo" transform="translate(11778.3, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŸ</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»‘</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å—</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ä½</text><text data-variant="normal" transform="translate(3600, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç½®</text></g><g data-mml-node="mo" transform="translate(16278.3, 0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(16889.6, 0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mfrac" transform="translate(17889.8, 0)"><g data-mml-node="mrow" transform="translate(670, 676)"><g data-mml-node="mo"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å¯</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»š</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŠ¨</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">è·</text><text data-variant="normal" transform="translate(3600, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç¦»</text></g></g><g data-mml-node="mrow" transform="translate(220, -710)"><g data-mml-node="mo"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»‘</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å—</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç§»</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŠ¨</text><text data-variant="normal" transform="translate(3600, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">èŒƒ</text><text data-variant="normal" transform="translate(4500, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å›´</text></g></g><rect width="5600" height="60" x="120" y="220"></rect></g></g></g></svg></mjx-container><br>ç„¶åæ¨¡æ‹Ÿå…³è”æ»šåŠ¨ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line">startNestedScroll(ViewCompat.SCROLL_AXIS_VERTICAL)</span><br><span class="line"><span class="keyword">val</span> consumed = IntArray(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">val</span> offsetInWindow = IntArray(<span class="number">2</span>)</span><br><span class="line">dispatchNestedPreScroll(<span class="number">0</span>, dy.roundToInt(), consumed, offsetInWindow)</span><br><span class="line">dy -= consumed[<span class="number">1</span>].toFloat()</span><br><span class="line"><span class="keyword">val</span> scrollY = Math.min(Math.max(scrolledPastHeight + dy, <span class="number">0f</span>), availableScrollHeight.toFloat())</span><br><span class="line">dy -= scrollY - scrolledPastHeight</span><br><span class="line">dispatchNestedScroll(</span><br><span class="line">    consumed[<span class="number">0</span>],</span><br><span class="line">    consumed[<span class="number">1</span>],</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    Math.max(-nestedDistance + consumed[<span class="number">1</span>], dy.roundToInt()),</span><br><span class="line">    offsetInWindow</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

<p>è¿™é‡Œç”¨<code>scrollY</code>å…ˆé¢„æµ‹äº†<code>RecyclerView</code>æ‰€èƒ½æ¶ˆè€—çš„æ»šåŠ¨è·ç¦»ï¼Œå†ä»é«˜åº¦ç¼“å­˜ä¸­æ‰¾åˆ°å¯¹åº”çš„å­é¡¹ï¼Œè°ƒç”¨<code>LayoutManager.scrollToPositionWithOffset</code>æ»šåˆ°å¯¹åº”ä½ç½®ï¼Œå¹¶è¿”å›å…¶æ ‡é¢˜ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> layoutManager = layoutManager</span><br><span class="line"><span class="keyword">val</span> adapter = adapter</span><br><span class="line"><span class="keyword">var</span> totalOffset = <span class="number">0</span></span><br><span class="line">itemHeightCache.forEachIndexed { index, height -&gt;</span><br><span class="line">    <span class="keyword">if</span> (scrollY &gt;= totalOffset &amp;&amp; scrollY &lt;= totalOffset + height) {</span><br><span class="line">        <span class="keyword">val</span> wrapIndex = getAdapterItemIndex(index)</span><br><span class="line">        <span class="keyword">if</span> (layoutManager <span class="keyword">is</span> LinearLayoutManager)</span><br><span class="line">            layoutManager.scrollToPositionWithOffset(wrapIndex, totalOffset - scrollY.roundToInt())</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (adapter <span class="keyword">is</span> MeasurableAdapter &amp;&amp; layoutManager <span class="keyword">is</span> StaggeredGridLayoutManager)</span><br><span class="line">            layoutManager.scrollToPositionWithOffset(wrapIndex, totalOffset - scrollY.roundToInt())</span><br><span class="line">        <span class="keyword">val</span> sectionedAdapter = (adapter <span class="keyword">as</span>? SectionedAdapter) ?: <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">        <span class="keyword">return</span> sectionedAdapter.getSectionName(wrapIndex)</span><br><span class="line">    }</span><br><span class="line">    totalOffset += height</span><br><span class="line">}</span><br><span class="line"><span class="keyword">return</span> <span class="string">""</span></span><br></pre></td></tr></tbody></table></figure>

<p><a href="https://github.com/ekibun/Bangumi/blob/master/app/src/main/java/soko/ekibun/bangumi/ui/view/FastScrollRecyclerView.kt" target="_blank" rel="noopener">å®Œæ•´ä»£ç ä¼ é€é—¨</a></p>
</body></html>]]></content>
      <tags>
        <tag>android</tag>
      </tags>
  </entry>
  <entry>
    <title>åœ¨kotlin multiplatformé‡Œä½¿ç”¨jni</title>
    <url>/ekibook/2021/03/17/kmp-with-jni/</url>
    <content><![CDATA[<html><head></head><body><p>æŠ˜è…¾äº†å°åŠå¹´flutterï¼Œæ„Ÿè§‰è¿˜æ˜¯kotlinå†™çš„èˆ’æœï¼Œå¬è¯´jbå…¬å¸çš„composeèƒ½åœ¨æ¡Œé¢ç«¯è·‘äº†ï¼Œå°±ä¸‹äº†demoè¯•äº†ä¸‹ï¼Œæ— å¥ˆæ¡Œé¢ç«¯ä¸èƒ½åƒandroidä¸€æ ·ç¼–è¯‘jniåº“ã€‚ç™¾åº¦äº†åŠå¤©ï¼Œåªæœ‰<a href="https://medium.com/kodein-koders/native-dependency-in-kotlin-multiplatform-part-2-jni-for-jvm-android-c7a2a44898ad" target="_blank" rel="noopener">è¿™ä¸ªæ•™ç¨‹</a>èƒ½ç”¨ï¼Œä½†ä»£ç å¹¶ä¸å…¨ï¼Œè¦æ”¹æ”¹æ‰èƒ½ç”¨ã€‚</p>
<a id="more"></a>

<h4 id="æ¡Œé¢ç«¯"><a href="#æ¡Œé¢ç«¯" class="headerlink" title="æ¡Œé¢ç«¯"></a>æ¡Œé¢ç«¯</h4><p>é¦–å…ˆæ•´ä¸ªcmdç¼–è¯‘C++ï¼Œåœ¨gradleé‡Œè¿è¡Œshellå‘½ä»¤ä¹Ÿå¤ªéº»çƒ¦äº†ï¼š</p>
<figure class="highlight bat"><table><tbody><tr><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> "C:\Program Files (x86)\Microsoft Visual Studio\<span class="number">2019</span>\BuildTools\VC\Auxiliary\Build\vcvarsall.bat" x64</span><br><span class="line"><span class="built_in">set</span> BUILD_DIR=./.cxx</span><br><span class="line">cmake -S %~dp0/../cxx -B <span class="variable">%BUILD_DIR%</span></span><br><span class="line">cmake --build <span class="variable">%BUILD_DIR%</span> --config Release</span><br></pre></td></tr></tbody></table></figure>

<p>æ¥ä¸‹æ¥åœ¨gradleé‡Œæ•´ä¸ªtaskè°ƒç”¨è¿™ä¸ªcmdï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line">tasks.create&lt;Exec&gt;(<span class="string">"buildJniNativeWindows"</span>) {</span><br><span class="line">  group = <span class="string">"build"</span></span><br><span class="line"></span><br><span class="line">  inputs.dir(rootDir.resolve(<span class="string">"cxx"</span>))</span><br><span class="line">  outputs.dir(projectDir.resolve(<span class="string">".cxx/Release"</span>))</span><br><span class="line"></span><br><span class="line">  workingDir(projectDir)</span><br><span class="line">  executable = <span class="string">"cmd"</span></span><br><span class="line">  args(<span class="string">"/C"</span>, <span class="string">"build-windows.cmd"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ç„¶ååœ¨jvmç¼–è¯‘çš„æ—¶å€™è°ƒç”¨ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line">kotlin {</span><br><span class="line">  jvm {</span><br><span class="line">    withJava()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> processResources = compilations[<span class="string">"main"</span>].processResourcesTaskName</span><br><span class="line">    (tasks[processResources] <span class="keyword">as</span> ProcessResources).apply {</span><br><span class="line">        onlyIf { currentOs.isWindows }</span><br><span class="line">        dependsOn(<span class="string">"buildJniNativeWindows"</span>)</span><br><span class="line">        from(projectDir.resolve(<span class="string">".cxx/Release"</span>))</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  ...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å‹æ ¹æ²¡çœ‹æ‡‚ã€‚è°ƒäº†åŠå¤©ç®—æ˜¯çŒœåˆ°äº†<code>.cxx/Release</code>æ˜¯C++çš„dllç”Ÿæˆçš„ä½ç½®ï¼Œgradleä¼šæŠŠè¿™ä¸ªæ–‡ä»¶å¤¹çš„æ–‡ä»¶å…¨æ‹·è´åˆ°èµ„æºæ–‡ä»¶é‡Œé¢ã€‚</p>
<p>ä½†æ˜¯èµ„æºæ–‡ä»¶é‡Œçš„dllå¹¶ä¸èƒ½è¢«<code>System.loadLibrary()</code>è°ƒç”¨ï¼Œæ‰€ä»¥è¿˜å¾—åœ¨æ¡Œé¢ç«¯å®ç°ä»èµ„æºæ–‡ä»¶åŠ è½½dllçš„ä»£ç ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">actual</span> <span class="function"><span class="keyword">fun</span> <span class="title">jniLoadLibrary</span><span class="params">(name: <span class="type">String</span>)</span></span> {</span><br><span class="line">  <span class="keyword">val</span> fname = name + <span class="string">".dll"</span></span><br><span class="line">  <span class="keyword">val</span> ins = <span class="keyword">object</span> {}::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>.<span class="title">getResourceAsStream</span></span>(fname)</span><br><span class="line">  <span class="keyword">val</span> file = java.io.File(System.getProperty(<span class="string">"java.io.tmpdir"</span>) + <span class="string">"/"</span> + fname)</span><br><span class="line">  <span class="keyword">val</span> fos = file.outputStream()</span><br><span class="line">  ins.copyTo(fos)</span><br><span class="line">  ins.close()</span><br><span class="line">  fos.close()</span><br><span class="line">  System.load(file.toString())</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è€Œå¯¹åº”çš„androidç«¯ä»£ç å°±ç›´æ¥ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">actual</span> <span class="function"><span class="keyword">fun</span> <span class="title">jniLoadLibrary</span><span class="params">(name: <span class="type">String</span>)</span></span> {</span><br><span class="line">  System.loadLibrary(name)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="å®‰å“ç«¯"><a href="#å®‰å“ç«¯" class="headerlink" title="å®‰å“ç«¯"></a>å®‰å“ç«¯</h4><p>å®‰å“ç«¯å°±ç®€å•äº†ï¼Œç›´æ¥åœ¨gradleé‡ŒåŠ ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line">android {</span><br><span class="line">  ...</span><br><span class="line">  externalNativeBuild {</span><br><span class="line">    cmake {</span><br><span class="line">      setPath(<span class="string">"<span class="variable">$rootDir</span>/cxx/CMakeLists.txt"</span>)</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></body></html>]]></content>
      <tags>
        <tag>kotlin multiplatform</tag>
        <tag>jetbran compose</tag>
        <tag>jni</tag>
      </tags>
  </entry>
  <entry>
    <title>ç®€é™‹Androidæ’ä»¶åŒ–æ–¹æ¡ˆï¼ˆäºŒï¼‰æ’ä»¶å¹³å°</title>
    <url>/ekibook/2020/04/03/pluginplatform/</url>
    <content><![CDATA[<html><head></head><body><p>æ¥ä¸Šä¸€ç« ï¼Œæ—¢ç„¶è¦ææ’ä»¶ï¼Œé‚£å°±å¯ä»¥ä¸æ­¢ä¸€ä¸ªã€‚å‚è€ƒäº†ä¸€ä¸‹Nevolutionçš„sdkï¼Œå¯ä»¥åœ¨manifeståŠ ä¸ªserviceæŠŠæ’ä»¶ç±»æš´éœ²ç»™å®¿ä¸»ã€‚</p>
<a id="more"></a>

<p>é¦–å…ˆæ˜¯åœ¨<code>AndroidManifest.xml</code>ä¸Šæ³¨å†Œä¸€ä¸ªserviceï¼š</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">".Plugin"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:exported</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:ignore</span>=<span class="string">"ExportedService"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"soko.ekibun.bangumi.plugins"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p><code>Plugin</code>ç±»ç»§æ‰¿<code>Service</code>ï¼Œä½†å¹¶ä¸ç”¨æœåŠ¡çš„åŠŸèƒ½ï¼Œå’ŒåŸæ¥ä¸€æ ·ï¼Œç•™ä¸€ä¸ª<code>setupPlugin</code>ç»™å®¿ä¸»è°ƒç”¨ã€‚</p>
<p>å®¿ä¸»ä¸­é€šè¿‡<code>PackageManager.queryIntentServices</code>æ¥è·å–æ’ä»¶åˆ—è¡¨</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">createPluginInstance</span><span class="params">(context: <span class="type">Context</span>)</span></span>: Map&lt;Context, Any&gt; {</span><br><span class="line">    <span class="keyword">return</span> context.packageManager.queryIntentServices(</span><br><span class="line">        Intent(<span class="string">"soko.ekibun.bangumi.plugins"</span>), <span class="number">0</span></span><br><span class="line">    ).distinctBy { it.serviceInfo.packageName }.mapNotNull {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">val</span> pluginContext = context.createPackageContext(</span><br><span class="line">                it.serviceInfo.packageName,</span><br><span class="line">                Context.CONTEXT_IGNORE_SECURITY or Context.CONTEXT_INCLUDE_CODE</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">val</span> pluginClass = pluginContext.classLoader.loadClass(it.serviceInfo.name)</span><br><span class="line">            pluginContext to pluginClass.getDeclaredConstructor().let {</span><br><span class="line">                it.isAccessible = <span class="literal">true</span></span><br><span class="line">                it.newInstance()</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (e: Exception) {</span><br><span class="line">            e.printStackTrace()</span><br><span class="line">            <span class="literal">null</span></span><br><span class="line">        }</span><br><span class="line">    }.toMap()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>åœ¨<code>PreferenceFragmentCompat.onBindPreferences</code>é‡Œæ˜¾ç¤ºæ’ä»¶åˆ—è¡¨ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBindPreferences</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">super</span>.onBindPreferences()</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.preferenceScreen.key == <span class="string">"pref_plugin"</span>) {</span><br><span class="line">        <span class="keyword">val</span> cat = findPreference&lt;PreferenceCategory&gt;(<span class="string">"pref_plugin_list"</span>) ?: <span class="keyword">return</span></span><br><span class="line">        cat.removeAll()</span><br><span class="line">        App.<span class="keyword">get</span>(context!!).pluginInstance.forEach { plugin -&gt;</span><br><span class="line">            cat.addPreference(PluginPreference(context, plugin))</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>PluginPreference</code>ç»§æ‰¿<code>SwitchPreference</code>åŠ ä¸Šäº†ä¸€ä¸ªè®¾ç½®æŒ‰é’®ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PluginPreference</span></span>(context: Context?, <span class="keyword">private</span> <span class="keyword">val</span> plugin: Map.Entry&lt;Context, Any&gt;) : SwitchPreference(context) {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> {</span><br><span class="line">        <span class="keyword">val</span> appInfo = plugin.key.applicationInfo</span><br><span class="line">        key = <span class="string">"use_plugin_<span class="subst">${plugin.key.packageName}</span>"</span></span><br><span class="line">        title = plugin.key.getString(appInfo.labelRes)</span><br><span class="line">        icon = plugin.key.applicationInfo.loadIcon(plugin.key.packageManager)</span><br><span class="line">        summary = plugin.key.packageName</span><br><span class="line">        setDefaultValue(<span class="literal">true</span>)</span><br><span class="line">        widgetLayoutResource = R.layout.pref_plugin_widget</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBindViewHolder</span><span class="params">(holder: <span class="type">PreferenceViewHolder</span>)</span></span> {</span><br><span class="line">        <span class="keyword">super</span>.onBindViewHolder(holder)</span><br><span class="line">        holder.itemView.item_settings.setOnClickListener {</span><br><span class="line">            showPreference()</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">showPreference</span><span class="params">()</span></span> {</span><br><span class="line">        context.startActivity(</span><br><span class="line">            Intent.createChooser(</span><br><span class="line">                Intent(<span class="string">"soko.ekibun.bangumi.plugins.setting"</span>).setPackage(plugin.key.packageName),</span><br><span class="line">                plugin.key.packageName</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è¦æ³¨æ„çš„æ˜¯æ’ä»¶çš„<code>Activity</code>å¦‚æœä¸æŠŠ<code>category</code>è®¾ç½®æˆ<code>DEFAULT</code>ï¼Œå®¿ä¸»æ²¡åŠæ³•éšå¼è°ƒç”¨ï¼š</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:name</span>=<span class="string">".ui.setting.SettingsActivity"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">"@string/settings"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:exported</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"soko.ekibun.bangumi.plugins.setting"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure></body></html>]]></content>
      <tags>
        <tag>android</tag>
      </tags>
  </entry>
  <entry>
    <title>ç”¨ OpenCV è¿›è¡Œæˆªå›¾æ‹¼æ¥</title>
    <url>/ekibook/2021/08/04/opencv-stitch/</url>
    <content><![CDATA[<html><head></head><body><p>æˆªå›¾æ‹¼æ¥çš„éœ€æ±‚å¾ˆå¤šï¼Œå››å¹´å‰å†™çš„æ‹¼å›¾è½¯ä»¶å‡ºé”™æ¦‚ç‡å¤ªé«˜ï¼Œå…¶ä»–çš„åŒç±»è½¯ä»¶ä¹Ÿéƒ½ä¸æ˜¯å¾ˆé¡ºæ‰‹ï¼Œç»ˆäºè¿˜æ˜¯æ¡èµ·äº†å››å¹´å‰çš„å‘ï¼ŒåŠ ä¸Šäº†æ‰‹åŠ¨ç¼–è¾‘ï¼Œå†ä¹Ÿä¸ç”¨æ‹…å¿ƒæ‹¼æ¥å‡ºé”™äº†ã€‚ä¸ºäº†å®ç°æ‹¼åœ°å›¾ï¼Œè¿™æ¬¡æ‹¼æ¥ç®—æ³•ç”¨ä¸Šäº†OpenCVï¼Œè®°å½•ä¸‹æ‘¸ç´¢è¿‡ç¨‹ã€‚</p>
<a id="more"></a>

<h4 id="Android-å·¥ç¨‹ä¸­å¯¼å…¥-OpenCV"><a href="#Android-å·¥ç¨‹ä¸­å¯¼å…¥-OpenCV" class="headerlink" title="Android å·¥ç¨‹ä¸­å¯¼å…¥ OpenCV"></a>Android å·¥ç¨‹ä¸­å¯¼å…¥ OpenCV</h4><p>æœ‰ä¸¤ç§æ–¹æ³•ï¼Œä½†éƒ½è¦ä¸‹ <a href="https://github.com/opencv/opencv/releases" target="_blank" rel="noopener">opencv-android-sdk.zip</a>ï¼Œè§£å‹å‡ºæ¥æ”¾åœ¨ç¨‹åºç›®å½•ï¼Œé‡Œé¢çš„<code>sdk</code>æ–‡ä»¶å¤¹æ˜¯ä¸€ä¸ªgradleé¡¹ç›®ï¼Œå¯ä»¥ç›´æ¥é‡Œå¯¼å…¥å·¥ç¨‹ï¼Œç„¶åå°±å¯ä»¥åœ¨javaä¸­è°ƒç”¨å‡½æ•°äº†ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ç§æ–¹æ³•ï¼Œè¦æ³¨æ„çš„æ˜¯ï¼Œç½‘ä¼ çš„<code>OpenCVLoader.initAsync</code>æ–¹æ³•å·²è¢«å¼ƒç”¨ï¼Œéœ€è¦ç›´æ¥ç”¨<code>System.loadLibrary("opencv_java4")</code>æˆ–<code>OpenCVLoader.initDebug()</code>ï¼Œ<code>build.gradle</code>çš„æ³¨é‡Šä¸Šå†™çš„å¾ˆè¯¦ç»†ã€‚</p>
<p>ç¬¬äºŒç§æ–¹æ³•æ˜¯é‡‡ç”¨jnié™æ€ç¼–è¯‘ï¼Œå¯ä»¥çœç‚¹ä½“ç§¯ï¼Œ<code>build.gradle</code>é‡ŒåŒæ ·æœ‰è¯¦ç»†çš„è¯´æ˜ï¼Œç½‘ä¸Šçš„æ–¹æ³•éƒ½è¿‡æ—¶äº†ï¼Œæ­£ç¡®æ–¹æ³•å¦‚ä¸‹ï¼Œä¸»è¦æ˜¯åé¢ä¸‰è¡Œï¼š</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.6)</span><br><span class="line"></span><br><span class="line">add_library(stitch SHARED stitch.cpp)</span><br><span class="line"></span><br><span class="line">set(OpenCV_DIR ${CMAKE_CURRENT_LIST_DIR}/../../../../opencv/sdk/native/jni)</span><br><span class="line">find_package(OpenCV REQUIRED)</span><br><span class="line">target_link_libraries(stitch ${OpenCV_LIBS} jnigraphics)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="æ‹¼æ¥ç®—æ³•"><a href="#æ‹¼æ¥ç®—æ³•" class="headerlink" title="æ‹¼æ¥ç®—æ³•"></a>æ‹¼æ¥ç®—æ³•</h4><p>ä¸»è¦å‚è€ƒäº†<a href="https://blog.csdn.net/hadkfhkdh/article/details/87972839" target="_blank" rel="noopener">è¿™ç¯‡åšå®¢</a>ï¼Œè€ƒè™‘åˆ°æˆªå›¾ä¸­å­˜åœ¨é¡¶éƒ¨å’Œåº•éƒ¨ç›¸åŒçš„é—®é¢˜ï¼Œå¯¹ç®—æ³•åšäº†ä¸€äº›è°ƒæ•´ï¼Œè¿™é‡Œä¹Ÿè®°å½•ä¸€ä¸‹ã€‚</p>
<p>é¦–å…ˆç›´æ¥å¯¹åŸå›¾æå–ç‰¹å¾ç‚¹ä¼šä½¿å¾—é¡¶éƒ¨å’Œåº•éƒ¨çš„ç›¸åŒåŒºåŸŸå‡ºç°å¾ˆå¼ºåŒ¹é…çš„å…³ç³»ï¼š</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2021/08/04/opencv-stitch/test0.jpg" alt=""></p>
<p>é¦–å…ˆæå–ä¸¤è€…çš„è¾¹ç•Œä¿¡æ¯å¹¶åšå·® (<code>cv.absdiff</code>)ï¼Œæ¶ˆé™¤é‡åˆéƒ¨åˆ†ï¼š</p>
<table>
<thead>
<tr>
<th><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2021/08/04/opencv-stitch/grad0.jpg" alt=""></th>
<th>-</th>
<th><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2021/08/04/opencv-stitch/grad1.jpg" alt=""></th>
<th>=</th>
<th><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2021/08/04/opencv-stitch/mask.jpg" alt=""></th>
</tr>
</thead>
</table>
<p>ç„¶åå¯¹ä¸¤å›¾å–äº¤ (<code>cv.bitwise_and</code>)ï¼š</p>
<table>
<thead>
<tr>
<th><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2021/08/04/opencv-stitch/mask.jpg" alt=""></th>
<th>&amp;</th>
<th><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2021/08/04/opencv-stitch/grad0.jpg" alt=""></th>
<th>=</th>
<th><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2021/08/04/opencv-stitch/diff0.jpg" alt=""></th>
</tr>
</thead>
<tbody><tr>
<td><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2021/08/04/opencv-stitch/mask.jpg" alt=""></td>
<td>&amp;</td>
<td><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2021/08/04/opencv-stitch/grad1.jpg" alt=""></td>
<td>=</td>
<td><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2021/08/04/opencv-stitch/diff1.jpg" alt=""></td>
</tr>
</tbody></table>
<p>çœ‹èµ·æ¥æ•ˆæœå¾ˆä¸é”™ï¼Œç”¨å®ƒæ¥æå–ç‰¹å¾ç‚¹å°±èƒ½å¾ˆå¥½åœ°æ¶ˆé™¤é‡åˆéƒ¨åˆ†ï¼š</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2021/08/04/opencv-stitch/test1.jpg" alt=""></p>
</body></html>]]></content>
      <tags>
        <tag>android</tag>
        <tag>jni</tag>
      </tags>
  </entry>
  <entry>
    <title>Rhinoä¸Androidçš„äº’æ“ä½œ</title>
    <url>/ekibook/2020/04/11/rhinojsonstringify/</url>
    <content><![CDATA[<html><head></head><body><p>Rhinoä½œä¸ºåŸºäºJavaçš„JavaScriptå®ç°ï¼Œå¯ä»¥æ–¹ä¾¿åœ°åœ¨Androidä¸­è¿è¡ŒJavaScriptè„šæœ¬ã€‚è¿™é‡Œè®°å½•ä¸€ä¸‹ç›¸äº’è°ƒç”¨çš„ä¸€äº›é—®é¢˜ã€‚</p>
<a id="more"></a>

<h4 id="JSONåºåˆ—åŒ–"><a href="#JSONåºåˆ—åŒ–" class="headerlink" title="JSONåºåˆ—åŒ–"></a>JSONåºåˆ—åŒ–</h4><p>ä¸ºäº†ä¾¿äºäº’æ“ä½œï¼ŒJavaScriptå’ŒJavaçš„æ•°æ®å‡ä»¥JSONå­—ç¬¦ä¸²è¿›è¡Œäº¤æ¢ã€‚è€ŒRhinoçš„<code>JSON.stringify</code>å’ŒJavaçš„æ•°æ®ç±»å‹ä¸å…¼å®¹ï¼Œå¯¹Javaç±»å‹çš„å˜é‡æ“ä½œä¼šå‡ºç°å¾ªç¯ï¼ŒåŒæ ·çš„ï¼Œç”¨äºåºåˆ—åŒ–Javaæ•°æ®ç±»å‹çš„Gsonåº“ä¹Ÿä¸æ”¯æŒRhinoçš„JavaScriptæ•°æ®ç±»å‹ã€‚</p>
<p>ä»¿ç…§è§£å†³<code>JSON.stringify</code>çš„æ–¹æ³•ï¼Œåˆ¤æ–­å˜é‡æ˜¯å¦ä¸ºJavaå¯¹è±¡ï¼Œæ˜¯åˆ™è°ƒç”¨Gsonè¿›è¡Œè½¬æ¢ï¼š</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleCircular</span>(<span class="params"></span>) </span>{</span><br><span class="line">   <span class="keyword">var</span> cache = []</span><br><span class="line">   <span class="keyword">var</span> keyCache = []</span><br><span class="line">   <span class="keyword">return</span> <span class="function">(<span class="params">key, value</span>) =&gt;</span> {</span><br><span class="line">       <span class="keyword">if</span>(value <span class="keyword">instanceof</span> Packages.java.lang.Object) {</span><br><span class="line">           <span class="keyword">return</span> <span class="built_in">JSON</span>.parse(Packages.${JsonUtil.javaClass.name}.INSTANCE.toJson(value));</span><br><span class="line">       }</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'object'</span> &amp;&amp; value !== <span class="literal">null</span>) {</span><br><span class="line">           <span class="keyword">var</span> index = cache.indexOf(value);</span><br><span class="line">           <span class="keyword">if</span> (index !== <span class="number">-1</span>) <span class="keyword">return</span> <span class="string">'[Circular '</span> + keyCache[index] + <span class="string">']'</span></span><br><span class="line">           cache.push(value)</span><br><span class="line">           keyCache.push(key || <span class="string">'root'</span>)</span><br><span class="line">       }</span><br><span class="line">       <span class="keyword">return</span> value</span><br><span class="line">   }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> tmp = <span class="built_in">JSON</span>.stringify;</span><br><span class="line"><span class="built_in">JSON</span>.stringify = <span class="function"><span class="keyword">function</span>(<span class="params">value, replacer, space</span>) </span>{  </span><br><span class="line">   replacer = replacer || handleCircular();</span><br><span class="line">   <span class="keyword">return</span> tmp(value, replacer, space);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="å¼‚æ­¥çº¿ç¨‹"><a href="#å¼‚æ­¥çº¿ç¨‹" class="headerlink" title="å¼‚æ­¥çº¿ç¨‹"></a>å¼‚æ­¥çº¿ç¨‹</h4><p>Rhinoæ²¡æœ‰å®ç°<code>async</code>å’Œ<code>await</code>ã€‚å€ŸåŠ©Javaçº¿ç¨‹æ± å®ç°å¼‚æ­¥ï¼Œå…ˆå†™ä¸ªå¸¦å‚æ•°çš„<code>Callable</code>ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JsAsyncTask</span></span>(<span class="keyword">val</span> js: (Any?) -&gt; Any?, <span class="keyword">private</span> <span class="keyword">val</span> params: Any?) : Callable&lt;Any?&gt; {</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">call</span><span class="params">()</span></span>: Any? {</span><br><span class="line">        <span class="keyword">return</span> js(params)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>async</code>è¿”å›é—­åŒ…å‡½æ•°ï¼Œåˆ›å»º<code>callable</code>ï¼ŒåŠ å…¥çº¿ç¨‹æ± å¹¶è¿”å›<code>Future</code>ï¼š</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> AsyncTask = Packages.${<span class="attr">JsAsyncTask</span>::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>.<span class="title">name</span>}</span>;</span><br><span class="line"><span class="keyword">var</span> _cachedThreadPool = Packages.${<span class="attr">App</span>::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>.<span class="title">name</span>}.<span class="title">Companion</span>.<span class="title">getCachedThreadPool</span>()</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">async</span>(<span class="params">fun</span>)</span>{</span><br><span class="line">   <span class="keyword">return</span> <span class="function">(<span class="params">param</span>)=&gt;</span>{</span><br><span class="line">       <span class="keyword">var</span> task = <span class="keyword">new</span> AsyncTask(<span class="function"><span class="keyword">function</span>(<span class="params">params</span>)</span>{ <span class="keyword">try</span> { <span class="keyword">return</span> <span class="built_in">JSON</span>.stringify(fun(params)) } <span class="keyword">catch</span>(e){ <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Error</span>(e) } }, param)</span><br><span class="line">       <span class="keyword">return</span> _cachedThreadPool.submit(task)</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ä¸ºäº†çœ‹èµ·æ¥åƒï¼Œå†åŒ…ä¸ª<code>await</code>ï¼ŒæŠŠ<code>async</code>é‡Œ<code>stringify</code>çš„è½¬å›æ¥ï¼š</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">await</span>(<span class="params">task</span>)</span>{</span><br><span class="line">   <span class="keyword">var</span> data = task.get()</span><br><span class="line">   <span class="keyword">if</span>(data <span class="keyword">instanceof</span> <span class="built_in">Error</span>) <span class="keyword">throw</span> data.message</span><br><span class="line">   <span class="keyword">return</span> <span class="built_in">JSON</span>.parse(data)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

</body></html>]]></content>
      <tags>
        <tag>android</tag>
      </tags>
  </entry>
  <entry>
    <title>æ¼«ç”»é˜…è¯»å™¨ï¼ˆä¸€ï¼‰é€ ä¸€ä¸ªå¯ä»¥ä¸Šä¸‹å·¦å³æ»‘åŠ¨åŠ è½½çš„å®¹å™¨</title>
    <url>/ekibook/2020/03/19/pullloadlayout/</url>
    <content><![CDATA[<html><head></head><body><p>æœ€è¿‘åœ¨ææ¼«ç”»é˜…è¯»å™¨ï¼Œé˜…è¯»å™¨æœ‰æ¨ªå‘ç¿»é¡µå’Œçºµå‘å·çº¸ä¸¤ç§æ¨¡å¼ï¼Œç„¶åè¦åœ¨æ¨ªå‘ç¿»é¡µæ¨¡å¼çš„æ—¶å€™ï¼Œèƒ½å¤Ÿåœ¨æœ€åä¸€é¡µå·¦æ»‘åŠ è½½ä¸‹ä¸€ç« ï¼Œåœ¨å·çº¸æ¨¡å¼çš„æ—¶å€™åˆèƒ½å¤Ÿåˆ°åº•æ—¶ä¸Šæ‹‰åŠ è½½ä¸‹ä¸€ç« ã€‚</p>
<a id="more"></a>

<p>å›½é™…æƒ¯ä¾‹å…ˆæ”¾æ•ˆæœï¼š</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2020/03/19/pullloadlayout/prev.gif" alt="prev"></p>
<p>ä¸€å¼€å§‹æ²¡ææ¨ªå‘ç¿»é¡µçš„æ—¶å€™ç”¨çš„æ˜¯<a href="https://github.com/TruthKeeper/AnythingPull" target="_blank" rel="noopener">AnythingPullLayout</a>ï¼Œæ•ˆæœè¿˜ä¸é”™ï¼Œé‚£ä¹ˆè½®å­å°±ä»¥è¿™ä¸ªä¸ºåŸºç¡€é€ ï¼Œæ²¿ç”¨å®ƒçš„å‘½åï¼Œä¸Šä¸€ç« çš„å«åˆ·æ–°ï¼Œä¸‹ä¸€ç« çš„å«åŠ è½½ã€‚</p>
<p>é¦–å…ˆçº¦å®šå­Viewåªæœ‰ä¸€ä¸ªï¼Œæ ¹æ®å­Viewçš„æ–¹å‘åˆ¤æ–­æ˜¯æ¨ªå‘è¿˜æ˜¯çºµå‘ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> contentView <span class="keyword">by</span> lazy { getChildAt(<span class="number">0</span>) }</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> isHorizontal <span class="keyword">get</span>() = ((contentView <span class="keyword">as</span> RecyclerView).layoutManager <span class="keyword">as</span> LinearLayoutManager).orientation == RecyclerView.HORIZONTAL</span><br></pre></td></tr></tbody></table></figure>

<p>ç„¶åéœ€è¦ä¸€ä¸ªå‚æ•°ä¿å­˜æ‹‰åŠ¨çš„è·ç¦»ï¼Œä¸€ä¸ªå‚æ•°ä¿å­˜æ˜¯å¦åŠ è½½çš„çŠ¶æ€ï¼Œçº¦å®šä¸èƒ½åŒæ—¶æ—¢åˆ·æ–°åˆåŠ è½½ï¼Œç»Ÿä¸€ç”¨ä¸€ç»„å‚æ•°æ¥ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‹–åŠ¨è·ç¦»</span></span><br><span class="line"><span class="comment"> * + ä¸‹æ‹‰åˆ·æ–°</span></span><br><span class="line"><span class="comment"> * - ä¸Šæ‹‰åŠ è½½</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> offset = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> loading = <span class="literal">false</span></span><br></pre></td></tr></tbody></table></figure>

<p>åªåš<code>AnytingPullLayout</code>çš„æ™®é€šæ¨¡å¼ï¼Œç•™ä¸€ä¸ªè·ç¦»æ˜¾ç¤ºåŠ è½½çŠ¶æ€çš„Viewï¼Œå†å®šä¸€ä¸ªè·ç¦»ä½œä¸ºè§¦å‘è·ç¦»ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// æ˜¾ç¤ºåŠ è½½çŠ¶æ€çš„è·ç¦»</span></span><br><span class="line"><span class="keyword">val</span> anchorDistance = ResourceUtil.dip2px(context, <span class="number">36f</span>)</span><br><span class="line"><span class="comment">// è§¦å‘è·ç¦»</span></span><br><span class="line"><span class="keyword">val</span> triggerDistance = <span class="number">2</span> * anchorDistance</span><br></pre></td></tr></tbody></table></figure>

<p>ç»§æ‰¿<code>ViewGroup</code>è¦å®ç°<code>onLayout</code>æ–¹æ³•ï¼Œæ ¹æ®æ–¹å‘å’ŒçŠ¶æ€ç»™å­ViewåŠ åç§»ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLayout</span><span class="params">(changed: <span class="type">Boolean</span>, l: <span class="type">Int</span>, t: <span class="type">Int</span>, r: <span class="type">Int</span>, b: <span class="type">Int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">val</span> isHorizontal = isHorizontal</span><br><span class="line">    <span class="keyword">val</span> offsetX = l + <span class="keyword">if</span> (isHorizontal) offset <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">val</span> offsetY = t + <span class="keyword">if</span> (isHorizontal) <span class="number">0</span> <span class="keyword">else</span> offset</span><br><span class="line">    contentView.layout(l + offsetX, t + offsetY, r + offsetX, b + offsetY)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>onMeasure</code>è™½ç„¶æ²¡æœ‰æŠ½è±¡ï¼Œä½†æ˜¯ä¸é‡å†™æ˜¾ç¤ºä¸äº†Viewï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMeasure</span><span class="params">(widthMeasureSpec: <span class="type">Int</span>, heightMeasureSpec: <span class="type">Int</span>)</span></span> {</span><br><span class="line">    measureChildren(widthMeasureSpec, heightMeasureSpec)</span><br><span class="line">    <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ç„¶åé‡å†™<code>dispatchTouchEvent</code>ç›‘å¬è§¦æ‘¸æ¶ˆæ¯ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> touchSlop = ResourceUtil.dip2px(context, <span class="number">1f</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> hasCancel = <span class="literal">false</span></span><br><span class="line"><span class="keyword">var</span> lastTouchPos = <span class="number">0</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">dispatchTouchEvent</span><span class="params">(ev: <span class="type">MotionEvent</span>)</span></span>: <span class="built_in">Boolean</span> {</span><br><span class="line">    <span class="keyword">val</span> curTouchPos = <span class="keyword">if</span> (isHorizontal) ev.x.toInt() <span class="keyword">else</span> ev.y.toInt()</span><br><span class="line">    <span class="keyword">when</span> (ev.action) {</span><br><span class="line">        MotionEvent.ACTION_DOWN -&gt; {</span><br><span class="line">            lastTouchPos = curTouchPos</span><br><span class="line">            hasCancel = <span class="literal">false</span></span><br><span class="line">            <span class="keyword">super</span>.dispatchTouchEvent(ev)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        }</span><br><span class="line">        MotionEvent.ACTION_MOVE -&gt; {</span><br><span class="line">            <span class="keyword">val</span> delta = curTouchPos - lastTouchPos</span><br><span class="line">            lastTouchPos = curTouchPos</span><br><span class="line">            <span class="keyword">if</span> (Math.abs(delta) &gt; touchSlop &amp;&amp; !loading) {</span><br><span class="line">                <span class="keyword">val</span> lastOffset = offset</span><br><span class="line">                offset += (delta * <span class="keyword">when</span> {</span><br><span class="line">                    offset * delta &lt; <span class="number">0</span> -&gt; <span class="number">1f</span> <span class="comment">// åå‘æ— é˜»åŠ›</span></span><br><span class="line">                    !canChildScroll(-delta) -&gt; <span class="number">0.6f</span> <span class="comment">// åŒå‘æ£€æŸ¥å­Viewèƒ½å¦æ»šåŠ¨ï¼Œå¹¶å¸¦ä¸Šé˜»åŠ›</span></span><br><span class="line">                    <span class="keyword">else</span> -&gt; <span class="number">0f</span> <span class="comment">// å­Viewèƒ½æ»šåŠ¨åˆ™ä¸ç®¡</span></span><br><span class="line">                }).toInt()</span><br><span class="line">                <span class="keyword">if</span> (lastOffset * offset &lt; <span class="number">0</span>) offset = <span class="number">0</span> <span class="comment">// åå‘ç½®0</span></span><br><span class="line">                <span class="keyword">if</span> (lastOffset != offset) {</span><br><span class="line">                    <span class="keyword">if</span> (!hasCancel) {</span><br><span class="line">                        <span class="keyword">super</span>.dispatchTouchEvent(</span><br><span class="line">                            MotionEvent.obtain(</span><br><span class="line">                                ev.downTime, ev.eventTime + ViewConfiguration.getLongPressTimeout(),</span><br><span class="line">                                MotionEvent.ACTION_CANCEL, ev.x, ev.y, ev.metaState</span><br><span class="line">                            )</span><br><span class="line">                        )</span><br><span class="line">                        hasCancel = <span class="literal">true</span></span><br><span class="line">                    }</span><br><span class="line">                    updateProgress()</span><br><span class="line">                    requestLayout()</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        MotionEvent.ACTION_UP, MotionEvent.ACTION_CANCEL -&gt; {</span><br><span class="line">            <span class="keyword">if</span> (!loading &amp;&amp; Math.abs(offset) &gt; triggerDistance) {</span><br><span class="line">                loading = <span class="literal">true</span></span><br><span class="line">                startAnimate()</span><br><span class="line">                updateProgress()</span><br><span class="line">                <span class="keyword">if</span> (offset &gt; <span class="number">0</span>) listener?.onRefresh() <span class="keyword">else</span> listener?.onLoad()</span><br><span class="line">            } <span class="keyword">else</span> startAnimate()</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.dispatchTouchEvent(ev)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>ACTION_MOVE</code>é¦–å…ˆåˆ¤æ–­æ˜¯å¦ä¸åœ¨<code>loading</code>çŠ¶æ€è€Œä¸”ç§»åŠ¨è¶…è¿‡<code>touchSlop</code>çš„è·ç¦»ï¼Œæ˜¯çš„è¯é€šè¿‡å½“å‰å’Œä¸Šä¸€æ­¥çš„è§¦æ‘¸ä½ç½®è®¡ç®—æ»‘åŠ¨å¢é‡ï¼Œæœ‰ä¸‰ç§æƒ…å†µï¼š</p>
<ul>
<li>ä¸<code>offset</code>æ–¹å‘ç›¸åï¼Œæ— é˜»åŠ›ï¼Œå€ç‡å–1</li>
<li>ä¸<code>offset</code>æ–¹å‘ç›¸åŒï¼Œä¸”å­Viewä¸èƒ½æ»šåŠ¨ï¼Œæœ‰é˜»åŠ›ï¼Œå€ç‡å–0.6</li>
<li>å¦åˆ™å­Viewèƒ½æ»šåŠ¨ï¼Œé‚£å°±ä¸ç®¡ï¼Œå€ç‡å–0</li>
</ul>
<p>åˆ·æ–°ä¸èƒ½åˆ’æˆåŠ è½½ï¼Œ<code>offset</code>åŠ ä¸Šå¢é‡ä¹‹åå¦‚æœå’ŒåŸæ¥æ–¹å‘ç›¸åï¼Œåˆ™ç½®0ã€‚</p>
<p>å¦‚æœ<code>offset</code>æ”¹å˜ï¼Œåˆ™è¯´æ˜å®¹å™¨æ¶ˆè´¹äº†äº‹ä»¶ï¼Œç»™å­Viewåˆ†å‘<code>ACTION_CANCEL</code>é˜²æ­¢è§¦å‘é•¿æŒ‰äº‹ä»¶ï¼Œå¹¶è°ƒç”¨<code>requestLayout</code>åˆ·æ–°ä½ç§»ï¼Œ<code>updateProgress</code>æ˜¯ç”¨æ¥æ›´æ–°æç¤ºçš„ï¼Œè¿™ä¸ªåé¢å†è¯´ã€‚</p>
<p>æ¥ä¸‹æ¥æ˜¯<code>ACTION_UP/ACTION_CANCEL</code>ï¼Œæ»‘åŠ¨ç»“æŸæ—¶åˆ¤æ–­<code>offset</code>æ˜¯å¦è¶…è¿‡è§¦å‘è·ç¦»ï¼Œä¿®æ”¹<code>loading</code>çŠ¶æ€ï¼Œè§¦å‘<code>listener</code>ï¼Œå¹¶æ»‘åˆ°å¯¹åº”çš„ä½ç½®ã€‚</p>
<p>åŠ¨ç”»æŠ„çš„è½®å­ï¼ŒåŠ¨ç”»æ›´æ–°æ—¶ï¼Œæ›´æ–°<code>offset</code>ï¼ŒåŒæ—¶è°ƒç”¨å­Viewçš„<code>scrollBy</code>ï¼Œè¿™æ ·èƒ½æŠŠä¸Šä¸‹ç« çš„å†…å®¹æ˜¾ç¤ºä¸€ç‚¹å‡ºæ¥ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> animator: ValueAnimator? = <span class="literal">null</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">startAnimate</span><span class="params">()</span></span> {</span><br><span class="line">    animator?.cancel()</span><br><span class="line">    <span class="keyword">val</span> from = offset</span><br><span class="line">    <span class="keyword">val</span> to = <span class="keyword">if</span> (loading) anchorDistance * sign(offset.toFloat()).toInt() <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> (from == to) <span class="keyword">return</span></span><br><span class="line">    animator = ValueAnimator.ofInt(from, to)</span><br><span class="line">    animator?.duration = <span class="number">300</span></span><br><span class="line">    animator?.interpolator = AccelerateDecelerateInterpolator()</span><br><span class="line">    animator?.addUpdateListener {</span><br><span class="line">        <span class="keyword">val</span> lastOffset = offset</span><br><span class="line">        offset = it.animatedValue <span class="keyword">as</span> <span class="built_in">Int</span></span><br><span class="line">        <span class="keyword">val</span> delta = offset - lastOffset</span><br><span class="line">        contentView.scrollBy(<span class="keyword">if</span> (isHorizontal) delta <span class="keyword">else</span> <span class="number">0</span>, <span class="keyword">if</span> (isHorizontal) <span class="number">0</span> <span class="keyword">else</span> delta)</span><br><span class="line">        requestLayout()</span><br><span class="line">    }</span><br><span class="line">    animator?.start()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ç„¶åæ˜¯<code>listener</code>ï¼Œè·Ÿè½®å­ä¸€æ ·æä¸¤ä¸ªå›è°ƒå‡½æ•°</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">PullLoadListener</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onLoad</span><span class="params">()</span></span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onRefresh</span><span class="params">()</span></span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> listener: PullLoadListener? = <span class="literal">null</span></span><br></pre></td></tr></tbody></table></figure>

<p>åŒæ ·å†™ä¸€ä¸ª<code>response</code>å‡½æ•°ï¼Œç”¨äºåŠ è½½ç»“æŸçš„å›è°ƒ</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">response</span><span class="params">(finish: <span class="type">Boolean</span>)</span></span> {</span><br><span class="line">    <span class="keyword">if</span> (!loading) <span class="keyword">return</span></span><br><span class="line">    updateProgress(<span class="keyword">if</span> (finish) <span class="string">"åŠ è½½æˆåŠŸ"</span> <span class="keyword">else</span> <span class="string">"åŠ è½½å¤±è´¥"</span>)</span><br><span class="line">    postDelayed({</span><br><span class="line">        loading = <span class="literal">false</span></span><br><span class="line">        startAnimate()</span><br><span class="line">    }, <span class="number">750</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>updateProgress</code>å‡½æ•°ç”¨äºæ›´æ–°åŠ è½½Viewçš„çŠ¶æ€ï¼Œå­¦<code>SwipeRefreshLayout</code>ç”¨äº†ä¸ª<code>CircularProgressDrawable</code></p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> loadView <span class="keyword">by</span> lazy {</span><br><span class="line">    <span class="keyword">val</span> view = LayoutInflater.from(context).inflate(R.layout.item_pull_load, <span class="keyword">this</span>, <span class="literal">false</span>)</span><br><span class="line">    view.item_progress.setImageDrawable(progressDrawable)</span><br><span class="line">    addView(view)</span><br><span class="line">    view</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> progressDrawable <span class="keyword">by</span> lazy {</span><br><span class="line">    <span class="keyword">val</span> dp = ResourceUtil.dip2px(context, <span class="number">100f</span>) / <span class="number">100f</span></span><br><span class="line">    <span class="keyword">val</span> drawable = CircularProgressDrawable(context)</span><br><span class="line">    drawable.setArrowDimensions(<span class="number">5</span> * dp, <span class="number">5</span> * dp)</span><br><span class="line">    drawable.setColorSchemeColors(ResourceUtil.resolveColorAttr(context, R.attr.colorAccent))</span><br><span class="line">    drawable.strokeWidth = <span class="number">2</span> * dp</span><br><span class="line">    drawable.centerRadius = <span class="number">5</span> * dp</span><br><span class="line">    drawable</span><br><span class="line">}</span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">updateProgress</span><span class="params">(hint: <span class="type">String</span>? = <span class="literal">null</span>)</span></span> {</span><br><span class="line">    loadView.item_hint.text = hint ?: <span class="keyword">when</span> {</span><br><span class="line">        loading -&gt; <span class="string">"åŠ è½½ä¸­..."</span></span><br><span class="line">        Math.abs(offset) &gt; triggerDistance -&gt; <span class="string">"é‡Šæ”¾åŠ è½½"</span></span><br><span class="line">        offset &gt; <span class="number">0</span> -&gt; <span class="string">"åŠ è½½ä¸Šä¸€ç« "</span></span><br><span class="line">        <span class="keyword">else</span> -&gt; <span class="string">"åŠ è½½ä¸‹ä¸€ç« "</span></span><br><span class="line">    }</span><br><span class="line">    progressDrawable.arrowEnabled = !loading</span><br><span class="line">    <span class="keyword">if</span> (progressDrawable.arrowEnabled) {</span><br><span class="line">        progressDrawable.alpha = Math.min(<span class="number">255</span>, (Math.abs(offset) * <span class="number">255</span> / (<span class="number">1f</span> + anchorDistance * <span class="number">2f</span>)).toInt())</span><br><span class="line">        progressDrawable.setStartEndTrim(<span class="number">0f</span>, Math.min(<span class="number">0.75f</span>, Math.abs(offset) / (<span class="number">1f</span> + anchorDistance * <span class="number">3f</span>)))</span><br><span class="line">        progressDrawable.progressRotation = offset * <span class="number">0.01f</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        progressDrawable.alpha = <span class="number">255</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è¿™é‡Œç”¨ä¸€ä¸ªViewæ¥æ˜¾ç¤ºä¸Šä¸‹å·¦å³çš„æç¤ºï¼Œæ‰€ä»¥è¦åœ¨<code>onLayout</code>é‡Œæ›´æ–°æç¤ºviewçš„ä½ç½®ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLayout</span><span class="params">(changed: <span class="type">Boolean</span>, l: <span class="type">Int</span>, t: <span class="type">Int</span>, r: <span class="type">Int</span>, b: <span class="type">Int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">val</span> isHorizontal = isHorizontal</span><br><span class="line">    <span class="keyword">val</span> offsetX = l + <span class="keyword">if</span> (isHorizontal) offset <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">val</span> offsetY = t + <span class="keyword">if</span> (isHorizontal) <span class="number">0</span> <span class="keyword">else</span> offset</span><br><span class="line">    contentView.layout(l + offsetX, t + offsetY, r + offsetX, b + offsetY)</span><br><span class="line">    loadView.visibility = <span class="keyword">if</span> (offset == <span class="number">0</span>) View.INVISIBLE <span class="keyword">else</span> View.VISIBLE</span><br><span class="line">    <span class="keyword">if</span> (offset == <span class="number">0</span>) <span class="keyword">return</span></span><br><span class="line">    loadView.rotation = <span class="keyword">if</span> (isHorizontal) -<span class="number">90f</span> <span class="keyword">else</span> <span class="number">0f</span></span><br><span class="line">    <span class="keyword">val</span> offsetHeight = <span class="keyword">if</span> (offset &lt; <span class="number">0</span>) -loadView.measuredHeight <span class="keyword">else</span> loadView.measuredHeight</span><br><span class="line">    <span class="keyword">val</span> translateX = <span class="keyword">if</span> (isHorizontal) (offset + width) % width - (offsetHeight + loadView.measuredWidth) / <span class="number">2</span></span><br><span class="line">    <span class="keyword">else</span> (width - loadView.measuredWidth) / <span class="number">2</span></span><br><span class="line">    <span class="keyword">val</span> translateY = <span class="keyword">if</span> (isHorizontal) height / <span class="number">2</span></span><br><span class="line">    <span class="keyword">else</span> (offset + height) % height - (loadView.measuredHeight + offsetHeight) / <span class="number">2</span></span><br><span class="line">    loadView.layout(</span><br><span class="line">        translateX,</span><br><span class="line">        translateY,</span><br><span class="line">        loadView.measuredWidth + translateX,</span><br><span class="line">        loadView.measuredHeight + translateY</span><br><span class="line">    )</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><a href="https://github.com/ekibun/BangumiPlugin/blob/master/app/src/main/java/soko/ekibun/bangumi/plugins/ui/view/PullLoadLayout.kt" target="_blank" rel="noopener">å®Œæ•´ä»£ç ä¼ é€é—¨</a></p>
</body></html>]]></content>
      <tags>
        <tag>android</tag>
      </tags>
  </entry>
  <entry>
    <title>æ¼«ç”»é˜…è¯»å™¨ï¼ˆäºŒï¼‰å¯ç¼©æ”¾çš„LayoutManager</title>
    <url>/ekibook/2020/03/19/scalablelayoutmanager/</url>
    <content><![CDATA[<html><head></head><body><p>è¿˜æ˜¯æ¼«ç”»é˜…è¯»å™¨ï¼Œæ•°æ®çš„åŠ è½½å½“ç„¶ç”¨çš„æ˜¯<code>RecyclerView</code>ï¼Œä½œä¸ºä¸€ä¸ªåˆæ ¼çš„æ¼«ç”»é˜…è¯»å™¨ï¼Œç¼©æ”¾æ˜¯å¿…å¤‡åŠŸèƒ½äº†ã€‚ä»å¤´æ‰‹æ’¸<code>LayoutManager</code>è¿˜æ˜¯å¤ªéš¾äº†ï¼Œé‚£ä¹ˆå°±ä»ç»§æ‰¿<code>LinearlayoutManager</code>å¼€å§‹ã€‚</p>
<a id="more"></a>

<p>å…ˆçœ‹æ•ˆæœï¼š</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2020/03/19/scalablelayoutmanager/Screenrecorder-2020-04-08-19-39-40-568.gif" alt="Screenrecorder-2020-04-08-19-39-40-568"></p>
<p><code>onLayoutChildren</code>å¤ªé•¿äº†æ‡’å¾—çœ‹ï¼Œä½†layoutä¸€å®šä¼šè°ƒç”¨<code>measureChildWithMargins</code>å’Œ<code>layoutDecoratedWithMargins</code>ï¼Œhookå°±ä»è¿™ä¸¤ä¸ªæ–¹æ³•å…¥æ‰‹ã€‚</p>
<p>é¦–å…ˆæ˜¯<code>measureChildWithMargins</code>ï¼Œè¿™é‡Œä¼šæµ‹é‡å‡ºéœ€è¦çš„å®½é«˜ï¼Œå…ˆè°ƒç”¨<code>super</code>æ›´æ–°<code>widthUsed</code>å’Œ<code>heightUsed</code>ï¼Œå†ä¿®æ”¹<code>MeasureSpec</code>æ”¹å˜å­é¡¹çš„å¤§å°ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> scale = <span class="number">1f</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">measureChildWithMargins</span><span class="params">(child: <span class="type">View</span>, widthUsed: <span class="type">Int</span>, heightUsed: <span class="type">Int</span>)</span></span> {</span><br><span class="line">    <span class="keyword">super</span>.measureChildWithMargins(child, widthUsed, heightUsed)</span><br><span class="line">    <span class="keyword">val</span> lp = child.layoutParams <span class="keyword">as</span> RecyclerView.LayoutParams</span><br><span class="line">    <span class="keyword">val</span> widthSpec = RecyclerView.LayoutManager.getChildMeasureSpec(</span><br><span class="line">        (width * scale).toInt(), widthMode,</span><br><span class="line">        paddingLeft + paddingRight</span><br><span class="line">        + lp.leftMargin + lp.rightMargin + widthUsed, lp.width,</span><br><span class="line">        canScrollHorizontally()</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">val</span> heightSpec = RecyclerView.LayoutManager.getChildMeasureSpec(</span><br><span class="line">        height, heightMode,</span><br><span class="line">        paddingTop + paddingBottom</span><br><span class="line">        + lp.topMargin + lp.bottomMargin + heightUsed, lp.height,</span><br><span class="line">        canScrollVertically()</span><br><span class="line">    )</span><br><span class="line">    child.measure(widthSpec, heightSpec)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ç„¶åæ˜¯<code>layoutDecoratedWithMargins</code>ï¼Œåœ¨è¿™é‡Œè¿”å›å­é¡¹çš„ä½ç½®ï¼Œç¼©æ”¾ä¹‹åç§»åŠ¨çš„åç§»é‡å°±åœ¨è¿™é‡ŒåŠ ä¸Šï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> offsetX = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">layoutDecoratedWithMargins</span><span class="params">(child: <span class="type">View</span>, left: <span class="type">Int</span>, top: <span class="type">Int</span>, right: <span class="type">Int</span>, bottom: <span class="type">Int</span>)</span></span> {</span><br><span class="line">    updateContent(child, <span class="keyword">this</span>)</span><br><span class="line">    offsetX = Math.max(<span class="number">0</span>, Math.min(right - left - width, offsetX))</span><br><span class="line">    <span class="keyword">super</span>.layoutDecoratedWithMargins(child, left - offsetX, top, right - offsetX, bottom)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æ¥ä¸‹æ¥å°±æ˜¯ç¼©æ”¾çš„æ‰‹åŠ¿äº†ï¼Œæä¸ª<code>setupWithRecyclerView</code>æŠŠæ“ä½œåˆåœ¨ä¸€èµ·ï¼Œè¿™é‡Œç”¨äº†<code>setOnTouchListener</code>è€Œä¸æ˜¯<code>addOnItemTouchListener</code>ï¼Œæ˜¯å› ä¸ºä¸çŸ¥é“æ€ä¹ˆæ‹¦æˆªèƒ½ä¿æŒå­é¡¹çš„ç‚¹å‡»äº‹ä»¶ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> doingScale = <span class="literal">false</span></span><br><span class="line"><span class="keyword">lateinit</span> <span class="keyword">var</span> recyclerView: RecyclerView</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressLint(<span class="meta-string">"ClickableViewAccessibility"</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setupWithRecyclerView</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    view: <span class="type">RecyclerView</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    onTap: (<span class="type">Int</span>, <span class="type">Int</span>) -&gt; <span class="type">Unit</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    onPress: (<span class="type">View</span>, <span class="type">Int</span>) -&gt; <span class="type">Unit</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    onTouch: (<span class="type">MotionEvent</span>) -&gt; <span class="type">Unit</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span> {</span><br><span class="line">    recyclerView = view</span><br><span class="line">    view.layoutManager = <span class="keyword">this</span></span><br><span class="line">    <span class="keyword">var</span> beginScale = scale</span><br><span class="line">    <span class="keyword">val</span> scaleGestureDetector =</span><br><span class="line">        ScaleGestureDetector(view.context, <span class="keyword">object</span> : ScaleGestureDetector.SimpleOnScaleGestureListener() {</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onScaleBegin</span><span class="params">(detector: <span class="type">ScaleGestureDetector</span>?)</span></span>: <span class="built_in">Boolean</span> {</span><br><span class="line">                beginScale = scale</span><br><span class="line">                currentPos = Math.round(currentPos).toFloat()</span><br><span class="line">                doingScale = <span class="literal">true</span></span><br><span class="line">                requestLayout()</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">super</span>.onScaleBegin(detector)</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onScale</span><span class="params">(detector: <span class="type">ScaleGestureDetector</span>)</span></span>: <span class="built_in">Boolean</span> {</span><br><span class="line">                <span class="keyword">val</span> oldScale = scale</span><br><span class="line">                scale = beginScale * detector.scaleFactor</span><br><span class="line">                scrollOnScale(detector.focusX, detector.focusY, oldScale)</span><br><span class="line">                requestLayout()</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">super</span>.onScale(detector)</span><br><span class="line">            }</span><br><span class="line">        })</span><br><span class="line">    <span class="keyword">val</span> gestureDetector = GestureDetectorCompat(view.context, <span class="keyword">object</span> : GestureDetector.SimpleOnGestureListener() {</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSingleTapConfirmed</span><span class="params">(e: <span class="type">MotionEvent</span>)</span></span>: <span class="built_in">Boolean</span> {</span><br><span class="line">            onTap((e.x).toInt(), (e.y).toInt())</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.onSingleTapConfirmed(e)</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLongPress</span><span class="params">(e: <span class="type">MotionEvent</span>)</span></span> {</span><br><span class="line">            view.findChildViewUnder(e.x, e.y)?.let { onPress(it, view.getChildAdapterPosition(it)) }</span><br><span class="line">            <span class="keyword">super</span>.onLongPress(e)</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDoubleTap</span><span class="params">(e: <span class="type">MotionEvent</span>)</span></span>: <span class="built_in">Boolean</span> {</span><br><span class="line">            <span class="keyword">val</span> oldScale = scale</span><br><span class="line">            scale = <span class="keyword">if</span> (scale &lt; <span class="number">2f</span>) <span class="number">2f</span> <span class="keyword">else</span> <span class="number">1f</span></span><br><span class="line">            scrollOnScale(e.x, e.y, oldScale)</span><br><span class="line">            requestLayout()</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.onDoubleTap(e)</span><br><span class="line">        }</span><br><span class="line">    })</span><br><span class="line">    view.setOnTouchListener { v, event -&gt;</span><br><span class="line">        onTouch(event)</span><br><span class="line">        scaleGestureDetector.onTouchEvent(event)</span><br><span class="line">        gestureDetector.onTouchEvent(event)</span><br><span class="line">        <span class="literal">false</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>è¿™é‡Œç”¨<code>ScaleGestureDetector</code>æ£€æµ‹ç¼©æ”¾æ‰‹åŠ¿ï¼ŒåŒæ—¶<code>GestureDetector</code>æ£€æµ‹åŒå‡»ï¼Œæ³¨æ„é•¿æŒ‰ä¸èƒ½å†™åœ¨å­é¡¹ä¸Šä¸ç„¶å°±ä¸èƒ½å“åº”æ‰‹åŠ¿äº†ã€‚ç¼©æ”¾åœ¨æ”¹å˜<code>scale</code>å¹¶<code>requestLayout</code>ä¹‹åï¼Œè¿˜è¦æ»šåŠ¨ä¸€å®šçš„è·ç¦»æ¥ä¿æŒç¼©æ”¾ä¸­å¿ƒçš„ä½ç½®ï¼Œç»Ÿä¸€åœ¨<code>scrollOnScale</code>å‡½æ•°ä¸­å¤„ç†ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">scrollOnScale</span><span class="params">(x: <span class="type">Float</span>, y: <span class="type">Float</span>, oldScale: <span class="type">Float</span>)</span></span> {</span><br><span class="line">    <span class="keyword">val</span> adapter = recyclerView.adapter</span><br><span class="line">    <span class="keyword">val</span> anchorPos = (<span class="keyword">if</span> (adapter <span class="keyword">is</span> ScalableAdapter) {</span><br><span class="line">        (findFirstVisibleItemPosition()..findLastVisibleItemPosition()).firstOrNull {</span><br><span class="line">            adapter.isItemScalable(it, <span class="keyword">this</span>)</span><br><span class="line">        } ?: {</span><br><span class="line">            scale = <span class="number">1f</span></span><br><span class="line">            <span class="literal">null</span></span><br><span class="line">        }()</span><br><span class="line">    } <span class="keyword">else</span> findFirstVisibleItemPosition()) ?: <span class="keyword">return</span></span><br><span class="line">    recyclerView.scrollBy(((offsetX + x) * (scale - oldScale) / oldScale).toInt(), <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> (orientation == VERTICAL) findViewByPosition(anchorPos)?.let {</span><br><span class="line">        scrollToPositionWithOffset(anchorPos, (y - (-getDecoratedTop(it) + y) * scale / oldScale).toInt())</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>å› ä¸ºåæ¥åˆå†™äº†å°è¯´é˜…è¯»å™¨ï¼Œæ–‡å­—çš„éƒ¨åˆ†ä¸ä¼šå‘å›¾ç‰‡ä¸€æ ·èƒ½ç¼©æ”¾ï¼Œå°±ç»™<code>Adapter</code>å¸¦ä¸Šäº†ä¸€ä¸ªæ¥å£åˆ¤æ–­å¯¹åº”çš„å­é¡¹æ˜¯å¦èƒ½ç¼©æ”¾ï¼Œå¦‚æœå±å¹•ä¸­æ²¡æœ‰èƒ½ç¼©æ”¾çš„å­é¡¹ï¼Œå°±æŠŠ<code>scale</code>è¿˜åŸä¸º1ï¼Œæ³¨æ„ç«–å‘çš„æ»šåŠ¨å’Œæ¨ªå‘ä¸ä¸€æ ·ï¼Œæ˜¯é€šè¿‡è°ƒç”¨<code>LinearlayoutManager</code>çš„<code>scrollToPositionWithOffset</code>å®ç°çš„ã€‚æ»šåŠ¨è·ç¦»æŒ‰ä¸‹é¢çš„å¼å­ç®—å‡ºæ¥ï¼š<br><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -6.639ex" xmlns="http://www.w3.org/2000/svg" width="65.766ex" height="14.41ex" role="img" focusable="false" viewBox="0 -3434.5 29068.7 6369"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g data-mml-node="math"><g data-mml-node="mtable"><g data-mml-node="mtr" transform="translate(0, 2684.5)"><g data-mml-node="mtd"><g data-mml-node="mo"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ»š</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŠ¨</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ä½</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç§»</text><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z" transform="translate(3600, 0)"></path></g></g><g data-mml-node="mtd" transform="translate(4378, 0)"><g data-mml-node="mi"></g><g data-mml-node="mo" transform="translate(277.8, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç§»</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">é‡</text></g><g data-mml-node="mo" transform="translate(3255.6, 0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mo" transform="translate(4311.3, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŸ</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç§»</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">é‡</text></g></g></g><g data-mml-node="mtr" transform="translate(0, 685)"><g data-mml-node="mtd" transform="translate(3600, 0)"><g data-mml-node="mo"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g></g><g data-mml-node="mtd" transform="translate(4378, 0)"><g data-mml-node="mrow"><g data-mml-node="mo"><path data-c="28" d="M701 -940Q701 -943 695 -949H664Q662 -947 636 -922T591 -879T537 -818T475 -737T412 -636T350 -511T295 -362T250 -186T221 17T209 251Q209 962 573 1361Q596 1386 616 1405T649 1437T664 1450H695Q701 1444 701 1441Q701 1436 681 1415T629 1356T557 1261T476 1118T400 927T340 675T308 359Q306 321 306 250Q306 -139 400 -430T690 -924Q701 -936 701 -940Z"></path></g><g data-mml-node="mfrac" transform="translate(736, 0)"><g data-mml-node="mrow" transform="translate(220, 676)"><g data-mml-node="mo"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŸ</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç§»</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">é‡</text></g><g data-mml-node="mo" transform="translate(3877.8, 0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mo" transform="translate(4933.6, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç¼©</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ”¾</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ä¸­</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å¿ƒ</text></g></g><g data-mml-node="mrow" transform="translate(2686.8, -710)"><g data-mml-node="mo"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŸ</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç¼©</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ”¾</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ¯”</text></g></g><rect width="8733.6" height="60" x="120" y="220"></rect></g><g data-mml-node="mo" transform="translate(9709.6, 0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mo" transform="translate(10765.3, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç°</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç¼©</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ”¾</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ¯”</text></g><g data-mml-node="mo" transform="translate(14643.1, 0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mo" transform="translate(15698.9, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç¼©</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ”¾</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ä¸­</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å¿ƒ</text></g><g data-mml-node="mo" transform="translate(19298.9, 0)"><path data-c="29" d="M34 1438Q34 1446 37 1448T50 1450H56H71Q73 1448 99 1423T144 1380T198 1319T260 1238T323 1137T385 1013T440 864T485 688T514 485T526 251Q526 134 519 53Q472 -519 162 -860Q139 -885 119 -904T86 -936T71 -949H56Q43 -949 39 -947T34 -937Q88 -883 140 -813Q428 -430 428 251Q428 453 402 628T338 922T245 1146T145 1309T46 1425Q44 1427 42 1429T39 1433T36 1436L34 1438Z"></path></g></g><g data-mml-node="mo" transform="translate(20034.9, 0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mo" transform="translate(21090.7, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŸ</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç§»</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">é‡</text></g></g></g><g data-mml-node="mtr" transform="translate(0, -2024.5)"><g data-mml-node="mtd" transform="translate(3600, 0)"><g data-mml-node="mo"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g></g><g data-mml-node="mtd" transform="translate(4378, 0)"><g data-mml-node="mfrac"><g data-mml-node="mrow" transform="translate(220, 710)"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mo" transform="translate(389, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŸ</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç§»</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">é‡</text></g><g data-mml-node="mo" transform="translate(4266.8, 0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mo" transform="translate(5322.6, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç¼©</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ”¾</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ä¸­</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">å¿ƒ</text></g><g data-mml-node="mo" transform="translate(8922.6, 0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(9533.8, 0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path></g><g data-mml-node="mo" transform="translate(10534, 0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mo" transform="translate(10923, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç°</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç¼©</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ”¾</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ¯”</text></g><g data-mml-node="mo" transform="translate(14800.8, 0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mo" transform="translate(15856.6, 0)"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŸ</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç¼©</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ”¾</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ¯”</text></g><g data-mml-node="mo" transform="translate(19456.6, 0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g></g><g data-mml-node="mrow" transform="translate(8342.8, -710)"><g data-mml-node="mo"><text data-variant="normal" transform="matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">åŸ</text><text data-variant="normal" transform="translate(900, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">ç¼©</text><text data-variant="normal" transform="translate(1800, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ”¾</text><text data-variant="normal" transform="translate(2700, 0) matrix(1 0 0 -1 0 0)" font-size="884px" font-family="serif">æ¯”</text></g></g><rect width="20045.6" height="60" x="120" y="220"></rect></g></g></g></g></g></g></svg></mjx-container><br>æœ€åï¼Œä¸ºäº†èƒ½å¤Ÿæ¨ªå‘æ»šåŠ¨ï¼Œè¦è®©<code>canScrollHorizontally</code>è¿”å›<code>true</code>ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">canScrollVertically</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> = <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure>

<p>ä¸ºäº†æ ¹æ®æ»šåŠ¨ä¿®æ”¹offsetè¿˜è¦é‡å†™<code>scrollHorizontallyBy</code>ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">scrollHorizontallyBy</span><span class="params">(dx: <span class="type">Int</span>, recycler: <span class="type">RecyclerView</span>.<span class="type">Recycler</span>, state: <span class="type">RecyclerView</span>.<span class="type">State</span>)</span></span>: <span class="built_in">Int</span> {</span><br><span class="line">    <span class="keyword">val</span> view = findViewByPosition(downPage)</span><br><span class="line">    <span class="keyword">val</span> ddx = Math.max(</span><br><span class="line">        Math.min(</span><br><span class="line">            dx,</span><br><span class="line">            (width * scale).toInt() - width - offsetX</span><br><span class="line">        ), -offsetX</span><br><span class="line">    )</span><br><span class="line">    offsetX += ddx</span><br><span class="line">    offsetChildrenHorizontal(-ddx)</span><br><span class="line">    view?.translationX = <span class="number">0f</span></span><br><span class="line">    <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0</span> until recyclerView.childCount) updateContent(recyclerView.getChildAt(i), <span class="keyword">this</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">if</span> (scale == <span class="number">1f</span>) dx <span class="keyword">else</span> ddx</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>é¦–å…ˆæ ¹æ®å½“å‰çš„<code>scale</code>è®¡ç®—èƒ½æ¶ˆè€—çš„ä½ç§»<code>ddx</code>ï¼Œç»™<code>offset</code>åŠ ä¸Šï¼Œæ³¨æ„è¿™é‡Œæ²¡æ³•<code>requestLayout</code>ï¼Œåªèƒ½ç”¨<code>offsetChildrenHorizontal</code>ä¿®æ”¹å­é¡¹çš„åç§»ã€‚</p>
<p>ä¸‹ä¸€ç¯‡åœ¨è¿™ä¸ªçš„åŸºç¡€ä¸Šï¼Œå°†æ¨ªå‘æ”¹æˆç¿»é¡µæ¨¡å¼ã€‚</p>
<p><a href="https://github.com/ekibun/BangumiPlugin/blob/master/app/src/main/java/soko/ekibun/bangumi/plugins/ui/view/book/BookLayoutManager.kt" target="_blank" rel="noopener">å®Œæ•´ä»£ç ä¼ é€é—¨</a></p>
</body></html>]]></content>
      <tags>
        <tag>android</tag>
      </tags>
  </entry>
  <entry>
    <title>ç”¨Spanå®ç°TextViewä¸¤ç«¯å¯¹é½</title>
    <url>/ekibook/2020/05/17/spanjustify/</url>
    <content><![CDATA[<html><head></head><body><p>ç½‘ä¸Šå¤§éƒ¨åˆ†çš„å·¦å³å¯¹é½éƒ½æ˜¯åŸºäºé‡ç»˜å®ç°çš„ï¼Œè¿™æ ·<code>TextView</code>è‡ªå¸¦çš„é€‰æ‹©å°±ä¸èƒ½ç”¨äº†ã€‚ä¸ºäº†ä¸è‡ªå·±æ¥å­˜<code>Layout</code>çš„ä¿¡æ¯ï¼Œç”¨<code>ReplacementSpan</code>æ¥å®ç°å­—é—´è·çš„æ§åˆ¶ã€‚</p>
<a id="more"></a>

<p>æ•ˆæœé•¿è¿™æ ·</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2020/05/17/spanjustify/image-20200517230159894.png" alt="image-20200517230159894"></p>
<p>ä¸€å¼€å§‹æƒ³ç›´æ¥ä¿®æ”¹<code>CharacterStyle</code>çš„<code>TextPaint.setLetterSpacing</code>æ¥å®ç°ï¼Œä½†æ˜¯<strong>TextViewåœ¨ç»˜åˆ¶Spannedçš„æ—¶å€™æ˜¯é€ä¸ªå­—ç¬¦ç»˜åˆ¶çš„</strong>ï¼Œ<code>LetterSpacing</code>åœ¨ç»˜åˆ¶çš„æ—¶å€™ä¼šè¢«å–æ•´è€Œå¯¹ä¸é½ã€‚æ— å¥ˆä¹‹ä¸‹é€‰æ‹©ç”¨<code>ReplacementSpan</code>è‡ªå·±ç»˜åˆ¶ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LetterSpacingSpan</span></span>(<span class="keyword">private</span> <span class="keyword">val</span> width: <span class="built_in">Int</span>, <span class="keyword">private</span> <span class="keyword">val</span> spacing: <span class="built_in">Float</span>) : ReplacementSpan() {</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getSize</span><span class="params">(paint: <span class="type">Paint</span>, text: <span class="type">CharSequence</span>?, start: <span class="type">Int</span>, end: <span class="type">Int</span>, fm: <span class="type">Paint</span>.<span class="type">FontMetricsInt</span>?)</span></span>: <span class="built_in">Int</span> {</span><br><span class="line">        <span class="keyword">return</span> width</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">draw</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        canvas: <span class="type">Canvas</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        text: <span class="type">CharSequence</span>?,</span></span></span><br><span class="line"><span class="function"><span class="params">        start: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        end: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        x: <span class="type">Float</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        top: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        y: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        bottom: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        paint: <span class="type">Paint</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span> {</span><br><span class="line">        paint.letterSpacing</span><br><span class="line">        canvas.drawText(text ?: <span class="string">""</span>, start, end, x + spacing, y.toFloat(), paint)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ä¸ºäº†ä¿æŒé€‰æ‹©åŒºåŸŸï¼Œæ¯ä¸ªå­—ç¬¦æ›¿æ¢ä¸ºä¸€ä¸ª<code>LetterSpacingSpan</code>ï¼Œåœ¨åˆ†é¡µçš„æ—¶å€™è®¡ç®—ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> pageWidth =</span><br><span class="line">    recyclerView.width - referHolder.itemView.content_container.let { it.paddingLeft + it.paddingRight }</span><br><span class="line"><span class="keyword">val</span> titleHeight = <span class="keyword">if</span> (page.index &lt;= <span class="number">1</span>) referHolder.itemView.item_title.let {</span><br><span class="line">    getEpTitle(page.ep).let { content -&gt;</span><br><span class="line">        StaticLayout.Builder.obtain(content, <span class="number">0</span>, content.length, it.paint, pageWidth)</span><br><span class="line">            .setAlignment(Layout.Alignment.ALIGN_NORMAL)</span><br><span class="line">            .setLineSpacing(it.lineSpacingExtra, it.lineSpacingMultiplier)</span><br><span class="line">            .setIncludePad(it.includeFontPadding)</span><br><span class="line">            .setUseLineSpacingFromFallbacks(it.isFallbackLineSpacing)</span><br><span class="line">            .setBreakStrategy(it.breakStrategy)</span><br><span class="line">            .setHyphenationFrequency(it.hyphenationFrequency)</span><br><span class="line">            .setJustificationMode(it.justificationMode)</span><br><span class="line">            .build()</span><br><span class="line">    }.height + it.paddingBottom</span><br><span class="line">} <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">val</span> layout = referHolder.itemView.item_content.let {</span><br><span class="line">    StaticLayout.Builder.obtain(page.content, <span class="number">0</span>, page.content.length, it.paint, pageWidth)</span><br><span class="line">        .setAlignment(Layout.Alignment.ALIGN_NORMAL)</span><br><span class="line">        .setLineSpacing(it.lineSpacingExtra, it.lineSpacingMultiplier)</span><br><span class="line">        .setIncludePad(it.includeFontPadding)</span><br><span class="line">        .setUseLineSpacingFromFallbacks(it.isFallbackLineSpacing)</span><br><span class="line">        .setBreakStrategy(it.breakStrategy)</span><br><span class="line">        .setHyphenationFrequency(it.hyphenationFrequency)</span><br><span class="line">        .setJustificationMode(it.justificationMode)</span><br><span class="line">        .build()</span><br><span class="line">}</span><br><span class="line"><span class="keyword">val</span> pageHeight =</span><br><span class="line">    recyclerView.height - referHolder.itemView.content_container.let { it.paddingTop + it.paddingBottom }</span><br><span class="line"><span class="keyword">var</span> lastTextIndex = <span class="number">0</span></span><br><span class="line"><span class="keyword">var</span> lastLineBottom = <span class="number">0</span></span><br><span class="line"><span class="keyword">var</span> spannableStringBuilder = SpannableStringBuilder()</span><br><span class="line"><span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0</span> until layout.lineCount) {</span><br><span class="line">    <span class="keyword">val</span> lineEnd = layout.getLineEnd(i)</span><br><span class="line">    <span class="keyword">val</span> lineStart = layout.getLineStart(i)</span><br><span class="line">    <span class="keyword">val</span> visibleEnd = layout.getLineVisibleEnd(i)</span><br><span class="line">    spannableStringBuilder.append(SpannableString(page.content.substring(lineStart, lineEnd)).also {</span><br><span class="line">        <span class="keyword">val</span> textCount = visibleEnd - lineStart - <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> (textCount &lt;= <span class="number">1</span> || it.endsWith(<span class="string">'\n'</span>) || i == layout.lineCount - <span class="number">1</span>) <span class="keyword">return</span><span class="symbol">@also</span></span><br><span class="line">        <span class="keyword">if</span> (widthArray.size &lt; textCount) widthArray = FloatArray(textCount)</span><br><span class="line">        <span class="keyword">val</span> letterSpacing = (pageWidth - layout.getLineWidth(i)) / textCount / <span class="number">2</span></span><br><span class="line">        <span class="keyword">var</span> width = layout.getPrimaryHorizontal(lineStart + <span class="number">1</span>) + letterSpacing</span><br><span class="line">        it.setSpan(LetterSpacingSpan(width.toInt(), <span class="number">0f</span>), <span class="number">0</span>, <span class="number">1</span>, Spanned.SPAN_EXCLUSIVE_EXCLUSIVE)</span><br><span class="line">        <span class="keyword">for</span> (c <span class="keyword">in</span> <span class="number">1</span> until textCount) {</span><br><span class="line">            <span class="keyword">val</span> dw = layout.getPrimaryHorizontal(lineStart + c + <span class="number">1</span>) + (<span class="number">2</span> * c + <span class="number">1</span>) * letterSpacing</span><br><span class="line">            it.setSpan(</span><br><span class="line">                LetterSpacingSpan(dw.toInt() - width.toInt(), letterSpacing + (width % <span class="number">1</span>)),</span><br><span class="line">                c,</span><br><span class="line">                c + <span class="number">1</span>,</span><br><span class="line">                Spanned.SPAN_EXCLUSIVE_EXCLUSIVE</span><br><span class="line">            )</span><br><span class="line">            width = dw</span><br><span class="line">        }</span><br><span class="line">        it.setSpan(</span><br><span class="line">            LetterSpacingSpan(pageWidth - width.toInt(), letterSpacing + (width % <span class="number">1</span>)),</span><br><span class="line">            textCount,</span><br><span class="line">            textCount + <span class="number">1</span>,</span><br><span class="line">            Spanned.SPAN_EXCLUSIVE_EXCLUSIVE</span><br><span class="line">        )</span><br><span class="line">    })</span><br><span class="line">    <span class="keyword">val</span> curLineBottom = layout.getLineBottom(i + <span class="number">1</span>) + titleHeight</span><br><span class="line">    <span class="keyword">if</span> (curLineBottom - lastLineBottom &lt; pageHeight) <span class="keyword">continue</span></span><br><span class="line">    ret += PageInfo(</span><br><span class="line">        content = spannableStringBuilder.subSequence(</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            spannableStringBuilder.length - lineEnd + visibleEnd</span><br><span class="line">        ),</span><br><span class="line">        ep = page.ep,</span><br><span class="line">        rawInfo = page,</span><br><span class="line">        rawRange = IntRange(lastTextIndex, visibleEnd)</span><br><span class="line">    )</span><br><span class="line">    lastTextIndex = lineEnd</span><br><span class="line">    lastLineBottom = layout.getLineBottom(i) + titleHeight</span><br><span class="line">    spannableStringBuilder = SpannableStringBuilder()</span><br><span class="line">}</span><br><span class="line">ret += PageInfo(</span><br><span class="line">    content = spannableStringBuilder,</span><br><span class="line">    ep = page.ep,</span><br><span class="line">    rawInfo = page,</span><br><span class="line">    rawRange = IntRange(lastTextIndex, page.content.length)</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>

</body></html>]]></content>
      <tags>
        <tag>android</tag>
      </tags>
  </entry>
  <entry>
    <title>webviewå’Œä¸‹æ‹‰åˆ·æ–°</title>
    <url>/ekibook/2020/04/07/webviewpullload/</url>
    <content><![CDATA[<html><head></head><body><p>ä¸‹æ‹‰åˆ·æ–°<code>SwipeRefreshLayout</code>ä¼šå’Œ<code>Webview</code>çš„ç«–å‘æ»šåŠ¨å†²çªï¼Œç½‘ä¸Šå„ç§è§£å†³æ–¹æ³•äº”èŠ±å…«é—¨ï¼Œæœ‰é‡å†™<code>SwipeRefreshLayout</code>çš„ï¼Œæœ‰ç»™<code>Webview</code>è§¦æ‘¸åŠ åç§»çš„ï¼Œä½†é‡åˆ°å›ºå®šé¡µé¢æœ‰åµŒå¥—æ»šåŠ¨å°±å…¨é˜µäº¡äº†ã€‚ä¸€ä¸ªå¶ç„¶å‘ç°<code>Webview</code>ä¹Ÿæœ‰<code>OverScrolled</code>æ–¹æ³•ï¼Œä¼šåœ¨æ»šåŠ¨è¶…è¿‡å¤„ç†èŒƒå›´æ—¶è°ƒç”¨ï¼Œæ—¢ç„¶çŸ¥é“ä»€ä¹ˆæ—¶å€™è¿‡æ»šåŠ¨ï¼Œé‚£é—®é¢˜å°±è¿åˆƒè€Œè§£äº†ã€‚</p>
<a id="more"></a>

<h4 id="é‡å†™WebView"><a href="#é‡å†™WebView" class="headerlink" title="é‡å†™WebView"></a>é‡å†™WebView</h4><p>æŒ‰ä¸‹çš„æ—¶å€™ç½®<code>false</code>ï¼Œåœ¨<code>onOverScrolled</code>æ›´æ–°çŠ¶æ€ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> overScrollY = <span class="literal">false</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onOverScrolled</span><span class="params">(scrollX: <span class="type">Int</span>, scrollY: <span class="type">Int</span>, clampedX: <span class="type">Boolean</span>, clampedY: <span class="type">Boolean</span>)</span></span> {</span><br><span class="line">    overScrollY = clampedY</span><br><span class="line">    <span class="keyword">super</span>.onOverScrolled(scrollX, scrollY, clampedX, clampedY)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressLint(<span class="meta-string">"ClickableViewAccessibility"</span>)</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTouchEvent</span><span class="params">(event: <span class="type">MotionEvent</span>)</span></span>: <span class="built_in">Boolean</span> {</span><br><span class="line">    <span class="keyword">if</span> (event.action == MotionEvent.ACTION_DOWN) overScrollY = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.onTouchEvent(event)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="SwipeRefreshLayoutç›‘å¬"><a href="#SwipeRefreshLayoutç›‘å¬" class="headerlink" title="SwipeRefreshLayoutç›‘å¬"></a>SwipeRefreshLayoutç›‘å¬</h4><p>åœ¨<code>SwipeRefreshLayout.setOnChildScrollUpCallback</code>è¿”å›<code>WebView.overScrollY</code>ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line">item_swipe.setOnChildScrollUpCallback { _, _ -&gt;</span><br><span class="line">    !curWebView.overScrollY</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ä¸¤æ­¥æå®šï¼Œç®€ç›´ä¸èƒ½æ›´ç®€å•ï¼Œæ›´è¿›ä¸€æ­¥è¿˜èƒ½é€‚é…å…³è”æ»šåŠ¨ã€‚</p>
</body></html>]]></content>
      <tags>
        <tag>android</tag>
      </tags>
  </entry>
  <entry>
    <title>åœ¨TextViewé‡Œé¢åŠ è½½åŠ¨æ€Drawable</title>
    <url>/ekibook/2020/03/25/textviewimage/</url>
    <content><![CDATA[<html><head></head><body><p>å‚ç…§<a href="https://www.jianshu.com/p/3ae513115c17" target="_blank" rel="noopener">sunhapper</a>çš„æ€è·¯ï¼Œè®¾ç½®<code>Drawable.Callback</code>æ¥åˆ·æ–°<code>TextView</code>ï¼Œä½†å®é™…æ“ä½œä¸­è¸©äº†ä¸€ä¸ªå¤§å‘ï¼šåº”ç”¨æ˜¯ç”¨çš„<code>Glide</code>æ¥åŠ è½½å›¾ç‰‡ï¼Œå¥‡æ€ªçš„æ˜¯å³ä½¿<code>invalidate</code>æ‰æ•´ä¸ª<code>TextView</code>ä¹Ÿæ²¡æ³•åˆ·æ–°<code>Glide</code>è‡ªå¸¦çš„<code>GifDrawable</code>ï¼Œç›¸å¯¹çš„<code>android-gif-drawable</code>å³ä½¿æ²¡æœ‰å†æ¬¡è°ƒç”¨<code>Drawable.draw</code>ä¹Ÿèƒ½å¾ˆå¥½çš„åˆ·æ–°ã€‚</p>
<a id="more"></a>

<p>ç”±äº<code>android-gif-drawable</code>æ˜¯ç”¨<code>OpenGL</code>æ¥åˆ·æ–°GIFå›¾ç‰‡ï¼Œä¸€å¼€å§‹æ²¡æ•¢æ·±ç©¶ï¼Œå°±æŠŠ<code>GifDrawable</code>è½¬æˆ<code>android-gif-drawable</code>ã€‚åæ¥ï¼Œæ‰“ç®—ç”¨<code>CircularProgressDrawable</code>æ¥æ˜¾ç¤ºåŠ è½½è¿›åº¦ï¼Œè¿™æ—¶å€™<code>Drawable</code>å°±æ²¡æ³•è½¬æˆ<code>android-gif-drawable</code>äº†ã€‚</p>
<p>è¢«è¿«ç ”ç©¶äº†<code>android-gif-drawable</code>çš„ä»£ç ï¼Œå‘ç°å®ƒæ˜¯åˆ›å»ºäº†ä¸€ä¸ª<code>Bitmap</code>æ¥ç»™<code>OpenGL</code>è¿›è¡Œç»˜åˆ¶ï¼Œå†åœ¨<code>Drawable.onDraw</code>é‡ŒæŠŠ<code>Bitmap</code>ç»˜åˆ¶å‡ºæ¥ã€‚ç›¸å¯¹çš„ï¼Œ<code>GifDrawable</code>æ˜¯åœ¨<code>Drawable.draw</code>é‡Œç›´æ¥ç»˜åˆ¶ï¼Œç”±äº<code>Drawable.draw</code>åªè°ƒç”¨ä¸€æ¬¡ï¼Œå°±æ²¡èƒ½æ˜¾ç¤ºåŠ¨æ€çš„å›¾ç‰‡ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨<code>TextView</code>å¼€å¯ç¡¬ä»¶åŠ é€Ÿçš„æƒ…å†µä¸‹ï¼Œè™½ç„¶<code>Drawable.draw</code>åªè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä½†æ˜¯<code>Bitmap</code>ä¼šä»¥å¼•ç”¨çš„å½¢å¼ä¼ é€’ç»™GPUï¼Œ<strong>ä¿®æ”¹<code>Bitmap</code>å°±èƒ½åœ¨ä¸‹æ¬¡ç»˜åˆ¶æ—¶æ›´æ–°å›¾åƒ</strong>ã€‚</p>
<p>é‚£ä¹ˆæˆ‘ä»¬ç»§æ‰¿<code>AnimationDrawable</code>æ¥å†™ä¸ªWrapperï¼Œå®ƒåŒ…å«ä¸€ä¸ª<code>drawable</code>å˜é‡ï¼Œå½“ç„¶ä¹Ÿæœ‰ä¸€ä¸ª<code>Bitmap</code>ç¼“å­˜ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> drawable: Drawable? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> mBuffer: Bitmap = Bitmap.createBitmap(<span class="number">1</span>, <span class="number">1</span>, Bitmap.Config.ARGB_8888)</span><br></pre></td></tr></tbody></table></figure>

<p>é¦–å…ˆï¼Œåœ¨æ¯æ¬¡ä¿®æ”¹<code>drawable</code>å˜é‡æ—¶ï¼ŒæŠŠåŸ<code>drawable</code>åœæ‰ï¼ŒæŠŠ<code>Bitmap</code>çš„å¤§å°è®¾ç½®æˆå’Œ<code>drawable</code>ä¸€æ ·å¤§ï¼Œå¹¶åŠ ä¸Š<code>Drawable.Callback</code>ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line">(<span class="keyword">this</span>.drawable <span class="keyword">as</span>? Animatable)?.stop()</span><br><span class="line"><span class="keyword">this</span>.drawable?.callback = <span class="literal">null</span></span><br><span class="line"><span class="keyword">this</span>.drawable = drawable</span><br><span class="line"><span class="keyword">this</span>.drawable?.callback = drawableCallback</span><br><span class="line">(drawable <span class="keyword">as</span>? Animatable)?.start()</span><br><span class="line">setBounds(<span class="number">0</span>, <span class="number">0</span>, drawable.intrinsicWidth, drawable.intrinsicHeight)</span><br><span class="line">        mBuffer = Bitmap.createBitmap(bounds.width(), bounds.height(), Bitmap.Config.ARGB_8888)</span><br><span class="line">updateBuffer()</span><br></pre></td></tr></tbody></table></figure>

<p><code>drawableCallback</code>è´Ÿè´£åœ¨<code>drawable</code>æ›´æ–°çš„æ—¶å€™åˆ·æ–°<code>Bitmap</code>ï¼Œå¹¶è°ƒç”¨å®¹å™¨çš„<code>invalidate</code>ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">updateBuffer</span><span class="params">()</span></span> {</span><br><span class="line">    <span class="keyword">val</span> bufferCanvas = Canvas(mBuffer)</span><br><span class="line">    bufferCanvas.drawColor(Color.TRANSPARENT, PorterDuff.Mode.CLEAR)</span><br><span class="line">    drawable?.draw(bufferCanvas)</span><br><span class="line">    invalidateSelf()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> drawableCallback = <span class="keyword">object</span> : Callback {</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">invalidateDrawable</span><span class="params">(who: <span class="type">Drawable</span>)</span></span> {</span><br><span class="line">        updateBuffer()</span><br><span class="line">        container.<span class="keyword">get</span>()?.invalidate()</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">scheduleDrawable</span><span class="params">(who: <span class="type">Drawable</span>, what: <span class="type">Runnable</span>, `<span class="keyword">when</span>`: <span class="type">Long</span>)</span></span> {</span><br><span class="line">        container.<span class="keyword">get</span>()?.postDelayed(what, `<span class="keyword">when</span>`)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">unscheduleDrawable</span><span class="params">(who: <span class="type">Drawable</span>, what: <span class="type">Runnable</span>)</span></span> {</span><br><span class="line">        container.<span class="keyword">get</span>()?.removeCallbacks(what)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æœ€ååœ¨<code>draw</code>é‡ŒæŠŠ<code>Bitmap</code>ç»˜åˆ¶å‡ºæ¥å°±å®Œæˆäº†ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> mPaint = Paint(Paint.FILTER_BITMAP_FLAG or Paint.DITHER_FLAG)</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">draw</span><span class="params">(canvas: <span class="type">Canvas</span>)</span></span> {</span><br><span class="line">    canvas.drawBitmap(mBuffer, bounds, bounds, mPaint)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><a href="https://github.com/ekibun/Bangumi/blob/master/app/src/main/java/soko/ekibun/bangumi/util/span/TextViewDrawable.kt" target="_blank" rel="noopener">å®Œæ•´ä»£ç ä¼ é€é—¨</a></p>
</body></html>]]></content>
      <tags>
        <tag>android</tag>
      </tags>
  </entry>
  <entry>
    <title>è·¨Itemæ–‡å­—é€‰æ‹©çš„RecyclerView</title>
    <url>/ekibook/2020/05/17/selectablerecyclerview/</url>
    <content><![CDATA[<html><head></head><body><p>åšä¸ªå°è¯´é˜…è¯»å™¨ï¼Œä¸ºäº†å’Œæ¼«ç”»å…¼å®¹ï¼Œæ”¾åœ¨åŒä¸€ä¸ª<code>RecyclerView</code>ä¸Šï¼Œæ”¯æŒæ»šåŠ¨å’Œç¿»é¡µä¸¤ç§å¸ƒå±€ï¼Œç›´æ¥ç»™<code>TextView</code>è®¾ç½®é€‰æ‹©ä¼šé˜»ç¢åˆ°<code>RecyclerView</code>çš„æ»šåŠ¨ï¼Œå¹¶ä¸”ä¸ºäº†ä¿æŒæ¸²æŸ“çš„æ•ˆç‡ï¼Œä¸èƒ½æŠŠä¸Šä¸‡å­—çš„æ–‡æœ¬å…¨æ”¾ä¸€ä¸ª<code>TextView</code>ä¸Šï¼Œé‚£ä¹ˆè·¨é¡µçš„é€‰æ‹©å°±æˆäº†ä¸ªé—®é¢˜ã€‚</p>
<a id="more"></a>

<p>è¿˜æ˜¯å…ˆæ”¾æ•ˆæœ</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2020/05/17/selectablerecyclerview/QQ%E8%A7%86%E9%A2%9120200516233858.gif" alt="QQè§†é¢‘20200516233858"></p>
<h4 id="æ–‡æœ¬åˆ†é¡µ"><a href="#æ–‡æœ¬åˆ†é¡µ" class="headerlink" title="æ–‡æœ¬åˆ†é¡µ"></a>æ–‡æœ¬åˆ†é¡µ</h4><p>æ‹†åˆ†æ–‡æœ¬æ”¾åœ¨äº†<code>adatper</code>é‡Œï¼Œæ·»åŠ æ•°æ®å’Œä¿®æ”¹å¸ƒå±€çš„æ—¶å€™è§¦å‘ï¼Œè®¡ç®—æ—¶ç”¨ä¸€ä¸ªå‚ç…§çš„<code>ViewHolder</code>é‡Œçš„<code>TextView</code>è¿›è¡Œå¸ƒå±€ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">wrapData</span><span class="params">(<span class="keyword">data</span>: <span class="type">List</span>&lt;<span class="type">BookProvider</span>.<span class="type">PageInfo</span>&gt;)</span></span>: List&lt;BookProvider.PageInfo&gt; {</span><br><span class="line">    <span class="keyword">val</span> ret = ArrayList&lt;BookProvider.PageInfo&gt;()</span><br><span class="line">    <span class="keyword">data</span>.forEach { page -&gt;</span><br><span class="line">        <span class="keyword">if</span> (page.content.isNullOrEmpty()) ret += page</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">val</span> pageWidth =</span><br><span class="line">                recyclerView.width - referHolder.itemView.content_container.let { it.paddingLeft + it.paddingRight }</span><br><span class="line">            <span class="keyword">val</span> layout = referHolder.itemView.item_content.let {</span><br><span class="line">                StaticLayout.Builder.obtain(page.content, <span class="number">0</span>, page.content.length, it.paint, pageWidth)</span><br><span class="line">                    .setAlignment(Layout.Alignment.ALIGN_NORMAL)</span><br><span class="line">                    .setLineSpacing(it.lineSpacingExtra, it.lineSpacingMultiplier)</span><br><span class="line">                    .setIncludePad(it.includeFontPadding)</span><br><span class="line">                    .setUseLineSpacingFromFallbacks(it.isFallbackLineSpacing)</span><br><span class="line">                    .setBreakStrategy(it.breakStrategy)</span><br><span class="line">                    .setHyphenationFrequency(it.hyphenationFrequency)</span><br><span class="line">                    .setJustificationMode(it.justificationMode)</span><br><span class="line">                    .build()</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">val</span> pageHeight =</span><br><span class="line">                recyclerView.height - referHolder.itemView.content_container.let { it.paddingTop + it.paddingBottom }</span><br><span class="line">            <span class="keyword">var</span> lastTextIndex = <span class="number">0</span></span><br><span class="line">            <span class="keyword">var</span> lastLineBottom = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">1</span> until layout.lineCount) {</span><br><span class="line">                <span class="keyword">val</span> curLineBottom = layout.getLineBottom(i)</span><br><span class="line">                <span class="keyword">if</span> (curLineBottom - lastLineBottom &lt; pageHeight) <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">val</span> prevLineEndIndex = layout.getLineVisibleEnd(i - <span class="number">1</span>)</span><br><span class="line">                ret += BookProvider.PageInfo(</span><br><span class="line">                    content = page.content.substring(lastTextIndex, prevLineEndIndex),</span><br><span class="line">                    ep = page.ep,</span><br><span class="line">                    rawInfo = page,</span><br><span class="line">                    rawRange = Pair(lastTextIndex, prevLineEndIndex)</span><br><span class="line">                )</span><br><span class="line">                lastTextIndex = layout.getLineStart(i)</span><br><span class="line">                lastLineBottom = layout.getLineTop(i)</span><br><span class="line">            }</span><br><span class="line">            ret += BookProvider.PageInfo(</span><br><span class="line">                content = page.content.substring(lastTextIndex),</span><br><span class="line">                ep = page.ep,</span><br><span class="line">                rawInfo = page,</span><br><span class="line">                rawRange = Pair(lastTextIndex, page.content.length)</span><br><span class="line">            )</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">var</span> lastEp: BookProvider.BookEpisode? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">var</span> lastIndex = <span class="number">0</span></span><br><span class="line">    ret.forEachIndexed { index, page -&gt;</span><br><span class="line">        <span class="keyword">if</span> (lastEp != page.ep) lastIndex = <span class="number">0</span></span><br><span class="line">        lastEp = page.ep</span><br><span class="line">        lastIndex += <span class="number">1</span></span><br><span class="line">        page.index = lastIndex</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="æ–‡æœ¬é€‰æ‹©"><a href="#æ–‡æœ¬é€‰æ‹©" class="headerlink" title="æ–‡æœ¬é€‰æ‹©"></a>æ–‡æœ¬é€‰æ‹©</h4><p>ä¸ºäº†ä¾¿äºæ‹¦æˆªè§¦æ‘¸äº‹ä»¶ï¼Œé‡å†™<code>RecyclerView</code>ï¼Œæ·»åŠ ä¸€ä¸ªé€‰æ‹©ä¸­çš„çŠ¶æ€ï¼Œä¸ºçœŸå°±æ‹¦æˆªè§¦æ‘¸äº‹ä»¶è¿›è¡Œé€‰æ‹©ï¼Œè¿™é‡ŒæŠ„äº†ä¸€ä¸ª<code>DragSelectTouchListener</code>çš„è½®å­ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@SuppressLint(<span class="meta-string">"ClickableViewAccessibility"</span>)</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTouchEvent</span><span class="params">(e: <span class="type">MotionEvent</span>)</span></span>: <span class="built_in">Boolean</span> {</span><br><span class="line">    <span class="keyword">if</span> (!isActive) <span class="keyword">return</span> <span class="keyword">super</span>.onTouchEvent(e)</span><br><span class="line">    <span class="keyword">when</span> (e.actionMasked) {</span><br><span class="line">        MotionEvent.ACTION_MOVE -&gt; {</span><br><span class="line">            <span class="keyword">if</span> ((layoutManager <span class="keyword">as</span>? BookLayoutManager)?.orientation != LinearLayoutManager.VERTICAL</span><br><span class="line">                || (!inTopSpot &amp;&amp; !inBottomSpot)) <span class="comment">//æ›´æ–°æ»‘åŠ¨é€‰æ‹©åŒºåŸŸ</span></span><br><span class="line">                updateSelectedRange(e.x, e.y)</span><br><span class="line">            <span class="comment">//åœ¨é¡¶éƒ¨æˆ–è€…åº•éƒ¨è§¦å‘è‡ªåŠ¨æ»‘åŠ¨</span></span><br><span class="line">            processAutoScroll(e)</span><br><span class="line">        }</span><br><span class="line">        MotionEvent.ACTION_CANCEL, MotionEvent.ACTION_UP, MotionEvent.ACTION_POINTER_UP -&gt; {</span><br><span class="line">            <span class="comment">//ç»“æŸæ»‘åŠ¨é€‰æ‹©ï¼Œåˆå§‹åŒ–å„çŠ¶æ€å€¼</span></span><br><span class="line">            reset()</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>é€‰åŒºçš„æ›´æ–°åœ¨<code>updateSelectedRange</code>é‡Œé¢å®ç°ï¼Œé€šè¿‡é•¿æŒ‰æ‰‹åŠ¿è§¦å‘<code>startSelect</code>å¼€å§‹é€‰æ‹©ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">startSelect</span><span class="params">(x: <span class="type">Float</span>, y: <span class="type">Float</span>)</span></span> {</span><br><span class="line">    clearSelect()</span><br><span class="line">    handleOffset = <span class="number">0</span></span><br><span class="line">    updateSelectedRange(x, y, <span class="literal">true</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">updateSelectedRange</span><span class="params">(x: <span class="type">Float</span>, y: <span class="type">Float</span>, isStart: <span class="type">Boolean</span> = <span class="literal">false</span>)</span></span> {</span><br><span class="line">    <span class="keyword">val</span> child = findChildViewUnder(x, y - handleOffset)?: <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">val</span> position = getChildAdapterPosition(child)</span><br><span class="line">    <span class="keyword">if</span> (position == NO_POSITION) <span class="keyword">return</span></span><br><span class="line">    selectEnd = bookAdapter.<span class="keyword">data</span>.getOrNull(position)?.let {</span><br><span class="line">        SelectItem(it, textSelectionAdapter.getPosFromPosition(child, x, y - handleOffset))</span><br><span class="line">    }?.also {</span><br><span class="line">        <span class="keyword">if</span>(!isStart) <span class="keyword">return</span><span class="symbol">@also</span></span><br><span class="line">        selectStart = it</span><br><span class="line">        isActive = <span class="literal">true</span></span><br><span class="line">    }</span><br><span class="line">    postInvalidate()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æä¸ªæ¥å£ï¼ŒæŠŠé€‰æ‹©äº‹ä»¶äº¤ç»™adapterå»å¤„ç†ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">TextSelectionAdapter</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">drawSelection</span><span class="params">(c: <span class="type">Canvas</span>, view: <span class="type">View</span>, start: <span class="type">Int</span>?, end: <span class="type">Int</span>?, paint: <span class="type">Paint</span>)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getPosFromPosition</span><span class="params">(view: <span class="type">View</span>, x: <span class="type">Float</span>, y: <span class="type">Float</span>)</span></span>: <span class="built_in">Int</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getHandlePosition</span><span class="params">(view: <span class="type">View</span>, offset: <span class="type">Int</span>)</span></span>: Point</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getTextHeight</span><span class="params">()</span></span>: <span class="built_in">Int</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getSelectionText</span><span class="params">(startIndex: <span class="type">Int</span>, endIndex: <span class="type">Int</span>, startPos: <span class="type">Int</span>, endPos: <span class="type">Int</span>)</span></span>: String</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ä¸ºäº†ä¿æŒstartåœ¨endå‰é¢ï¼Œå†™ä¸ªwrapperï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getSelectRange</span><span class="params">()</span></span>: Pair&lt;Pair&lt;<span class="built_in">Int</span>, SelectItem&gt;, Pair&lt;<span class="built_in">Int</span>, SelectItem&gt;&gt;? {</span><br><span class="line">    <span class="keyword">var</span> selectStart = selectStart?: <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    <span class="keyword">var</span> selectEnd = selectEnd?: <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    <span class="keyword">var</span> startIndex = bookAdapter.<span class="keyword">data</span>.indexOf(selectStart.item)</span><br><span class="line">    <span class="keyword">var</span> endIndex = bookAdapter.<span class="keyword">data</span>.indexOf(selectEnd.item)</span><br><span class="line">    <span class="keyword">if</span>(startIndex &gt; endIndex || (startIndex == endIndex &amp;&amp; selectStart.pos &gt; selectEnd.pos)) {</span><br><span class="line">        startIndex = endIndex.also { endIndex = startIndex }</span><br><span class="line">        selectStart = selectEnd.also { selectEnd = selectStart }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> (startIndex to selectStart) to (endIndex to selectEnd)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>é¦–å…ˆæ˜¯<code>getPosFromPosition</code>ï¼Œç”¨æ¥ä»è§¦æ‘¸ä½ç½®è·å–åˆ°å¯¹åº”itemå†…å®¹çš„ç›¸å¯¹ä½ç½®ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getPosFromPosition</span><span class="params">(view: <span class="type">View</span>, x: <span class="type">Float</span>, y: <span class="type">Float</span>)</span></span>: <span class="built_in">Int</span> {</span><br><span class="line">    <span class="keyword">if</span> (view.content_container.visibility != View.VISIBLE) <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">    view.item_content.getLocationInWindow(posContent)</span><br><span class="line">    <span class="keyword">return</span> view.item_content.getOffsetForPosition(x - posContent[<span class="number">0</span>] + recyclerView.x, y - posContent[<span class="number">1</span>] + recyclerView.y)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>é€‰åŒºçš„ç»˜åˆ¶æ”¾åœ¨<code>ItemDecoration.onDrawOver</code>é‡Œï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDrawOver</span><span class="params">(c: <span class="type">Canvas</span>, parent: <span class="type">RecyclerView</span>, state: <span class="type">State</span>)</span></span> {</span><br><span class="line">    <span class="keyword">super</span>.onDrawOver(c, parent, state)</span><br><span class="line">    <span class="keyword">val</span> (startPair, endPair) = getSelectRange()?: <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">val</span> (startIndex, selectStart) = startPair</span><br><span class="line">    <span class="keyword">val</span> (endIndex, selectEnd) = endPair</span><br><span class="line">    <span class="keyword">val</span> firstVisibleSelectPos = Math.max(startIndex, bookLayoutManager.findFirstVisibleItemPosition())</span><br><span class="line">    <span class="keyword">val</span> lastVisibleSelectPos = Math.min(endIndex, bookLayoutManager.findLastVisibleItemPosition())</span><br><span class="line">    <span class="keyword">for</span> (pos <span class="keyword">in</span> firstVisibleSelectPos..lastVisibleSelectPos) {</span><br><span class="line">        textSelectionAdapter.drawSelection(c, bookLayoutManager.findViewByPosition(pos)?:<span class="keyword">continue</span>,</span><br><span class="line">            <span class="keyword">if</span>(pos == startIndex) selectStart.pos <span class="keyword">else</span> <span class="literal">null</span>,</span><br><span class="line">            <span class="keyword">if</span>(pos == endIndex) selectEnd.pos <span class="keyword">else</span> <span class="literal">null</span>, paint)</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ç»˜åˆ¶ä¹Ÿè½¬å‘ç»™adapterå»å¤„ç†ï¼Œè¦æ³¨æ„çš„æ˜¯å¦‚æœè·¨è¶Šäº†ä¸¤ä¸ªItemï¼Œå…‰ç”¨<code>Layout.getSelectionPath</code>æœ€åä¸€è¡Œå¹¶ä¸ä¼šç”»æ»¡ä¸€æ•´è¡Œï¼Œéœ€è¦è¡¥å…¨ç©ºä½™ä½ç½®ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> path = Path()</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> posContent = IntArray(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawSelection</span><span class="params">(c: <span class="type">Canvas</span>, view: <span class="type">View</span>, start: <span class="type">Int</span>?, end: <span class="type">Int</span>?, paint: <span class="type">Paint</span>)</span></span> {</span><br><span class="line">    <span class="keyword">if</span> (view.content_container.visibility != View.VISIBLE) <span class="keyword">return</span></span><br><span class="line">    view.item_content.getLocationInWindow(posContent)</span><br><span class="line">    c.save()</span><br><span class="line">    c.translate(posContent[<span class="number">0</span>] - recyclerView.x, posContent[<span class="number">1</span>] - recyclerView.y)</span><br><span class="line">    drawSelectionImpl(c, view, start, end, paint)</span><br><span class="line"></span><br><span class="line">    c.restore()</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">drawSelectionImpl</span><span class="params">(c: <span class="type">Canvas</span>, view: <span class="type">View</span>, start: <span class="type">Int</span>?, end: <span class="type">Int</span>?, paint: <span class="type">Paint</span>)</span></span> {</span><br><span class="line">    <span class="keyword">if</span>(start == <span class="literal">null</span> &amp;&amp; end == <span class="literal">null</span>){</span><br><span class="line">        c.drawRect(Rect(<span class="number">0</span>, <span class="number">0</span>, view.item_content.width, view.item_content.height), paint)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">val</span> layout = view.item_content.layout?: <span class="keyword">return</span></span><br><span class="line">    layout.getSelectionPath(start?:<span class="number">0</span>, end?:view.item_content.text.length, path)</span><br><span class="line">    <span class="keyword">if</span>(end == <span class="literal">null</span>){</span><br><span class="line">        <span class="keyword">val</span> startLine = layout.getLineForOffset(start?: <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">val</span> endLine = layout.getLineForOffset(end?: view.item_content.text.length)</span><br><span class="line">        path.addRect(<span class="keyword">if</span>(startLine == endLine) layout.getPrimaryHorizontal(start?: <span class="number">0</span>) <span class="keyword">else</span> layout.getLineLeft(endLine),</span><br><span class="line">            layout.getLineTop(endLine).toFloat(),</span><br><span class="line">            layout.getLineLeft(endLine) + layout.width,</span><br><span class="line">            view.item_content.height.toFloat(), Path.Direction.CW)</span><br><span class="line">    }</span><br><span class="line">    c.drawPath(path, paint)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æ¥ä¸‹æ¥ç»˜åˆ¶å·¦å³ä¸¤è¾¹çš„æ‹–åŠ¨æŒ‰é’®ï¼Œåœ¨<code>onDrawOver</code>ä¸‹é¢åŠ ä¸Šï¼Œå°ç±³çš„ä¸¤ä¸ª<code>Drawable</code>å¹¶ä¸æ˜¯æ­£æ–¹å½¢ï¼Œä¸çŸ¥é“å…¶ä»–çš„ç³»ç»Ÿæ˜¯ä¸æ˜¯ä¸€æ ·çš„ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> selectionHandleLeft = ResourceUtil.resolveDrawableAttr(context, android.R.attr.textSelectHandleLeft)?.also {</span><br><span class="line">    <span class="keyword">val</span> delta = (it.intrinsicWidth - it.intrinsicHeight) / <span class="number">2</span></span><br><span class="line">    it.setBounds(-it.intrinsicWidth + delta, <span class="number">0</span>, delta,  it.intrinsicHeight)</span><br><span class="line">}</span><br><span class="line"><span class="keyword">val</span> selectionHandleRight = ResourceUtil.resolveDrawableAttr(context, android.R.attr.textSelectHandleRight)?.also {</span><br><span class="line">    <span class="keyword">val</span> delta = (it.intrinsicWidth - it.intrinsicHeight) / <span class="number">2</span></span><br><span class="line">    it.setBounds(- delta, <span class="number">0</span>, it.intrinsicWidth - delta,  it.intrinsicHeight)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">bookLayoutManager.findViewByPosition(startIndex)?.let {</span><br><span class="line">    <span class="keyword">val</span> pos = textSelectionAdapter.getHandlePosition(it, selectStart.pos)</span><br><span class="line">    c.save()</span><br><span class="line">    c.translate(pos.x.toFloat(), pos.y.toFloat())</span><br><span class="line">    selectionHandleLeft?.draw(c)</span><br><span class="line">    c.restore()</span><br><span class="line">}</span><br><span class="line">bookLayoutManager.findViewByPosition(endIndex)?.let {</span><br><span class="line">    <span class="keyword">val</span> pos = textSelectionAdapter.getHandlePosition(it, selectEnd.pos)</span><br><span class="line">    c.save()</span><br><span class="line">    c.translate(pos.x.toFloat(), pos.y.toFloat())</span><br><span class="line">    selectionHandleRight?.draw(c)</span><br><span class="line">    c.restore()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>getHandlePosition</code>è¿”å›å¯¹åº”æ–‡å­—ä½ç½®çš„åæ ‡ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> point = Point()</span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getHandlePosition</span><span class="params">(view: <span class="type">View</span>, offset: <span class="type">Int</span>)</span></span>: Point {</span><br><span class="line">    <span class="keyword">if</span> (view.content_container.visibility != View.VISIBLE) <span class="keyword">return</span> point.also { it.<span class="keyword">set</span>(-<span class="number">1000</span>, -<span class="number">1000</span>) }</span><br><span class="line">    <span class="keyword">val</span> layout = view.item_content.layout?: <span class="keyword">return</span> point.also { it.<span class="keyword">set</span>(-<span class="number">1000</span>, -<span class="number">1000</span>) }</span><br><span class="line">    view.item_content.getLocationInWindow(posContent)</span><br><span class="line">    <span class="keyword">return</span> point.also { it.<span class="keyword">set</span>(</span><br><span class="line">        (layout.getPrimaryHorizontal(offset) + posContent[<span class="number">0</span>] - recyclerView.x).toInt(),</span><br><span class="line">        (layout.getLineBottom(layout.getLineForOffset(offset)) - view.item_content.lineSpacingExtra + posContent[<span class="number">1</span>] - recyclerView.y).toInt()) }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>ä¸¤ä¸ªæŒ‰é’®è¦èƒ½ç‚¹å‡»ï¼Œåœ¨<code>onTouchEvent</code>ä¸­è¡¥ä¸Šï¼Œå¦‚æœæŒ‰ä¸‹çš„ä½ç½®åœ¨æŒ‰é’®èŒƒå›´å†…ï¼Œå°±æŠŠçŠ¶æ€è®¾ä¸ºçœŸï¼Œå¹¶ä¸”æŠŠæŒ‰ä¸‹çš„ä½ç½®è®¾ä¸ºendï¼Œå¦ä¸€ä¸ªæ˜¯startï¼Œåšä¸ºé”šç‚¹ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> handleOffset = <span class="number">0</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">checkTouchHandle</span><span class="params">(e: <span class="type">MotionEvent</span>)</span></span>: <span class="built_in">Boolean</span> {</span><br><span class="line">    <span class="keyword">val</span> (startPair, endPair) = getSelectRange()?: <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">val</span> (startIndex, selectStart) = startPair</span><br><span class="line">    <span class="keyword">val</span> (endIndex, selectEnd) = endPair</span><br><span class="line">    <span class="keyword">val</span> textHeight = textSelectionAdapter.getTextHeight()</span><br><span class="line">    bookLayoutManager.findViewByPosition(startIndex)?.let {</span><br><span class="line">        <span class="keyword">val</span> bounds = selectionHandleLeft?.bounds?: <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        <span class="keyword">val</span> pos = textSelectionAdapter.getHandlePosition(it, selectStart.pos)</span><br><span class="line">        <span class="keyword">if</span> (Rect(pos.x + bounds.left,</span><br><span class="line">                 pos.y  + bounds.top - textHeight,</span><br><span class="line">                 pos.x + bounds.right,</span><br><span class="line">                 pos.y + bounds.bottom + bounds.height() / <span class="number">2</span></span><br><span class="line">                ).contains(e.x.toInt(), e.y.toInt())) {</span><br><span class="line">            <span class="keyword">this</span>.selectStart = selectEnd</span><br><span class="line">            <span class="keyword">this</span>.selectEnd = selectStart</span><br><span class="line">            handleOffset = (e.y - pos.y).roundToInt() + textHeight / <span class="number">2</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    bookLayoutManager.findViewByPosition(endIndex)?.let {</span><br><span class="line">        <span class="keyword">val</span> bounds = selectionHandleRight?.bounds?: <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        <span class="keyword">val</span> pos = textSelectionAdapter.getHandlePosition(it, selectEnd.pos)</span><br><span class="line">        <span class="keyword">if</span> (Rect(pos.x + bounds.left,</span><br><span class="line">                 pos.y  + bounds.top - textHeight,</span><br><span class="line">                 pos.x + bounds.right,</span><br><span class="line">                 pos.y + bounds.bottom + bounds.height() / <span class="number">2</span></span><br><span class="line">                ).contains(e.x.toInt(), e.y.toInt())) {</span><br><span class="line">            <span class="keyword">this</span>.selectStart = selectStart</span><br><span class="line">            <span class="keyword">this</span>.selectEnd = selectEnd</span><br><span class="line">            handleOffset = (e.y - pos.y).roundToInt() + textHeight / <span class="number">2</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTouchEvent</span><span class="params">(e: <span class="type">MotionEvent</span>)</span></span>: <span class="built_in">Boolean</span> {</span><br><span class="line">    <span class="keyword">if</span> (!isActive &amp;&amp; e.actionMasked == MotionEvent.ACTION_DOWN) {</span><br><span class="line">        isActive = checkTouchHandle(e)</span><br><span class="line">        hideActionMode()</span><br><span class="line">    }</span><br><span class="line">    (...)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="äº¤äº’èœå•"><a href="#äº¤äº’èœå•" class="headerlink" title="äº¤äº’èœå•"></a>äº¤äº’èœå•</h4><p>å…ˆåšä¸ªå¤åˆ¶å’Œåˆ†äº«çš„ï¼Œè¿™æ ·æ˜¾ç¤ºå‡ºæ¥å¹¶ä¸æ˜¯å°ç±³è€Œæ˜¯åŸç”Ÿçš„æ ·å¼ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@RequiresApi(Build.VERSION_CODES.M)</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectableActionMode</span>: <span class="type">ActionMode.Callback2</span></span>() {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateActionMode</span><span class="params">(mode: <span class="type">ActionMode</span>, menu: <span class="type">Menu</span>)</span></span>: <span class="built_in">Boolean</span> {</span><br><span class="line">        mode.title = <span class="literal">null</span></span><br><span class="line">        mode.subtitle = <span class="literal">null</span></span><br><span class="line">        mode.titleOptionalHint = <span class="literal">true</span></span><br><span class="line">        populateMenuWithItems(menu)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">populateMenuWithItems</span><span class="params">(menu: <span class="type">Menu</span>)</span></span> {</span><br><span class="line">        menu.add(</span><br><span class="line">            Menu.NONE, ID_COPY, MENU_ITEM_ORDER_COPY,</span><br><span class="line">            <span class="string">"å¤åˆ¶"</span></span><br><span class="line">        ).setAlphabeticShortcut(<span class="string">'c'</span>).setShowAsAction(MenuItem.SHOW_AS_ACTION_ALWAYS)</span><br><span class="line">        menu.add(</span><br><span class="line">            Menu.NONE, ID_SHARE, MENU_ITEM_ORDER_SHARE,</span><br><span class="line">            <span class="string">"åˆ†äº«"</span></span><br><span class="line">        ).setShowAsAction(MenuItem.SHOW_AS_ACTION_IF_ROOM)</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onPrepareActionMode</span><span class="params">(mode: <span class="type">ActionMode</span>?, menu: <span class="type">Menu</span>?)</span></span>: <span class="built_in">Boolean</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroyActionMode</span><span class="params">(mode: <span class="type">ActionMode</span>?)</span></span> {</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> {</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">val</span> ID_COPY = android.R.id.copy</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">val</span> ID_SHARE = android.R.id.shareText</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> MENU_ITEM_ORDER_COPY = <span class="number">5</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> MENU_ITEM_ORDER_SHARE = <span class="number">7</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>åœ¨<code>RecyclerView</code>é‡Œå®ä¾‹åŒ–</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> actionModeCallback = <span class="keyword">object</span>: SelectableActionMode() {</span><br><span class="line">    <span class="keyword">val</span> clipboardManager <span class="keyword">by</span> lazy { context.getSystemService(Context.CLIPBOARD_SERVICE) <span class="keyword">as</span> ClipboardManager }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActionItemClicked</span><span class="params">(mode: <span class="type">ActionMode</span>, item: <span class="type">MenuItem</span>)</span></span>: <span class="built_in">Boolean</span> {</span><br><span class="line">        <span class="keyword">val</span> (startPair, endPair) = getSelectRange()?: <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        <span class="keyword">val</span> (startIndex, selectStart) = startPair</span><br><span class="line">        <span class="keyword">val</span> (endIndex, selectEnd) = endPair</span><br><span class="line">        <span class="keyword">val</span> str = (adapter <span class="keyword">as</span>? TextSelectionAdapter)?.getSelectionText(startIndex, endIndex, selectStart.pos, selectEnd.pos)?: <span class="string">""</span></span><br><span class="line">        <span class="keyword">when</span>(item.itemId) {</span><br><span class="line">            ID_COPY -&gt; {</span><br><span class="line">                clipboardManager.setPrimaryClip(ClipData.newPlainText(<span class="string">"novel_content"</span>, str))</span><br><span class="line">                Toast.makeText(App.app.host, <span class="string">"å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"</span>, Toast.LENGTH_LONG).show()</span><br><span class="line">            }</span><br><span class="line">            ID_SHARE -&gt; AppUtil.shareString(context, str)</span><br><span class="line">        }</span><br><span class="line">        hideActionMode()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onGetContentRect</span><span class="params">(mode: <span class="type">ActionMode</span>?, view: <span class="type">View</span>?, outRect: <span class="type">Rect</span>)</span></span> {</span><br><span class="line">        <span class="keyword">super</span>.onGetContentRect(mode, view, outRect)</span><br><span class="line">        <span class="keyword">val</span> (startPair, endPair) = getSelectRange()?: <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">val</span> (startIndex, selectStart) = startPair</span><br><span class="line">        <span class="keyword">val</span> (endIndex, selectEnd) = endPair</span><br><span class="line">        <span class="keyword">val</span> firstVisibleSelectPos = Math.max(startIndex, bookLayoutManager.findFirstVisibleItemPosition())</span><br><span class="line">        <span class="keyword">val</span> lastVisibleSelectPos = Math.min(endIndex, bookLayoutManager.findLastVisibleItemPosition())</span><br><span class="line">        <span class="keyword">var</span> left = -<span class="number">1</span></span><br><span class="line">        <span class="keyword">var</span> right = -<span class="number">1</span></span><br><span class="line">        <span class="keyword">val</span> textHeight = textSelectionAdapter.getTextHeight()</span><br><span class="line">        <span class="keyword">val</span> top = <span class="keyword">when</span> {</span><br><span class="line">            startIndex &lt; firstVisibleSelectPos -&gt; <span class="number">0</span></span><br><span class="line">            startIndex &gt; lastVisibleSelectPos -&gt; <span class="keyword">this</span><span class="symbol">@SelectableRecyclerView</span>.height</span><br><span class="line">            <span class="keyword">else</span> -&gt; bookLayoutManager.findViewByPosition(startIndex)?.let {</span><br><span class="line">                <span class="keyword">val</span> p = textSelectionAdapter.getHandlePosition(it, selectStart.pos)</span><br><span class="line">                left = p.x</span><br><span class="line">                p.y - textHeight</span><br><span class="line">            }?: <span class="number">0</span></span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">val</span> bottom = <span class="keyword">when</span> {</span><br><span class="line">            endIndex &lt; firstVisibleSelectPos -&gt; <span class="number">0</span></span><br><span class="line">            endIndex &gt; lastVisibleSelectPos -&gt; <span class="keyword">this</span><span class="symbol">@SelectableRecyclerView</span>.height</span><br><span class="line">            <span class="keyword">else</span> -&gt; bookLayoutManager.findViewByPosition(endIndex)?.let {</span><br><span class="line">                <span class="keyword">val</span> p = textSelectionAdapter.getHandlePosition(it, selectEnd.pos)</span><br><span class="line">                right = <span class="keyword">if</span>(p.x &lt; <span class="number">0</span>) <span class="keyword">this</span><span class="symbol">@SelectableRecyclerView</span>.width <span class="keyword">else</span> p.x</span><br><span class="line">                bookLayoutManager.getDecoratedTop(it).coerceAtLeast(p.y)</span><br><span class="line">            }?: <span class="number">0</span></span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span>(left &gt; <span class="number">0</span> &amp;&amp; right &gt; <span class="number">0</span> &amp;&amp; top + textHeight == bottom) {</span><br><span class="line">            outRect.<span class="keyword">set</span>(left, top, right, bottom)</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            outRect.<span class="keyword">set</span>(<span class="number">0</span>, top, <span class="keyword">this</span><span class="symbol">@SelectableRecyclerView</span>.width, bottom)</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><code>getSelectionText</code>è¿”å›é€‰æ‹©çš„æ–‡æœ¬ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getSelectionText</span><span class="params">(startIndex: <span class="type">Int</span>, endIndex: <span class="type">Int</span>, startPos: <span class="type">Int</span>, endPos: <span class="type">Int</span>)</span></span>: String {</span><br><span class="line">    <span class="keyword">val</span> str = StringBuilder()</span><br><span class="line">    <span class="keyword">var</span> lastRaw: BookProvider.PageInfo? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">var</span> lastStart = <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> lastEnd = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span>(i <span class="keyword">in</span> startIndex..endIndex) {</span><br><span class="line">        <span class="keyword">val</span> item = <span class="keyword">data</span>.getOrNull(i)?: <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span>(lastRaw != item.rawInfo) {</span><br><span class="line">            <span class="keyword">if</span>(lastRaw != <span class="literal">null</span>) str.append(lastRaw.content?.substring(lastStart, lastEnd) + <span class="string">'\n'</span>)</span><br><span class="line">            lastRaw = item.rawInfo</span><br><span class="line">            lastStart = (item.rawRange?.first?:<span class="number">0</span>) + (<span class="keyword">if</span>(i == startIndex) startPos <span class="keyword">else</span> <span class="number">0</span>)</span><br><span class="line">        }</span><br><span class="line">        lastEnd = (item.rawRange?.first?:<span class="number">0</span>) + (<span class="keyword">if</span>(i == endIndex) endPos <span class="keyword">else</span> <span class="number">0</span>)</span><br><span class="line">    }</span><br><span class="line">    str.append(lastRaw?.content?.substring(lastStart, lastEnd))</span><br><span class="line">    <span class="keyword">return</span> str.toString()</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>æœ€åæ˜¯åœ¨<code>onTouchEvent</code>ä¸­è§¦å‘æ˜¾ç¤ºå’Œéšè—ï¼Œæ»šåŠ¨æ—¶ä¹Ÿéšè—ï¼š</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">showActionMode</span><span class="params">()</span></span> {</span><br><span class="line">    actionMode = startActionMode(actionModeCallback, ActionMode.TYPE_FLOATING)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">hideActionMode</span><span class="params">()</span></span> {</span><br><span class="line">    actionMode?.finish()</span><br><span class="line">    actionMode = <span class="literal">null</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTouchEvent</span><span class="params">(e: <span class="type">MotionEvent</span>)</span></span>: <span class="built_in">Boolean</span> {</span><br><span class="line">    <span class="keyword">if</span> (!isActive &amp;&amp; e.actionMasked == MotionEvent.ACTION_DOWN) {</span><br><span class="line">        isActive = checkTouchHandle(e)</span><br><span class="line">        hideActionMode()</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (!isActive) <span class="keyword">return</span> <span class="keyword">super</span>.onTouchEvent(e)</span><br><span class="line">    <span class="keyword">when</span> (e.actionMasked) {</span><br><span class="line">        (...)</span><br><span class="line">        MotionEvent.ACTION_CANCEL, MotionEvent.ACTION_UP, MotionEvent.ACTION_POINTER_UP -&gt; {</span><br><span class="line">            <span class="comment">//ç»“æŸæ»‘åŠ¨é€‰æ‹©ï¼Œåˆå§‹åŒ–å„çŠ¶æ€å€¼</span></span><br><span class="line">            reset()</span><br><span class="line">            showActionMode()</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">init</span> {</span><br><span class="line">    addOnScrollListener(<span class="keyword">object</span> : RecyclerView.OnScrollListener() {</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onScrollStateChanged</span><span class="params">(recyclerView: <span class="type">RecyclerView</span>, newState: <span class="type">Int</span>)</span></span> {</span><br><span class="line">            <span class="keyword">if</span> (newState == SCROLL_STATE_IDLE &amp;&amp; selectStart != <span class="literal">null</span>) {</span><br><span class="line">                showActionMode()</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                hideActionMode()</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.onScrollStateChanged(recyclerView, newState)</span><br><span class="line">        }</span><br><span class="line">    })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><a href="https://github.com/ekibun/BangumiPlugin/tree/master/app/src/main/java/soko/ekibun/bangumi/plugins/ui/view/SelectableRecyclerView.kt" target="_blank" rel="noopener">å®Œæ•´ä»£ç ä¼ é€é—¨</a></p>
</body></html>]]></content>
      <tags>
        <tag>android</tag>
      </tags>
  </entry>
  <entry>
    <title>Wordæ’ç‰ˆç¬”è®°</title>
    <url>/ekibook/2021/05/13/word-eqn/</url>
    <content><![CDATA[<html><head></head><body><p>æŠ˜è…¾æ¯•ä¸šè®ºæ–‡ï¼ŒWordçš„æ’ç‰ˆå’Œè‡ªåŠ¨ç¼–å·æ¯”è¾ƒå¥‡ç‰¹ï¼Œæµªè´¹äº†å¾ˆå¤šæ—¶é—´ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹æ‘¸ç´¢çš„è¿‡ç¨‹ã€‚</p>
<a id="more"></a>

<h3 id="å›¾ç‰‡æˆªæ®µ"><a href="#å›¾ç‰‡æˆªæ®µ" class="headerlink" title="å›¾ç‰‡æˆªæ®µ"></a>å›¾ç‰‡æˆªæ®µ</h3><p>è®ºæ–‡é‡Œæœ‰ä¸€å †å¤§å›¾ï¼Œä¸ºäº†æ’ç‰ˆå¥½çœ‹éœ€è¦å°†å›¾ç‰‡éƒ½å¯¹é½åˆ°æ¯é¡µçš„é¡¶éƒ¨ï¼Œç„¶ååœ¨ä¸‹æ–¹ç»§ç»­ï¼Œè¿™æ—¶å›¾ç‰‡å°±ä¼šå°†æ®µè½åˆ†æˆä¸¤åŠï¼Œå¯ä»¥å°†å›¾ç‰‡è®¾ä¸º<strong>ä¸Šä¸‹å‹ç¯ç»•</strong>æŠŠæ–‡å­—æŒ¤ä¸‹å»ï¼š</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2021/05/13/word-eqn/ImageInParagraph.png" alt="ImageInParagraph"></p>
<p>æ‘¸ç´¢çš„æ—¶å€™å‘ç°å›¾ç‰‡æ€»éšç€é”šç‚¹ä¹±è·‘ï¼Œå½“å¤§æ®µå¤§æ®µåˆ é™¤çš„æ—¶å€™è¿˜ä¼šä½¿å¾—è¿ç»­ä¸¤é¡µçš„å›¾ç‰‡è·‘åˆ°ä¸€èµ·ï¼Œéœ€è¦æŠŠæ–‡æœ¬æ¡†çš„<strong>å…è®¸é‡å </strong>å’Œ<strong>éšæ–‡å­—ç§»åŠ¨</strong>çš„å‹¾å»æ‰ï¼š</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2021/05/13/word-eqn/ImageLayout.png" alt="ImageLayout"></p>
<p>ä»¥å‰æ’å›¾åçš„æ—¶å€™æ˜¯ç”¨çš„å¤šçº§åˆ—è¡¨ï¼Œä½†æ˜¯å¤šçº§åˆ—è¡¨æ²¡æ³•ç»™æ–‡æœ¬æ¡†ç¼–å·ï¼Œéœ€è¦æ”¹æˆ<strong>é¢˜æ³¨</strong>ã€‚é‡‡ç”¨é¢˜æ³¨è¿˜æœ‰ä¸€ä¸ªå¥½å¤„æ˜¯å¯ä»¥ç›´æ¥ç”Ÿæˆå›¾è¡¨ç›®å½•ï¼š</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2021/05/13/word-eqn/FigureContents.png" alt="FigureContents"></p>
<p>æ³¨ï¼š<strong>ä¸Šä¸‹å‹ç¯ç»•</strong>çš„æ ¼å¼æ— æ³•å æ»¡ä¸€æ•´é¡µï¼Œè‡³å°‘ä¼šæœ‰ä¸€è¡Œæ–‡å­—ï¼Œä¸çŸ¥é“æ€ä¹ˆè§£å†³ï¼Œä»¥åå†ç ”ç©¶äº†â€¦</p>
<h3 id="å…¬å¼ç¼–å·"><a href="#å…¬å¼ç¼–å·" class="headerlink" title="å…¬å¼ç¼–å·"></a>å…¬å¼ç¼–å·</h3><p>è‡ªword2016ä»¥æ¥ï¼Œè‡ªå¸¦çš„å…¬å¼ç¼–è¾‘å™¨ç»ˆäºå¯ä»¥ç”¨<code>#</code>åˆ›å»ºä¸€ä¸ªå³å¯¹é½çš„ç¼–å·ä½ï¼š</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2021/05/13/word-eqn/EqnSharp.png" alt="EqnSharp"></p>
<p>ä½†æ˜¯åœ¨<strong>å…¬å¼é‡Œä¸èƒ½æ’å…¥é¢˜æ³¨</strong>ï¼Œéœ€è¦<strong>å…ˆæ’å…¥é¢˜æ³¨</strong>ï¼Œå†ç”¨<code>Alt+=</code>æŠŠé¢˜æ³¨å¥—æˆå…¬å¼ï¼š</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2021/05/13/word-eqn/EqnSeq.png" alt="EqnSeq"></p>
<p>ä½†æ˜¯è¿™ç§æ–¹æ³•åœ¨äº¤å‰å¼•ç”¨çš„æ—¶å€™<strong>ä¸èƒ½ç›´æ¥é€‰æ‹©é¢˜æ³¨</strong>ï¼Œå¦åˆ™ä¼šæŠŠæ•´ä¸ªå…¬å¼å…¨å¼•ç”¨è¿‡å»ã€‚è¦åªæ˜¾ç¤ºå…¬å¼ç¼–å·ï¼Œå¯ä»¥å…ˆé€‰ä¸­ç¼–å·æ’å…¥ä¹¦ç­¾ï¼š</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2021/05/13/word-eqn/EqnBookMark.png" alt="EqnBookMark"></p>
<p>ç„¶ååœ¨äº¤å‰å¼•ç”¨ä¸­é€‰æ‹©å¯¹åº”çš„ä¹¦ç­¾ï¼š</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2021/05/13/word-eqn/EqnRef.png" alt="EqnRef"></p>
<h3 id="å…¬å¼å­—ä½“"><a href="#å…¬å¼å­—ä½“" class="headerlink" title="å…¬å¼å­—ä½“"></a>å…¬å¼å­—ä½“</h3><p>wordè‡ªå¸¦çš„å…¬å¼å­—ä½“å…¨æ˜¯<code>Cambria Math</code>ï¼Œè¦æ”¹å˜å­—ä½“éœ€è¦å…ˆæŠŠå…¬å¼å˜æˆæ–‡æœ¬å†é€‰æ‹©å­—ä½“ï¼Œå¯¹äºæœ‰ç¼–å·çš„å…¬å¼ï¼Œå…¨é€‰è½¬æˆæ–‡å­—ä¼šæŠŠç¼–å·å³å¯¹é½çš„<code>#</code>ä¹Ÿå˜æˆæ–‡æœ¬ï¼š</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2021/05/13/word-eqn/EqnTextAll.png" alt="EqnTextAll"></p>
<p>è¦åªé€‰æ‹©å…¬å¼çš„é‚£ä¸€éƒ¨åˆ†ï¼Œå•ç‹¬æ”¹æˆæ–‡æœ¬æ ¼å¼ï¼š</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/ekibun/ekibook@gh-pages/2021/05/13/word-eqn/EqnTextEqn.png" alt="EqnTextEqn"></p>
<p>çœŸæ˜¯é˜´é—´çš„è®¾è®¡å•Šâ€¦</p>
</body></html>]]></content>
      <tags>
        <tag>word</tag>
      </tags>
  </entry>
</search>
